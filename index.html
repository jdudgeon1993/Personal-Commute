<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commute Dashboard ‚Äî Drive & N Line</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f3f6fb;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#4f46e5;
  --success:#10b981;
  --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
}
body.force-dark{
  --bg:#0f1724;
  --card:#111827;
  --muted:#9ca3af;
  --accent:#7c89ff;
  --success:#34d399;
  --shadow: 0 12px 28px rgba(2,6,23,0.6);
  color:#f3f6fb;
}

html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:#0f1724; display:flex; justify-content:center; padding:20px;}
.app{width:100%; max-width:900px;}
header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px;}
h1{margin:0; font-size:22px; font-weight:800; letter-spacing:-0.4px;}
.controls{display:flex; gap:8px; align-items:center;}
.btn{padding:8px 12px; border-radius:10px; border:none; font-weight:600; cursor:pointer; background:var(--accent); color:white; box-shadow: var(--shadow);}
.btn.ghost{background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.06);}
.grid{display:grid; grid-template-columns: 1fr; gap:14px;}
@media(min-width:900px){.grid{ grid-template-columns: 1fr 1fr; }}
.card{background:var(--card); border-radius:14px; padding:16px; box-shadow: var(--shadow); display:flex; flex-direction:column; gap:12px;}
.card .top-row{display:flex; gap:12px; align-items:center;}
.card .left{width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; flex-shrink:0;}
.card h3{ margin:0; font-size:16px; }
.muted{ color:var(--muted); font-size:13px; margin-top:4px; }
.big{ font-weight:700; font-size:18px; margin-top:6px; }
.icon-weather{ background:linear-gradient(135deg,#ffd166,#ff9a66); color:#1f2937; }
.icon-drive{ background:linear-gradient(135deg,#60a5fa,#4f46e5); }
.icon-transit{ background:linear-gradient(135deg,#34d399,#10b981); color:#052e16; }
.small-note{ font-size:12px; color:var(--muted); margin-top:4px; }
.status-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.pill{ padding:6px 10px; border-radius:999px; font-weight:600; background:rgba(0,0,0,0.04); color:var(--muted); font-size:13px; }
footer{ margin-top:12px; color:var(--muted); font-size:13px; text-align:center; }
.map-container{height:140px; border-radius:12px; overflow:hidden; margin-top:8px; }
.radio-group{display:flex; gap:12px; margin-top:6px;}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Commute Dashboard</h1>
      <div class="small-note" id="dayTime">Loading‚Ä¶</div>
    </div>
    <div class="controls">
      <button class="btn" id="refreshBtn">‚ü≥ Refresh</button>
      <button class="btn ghost" id="themeToggle">Toggle Theme</button>
    </div>
  </header>
  <main class="grid">
    <!-- WEATHER -->
    <section class="card" id="weatherCard">
      <div class="top-row">
        <div class="left icon-weather" id="weatherIcon">‚òÄÔ∏è</div>
        <div style="flex:1">
          <h3>Weather ‚Äî Denver</h3>
          <div class="big" id="weatherTemp">Loading‚Ä¶</div>
          <div class="muted" id="weatherDesc"></div>
        </div>
      </div>
      <div class="status-row">
        <div class="pill" id="weatherFeels">‚Äî</div>
        <div class="pill" id="weatherWind">‚Äî</div>
        <div class="pill" id="weatherHumidity">‚Äî</div>
      </div>
    </section>

    <!-- DRIVE TO WORK -->
    <section class="card">
      <div class="top-row">
        <div class="left icon-drive">üöó</div>
        <div style="flex:1">
          <h3>Drive ‚Üí Work</h3>
          <div class="muted">Home ‚Üí Work</div>
          <div class="big" id="driveToWork">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="radio-group">
        <label><input type="radio" name="driveToWorkOpt" value="false" checked> Use Highways</label>
        <label><input type="radio" name="driveToWorkOpt" value="true"> Avoid Highways</label>
      </div>
      <div class="map-container" id="mapToWork"></div>
    </section>

    <!-- DRIVE HOME -->
    <section class="card">
      <div class="top-row">
        <div class="left icon-drive">üè†</div>
        <div style="flex:1">
          <h3>Drive ‚Üí Home</h3>
          <div class="muted">Work ‚Üí Home</div>
          <div class="big" id="driveToHome">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="radio-group">
        <label><input type="radio" name="driveToHomeOpt" value="false" checked> Use Highways</label>
        <label><input type="radio" name="driveToHomeOpt" value="true"> Avoid Highways</label>
      </div>
      <div class="map-container" id="mapToHome"></div>
    </section>

    <!-- TRANSIT TO WORK -->
    <section class="card">
      <div class="top-row">
        <div class="left icon-transit">üöÜ</div>
        <div style="flex:1">
          <h3>N Line ‚Üí Union Station</h3>
          <div class="muted">Northglenn & 112th ‚Üí Union Station</div>
          <div class="big" id="trainToWork">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="status-row" id="trainToWorkCountdown"></div>
    </section>

    <!-- TRANSIT HOME -->
    <section class="card">
      <div class="top-row">
        <div class="left icon-transit">‚Ü©Ô∏è</div>
        <div style="flex:1">
          <h3>N Line ‚Üí Northglenn</h3>
          <div class="muted">Union Station ‚Üí Northglenn & 112th</div>
          <div class="big" id="trainToHome">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="status-row" id="trainToHomeCountdown"></div>
    </section>
  </main>
  <footer>Auto-refresh every 3 minutes ‚Ä¢ Click refresh anytime</footer>
</div>

<script>
const OPENWEATHER_API_KEY = '1c91f81f2adfd1b633d19842869a1a11';
const GOOGLE_MAPS_API_KEY = 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY';

// Preset locations
const HOME = '11625 Community Center Drive, Northglenn, CO 80233';
const WORK = '707 17th Street, Denver, CO 80202';
const N_ORIGIN = 'Northglenn & 112th Station, Northglenn, CO';
const N_DEST = 'Denver Union Station, Denver, CO';

// Elements
const weatherTempEl = document.getElementById('weatherTemp');
const weatherDescEl = document.getElementById('weatherDesc');
const weatherIconEl = document.getElementById('weatherIcon');
const weatherFeelsEl = document.getElementById('weatherFeels');
const weatherWindEl = document.getElementById('weatherWind');
const weatherHumidityEl = document.getElementById('weatherHumidity');

const driveToWorkEl = document.getElementById('driveToWork');
const driveToHomeEl = document.getElementById('driveToHome');

const trainToWorkEl = document.getElementById('trainToWork');
const trainToHomeEl = document.getElementById('trainToHome');
const trainToWorkCountdownEl = document.getElementById('trainToWorkCountdown');
const trainToHomeCountdownEl = document.getElementById('trainToHomeCountdown');

const mapToWorkEl = document.getElementById('mapToWork');
const mapToHomeEl = document.getElementById('mapToHome');

const dayTimeEl = document.getElementById('dayTime');

let directionsService = null;
let distanceMatrixService = null;
let driveRenderers = {};
let trainIntervals=[];

// ======= Helper =======
function updateDayTime(){
  const now = new Date();
  const hours = now.getHours();
  let part='Morning';
  if(hours>=12 && hours<17) part='Afternoon';
  else if(hours>=17) part='Evening';
  dayTimeEl.textContent = `${now.toLocaleDateString(undefined,{weekday:'long'})}, ${part}`;
}

// ========== Weather ==========
async function fetchWeather() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Denver,US&units=imperial&appid=${OPENWEATHER_API_KEY}`);
    const data = await res.json();
    const temp = Math.round(data.main.temp) + '¬∞F';
    const desc = data.weather?.[0]?.description ?? '‚Äî';
    const icon = data.weather?.[0]?.icon;
    const feels = Math.round(data.main.feels_like) + '¬∞F';
    const wind = `${Math.round(data.wind.speed)} mph`;
    const humidity = `${data.main.humidity}%`;
    weatherTempEl.textContent = temp;
    weatherDescEl.textContent = desc[0].toUpperCase() + desc.slice(1);
    weatherFeelsEl.textContent = `Feels: ${feels}`;
    weatherWindEl.textContent = `Wind: ${wind}`;
    weatherHumidityEl.textContent = `Humidity: ${humidity}`;
    if(icon){
      weatherIconEl.textContent = '';
      const img = document.createElement('img');
      img.src=`https://openweathermap.org/img/wn/${icon}@2x.png`;
      img.alt = desc;
      img.style.width='48px'; img.style.height='48px'; img.style.borderRadius='8px';
      weatherIconEl.appendChild(img);
    }
  } catch(err){
    console.error(err);
    weatherTempEl.textContent = 'Error loading weather';
  }
}

// ========== Drive ==========
function getDriveTime(origin,destination,el,mapEl,optName){
  if(!directionsService){el.textContent='Maps service not ready'; return;}
  const avoidHighways = document.querySelector(`input[name="${optName}"]:checked`).value==='true';
  el.textContent='Calculating‚Ä¶';

  const request = {
    origin,
    destination,
    travelMode: google.maps.TravelMode.DRIVING,
    drivingOptions:{departureTime:new Date(),trafficModel:'bestguess'},
    unitSystem: google.maps.UnitSystem.IMPERIAL,
    avoidHighways
  };

  directionsService.route(request,(result,status)=>{
    if(status!=='OK'){el.textContent='Error loading drive time'; console.error(status); return;}
    try{
      const durationMinutes = result.routes[0].legs[0].duration_in_traffic?.value / 60 || result.routes[0].legs[0].duration?.value / 60;
      el.textContent = result.routes[0].legs[0].duration_in_traffic?.text || result.routes[0].legs[0].duration.text || 'N/A';
      if(durationMinutes <= 20) el.style.color='#10b981';
      else if(durationMinutes <= 40) el.style.color='#facc15';
      else el.style.color='#ef4444';

      // Render map
      if(driveRenderers[mapEl.id]) driveRenderers[mapEl.id].setMap(null);
      const map = new google.maps.Map(mapEl, {zoom:12, center: result.routes[0].legs[0].start_location});
      const renderer = new google.maps.DirectionsRenderer({map, suppressMarkers:false, preserveViewport:true});
      renderer.setDirections(result);
      driveRenderers[mapEl.id]=renderer;
    } catch(e){el.textContent='Error loading drive time'; console.error(e);}
  });
}

// ========== Transit N Line ==========
function getNLine(origin,destination,el,countdownEl){
  if(!directionsService){el.textContent='Maps service not ready'; return;}
  el.textContent='Searching N Line‚Ä¶';
  countdownEl.innerHTML='';
  directionsService.route({
    origin,destination, travelMode: google.maps.TravelMode.TRANSIT,
    transitOptions:{modes:['RAIL']}, provideRouteAlternatives:false
  },(result,status)=>{
    try{
      if(status!=='OK') throw new Error('Directions status '+status);
      const leg=result.routes[0].legs[0];
      const steps=leg.steps.filter(s=>s.transit && s.transit.line && (String(s.transit.line.short_name)==='N' || /N/.test(s.transit.line.name)));
      if(!steps.length){el.textContent='No N Line trains now'; return;}
      const upcoming=[];
      steps.slice(0,3).forEach(step=>{
        const dep=new Date(step.transit.departure_time.value);
        const arr=new Date(step.transit.arrival_time.value);
        upcoming.push({dep,arr,headsign:step.transit.headsign||step.transit.line.short_name});
      });
      el.textContent=upcoming.map(u=>`${u.dep.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ‚Üí ${u.arr.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} (${u.headsign})`).join(' | ');

      // Clear previous countdowns
      trainIntervals.forEach(i=>clearInterval(i));
      trainIntervals=[];
      upcoming.forEach((u,index)=>{
        const pill=document.createElement('div');
        pill.className='pill';
        countdownEl.appendChild(pill);
        function updateCountdown(){
          const diff=Math.max(0,u.dep-new Date());
          const min=Math.floor(diff/60000);
          const sec=Math.floor((diff%60000)/1000);
          pill.textContent=`Next: ${min}m ${sec}s`;
          if(min <= 5) { pill.style.backgroundColor='#ef4444'; pill.style.color='white'; } // urgent
          else if(min <=15){ pill.style.backgroundColor='#facc15'; pill.style.color='black'; }
          else { pill.style.backgroundColor='#10b981'; pill.style.color='white'; }
          if(index===0) pill.style.fontWeight='700';
        }
        updateCountdown();
        const interval=setInterval(updateCountdown,1000);
        trainIntervals.push(interval);
      });
    }catch(e){console.error(e); el.textContent='Error loading transit';}
  });
}

// ========== Refresh All ==========
function refreshAll(){
  updateDayTime();
  fetchWeather();
  getDriveTime(HOME,WORK,driveToWorkEl,mapToWorkEl,'driveToWorkOpt');
  getDriveTime(WORK,HOME,driveToHomeEl,mapToHomeEl,'driveToHomeOpt');
  getNLine(N_ORIGIN,N_DEST,trainToWorkEl,trainToWorkCountdownEl);
  getNLine(N_DEST,N_ORIGIN,trainToHomeEl,trainToHomeCountdownEl);
}

document.getElementById('refreshBtn').addEventListener('click',refreshAll);
document.getElementById('themeToggle').addEventListener('click',()=>document.body.classList.toggle('force-dark'));

// ====== NEW: Radio buttons recalc on change ======
document.querySelectorAll('input[name="driveToWorkOpt"]').forEach(rb=>{
  rb.addEventListener('change',()=>getDriveTime(HOME,WORK,driveToWorkEl,mapToWorkEl,'driveToWorkOpt'));
});
document.querySelectorAll('input[name="driveToHomeOpt"]').forEach(rb=>{
  rb.addEventListener('change',()=>getDriveTime(WORK,HOME,driveToHomeEl,mapToHomeEl,'driveToHomeOpt'));
});

// ========== Google Maps Init ==========
function initMap(){
  directionsService=new google.maps.DirectionsService();
  distanceMatrixService=new google.maps.DistanceMatrixService();
  refreshAll();
  setInterval(refreshAll,180000);
}

(function loadGoogleMaps(){
  const script=document.createElement('script');
  script.src=`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
  script.async=true; script.defer=true;
  script.onerror=()=>{driveToWorkEl.textContent='Maps failed'; driveToHomeEl.textContent='Maps failed'; trainToWorkEl.textContent='Maps failed'; trainToHomeEl.textContent='Maps failed'; console.error('Failed to load Google Maps API');};
  document.head.appendChild(script);
})();
</script>
</body>
</html>