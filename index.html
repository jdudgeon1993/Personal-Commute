<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Dynamic Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --bg-color:#f4f7f6;
      --card-color:#ffffff;
      --text-color-primary:#2c3e50;
      --text-color-secondary:#7f8c8d;
      --accent-color:#007bff;
      --shadow-color: rgba(0,0,0,0.1);
      --status-good:#28a745;
      --status-warning:#ffc107;
      --status-alert:#dc3545;
    }
    body.is-dark{
      --bg-color:#11121a;
      --card-color:#1f2230;
      --text-color-primary:#e6e8ff;
      --text-color-secondary:#9aa0c4;
      --accent-color:#ff9900;
      --shadow-color: rgba(0,0,0,0.5);
      --status-good:#38b45a;
      --status-warning:#ffda6a;
      --status-alert:#e85c6a;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Inter',system-ui,Arial;
      background:var(--bg-color);
      color:var(--text-color-primary);
      padding:20px;
      min-height:100vh;
      transition:background-color .25s,color .25s;
    }
    .dashboard-container{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .dashboard-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .header-content h1{
      font-size:2rem;
      font-weight:800;
    }
    .header-content p{color:var(--text-color-secondary)}
    button#theme-toggle{
      background:transparent;border:1px solid var(--text-color-secondary);color:var(--text-color-primary);
      padding:8px 12px;border-radius:8px;cursor:pointer;
    }

    .card{
      background:var(--card-color);
      padding:20px;border-radius:12px;
      box-shadow:0 6px 16px var(--shadow-color);
      border-left:6px solid var(--accent-color);
      transition:transform .18s, border-color .18s, background-color .18s;
    }
    .card .card-title{
      font-weight:600;color:var(--text-color-secondary);
      margin-bottom:10px;font-size:.95rem;text-transform:uppercase;
    }

    /* weather */
    .weather-card .main-data{font-size:3.5rem;font-weight:800;line-height:1}
    .weather-card .card-icon{float:right;font-size:2.2rem;color:var(--accent-color)}

    /* status classes for cards */
    .card.status-good{border-left-color:var(--status-good)}
    .card.status-warning{border-left-color:var(--status-warning)}
    .card.status-alert{border-left-color:var(--status-alert)}

    .commute-list{list-style:none;padding:0;margin:0}
    .commute-item{
      display:grid;grid-template-columns:28px 1fr 90px;gap:12px;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.03);
      text-decoration:none;color:inherit;
    }
    .commute-item .commute-details{font-size:1rem;color:var(--text-color-primary);padding-left:6px}
    .commute-item .commute-time{text-align:right;font-weight:800;font-size:1.4rem;color:var(--accent-color)}
    .commute-item.status-good .commute-time{color:var(--status-good)}
    .commute-item.status-warning .commute-time{color:var(--status-warning)}
    .commute-item.status-alert .commute-time{color:var(--status-alert)}

    .spinner{border:3px solid var(--text-color-secondary);border-top:3px solid var(--accent-color);border-radius:50%;width:26px;height:26px;display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    footer.dashboard-footer{text-align:center;padding:24px 0 8px;color:var(--text-color-secondary);font-size:.85rem}

    @media(min-width:768px){
      .dashboard-container{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto;gap:24px}
      .dashboard-header{grid-column:1/-1;display:flex}
      .weather-card{grid-column:1/-1}
      .home-to-work-card{grid-column:1/2}
      .work-to-home-card{grid-column:2/3}
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <div class="header-content">
        <h1>Good Afternoon!</h1>
        <p id="current-date">Loading date...</p>
      </div>
      <button id="theme-toggle"><i class="fas fa-moon"></i> Switch to Dark</button>
    </header>

    <div id="weather-card" class="card weather-card">
      <div class="card-icon"><i id="weather-icon" class="fas fa-sync-alt spinner"></i></div>
      <div class="card-title">Current Weather - <span id="weather-city-display">Loading...</span></div>
      <div class="main-data" id="weather-temp">--°F</div>
      <p class="secondary-info" id="weather-desc">Loading conditions...</p>
    </div>

    <div id="h2w-card" class="card home-to-work-card">
      <div class="card-title">Commute: Home → Work</div>
      <ul class="commute-list">
        <a id="h2w-drive-link" class="commute-item" href="#" target="_blank" rel="noopener noreferrer">
          <i id="h2w-drive-icon" class="fas fa-car"></i>
          <span class="commute-details" id="h2w-drive-details">Drive traffic time</span>
          <span class="commute-time" id="h2w-drive-time">-- min</span>
        </a>
        <a id="h2w-transit-link" class="commute-item" href="#" target="_blank" rel="noopener noreferrer">
          <i id="h2w-transit-icon" class="fas fa-train"></i>
          <span class="commute-details" id="h2w-transit-details">Transit schedule</span>
          <span class="commute-time" id="h2w-transit-time">-- min</span>
        </a>
      </ul>
    </div>

    <div id="w2h-card" class="card work-to-home-card">
      <div class="card-title">Commute: Work → Home</div>
      <ul class="commute-list">
        <a id="w2h-drive-link" class="commute-item" href="#" target="_blank" rel="noopener noreferrer">
          <i id="w2h-drive-icon" class="fas fa-car"></i>
          <span class="commute-details" id="w2h-drive-details">Drive traffic time</span>
          <span class="commute-time" id="w2h-drive-time">-- min</span>
        </a>
        <a id="w2h-transit-link" class="commute-item" href="#" target="_blank" rel="noopener noreferrer">
          <i id="w2h-transit-icon" class="fas fa-train"></i>
          <span class="commute-details" id="w2h-transit-details">Transit schedule</span>
          <span class="commute-time" id="w2h-transit-time">-- min</span>
        </a>
      </ul>
    </div>
  </div>

  <footer class="dashboard-footer">
    Engineered with the assistance of an AI.
  </footer>

  <script>
  /***********************************************
   * CONFIG (Single-file convenience)
   *
   * WARNING: This single-file contains placeholders
   * for API keys so it can run immediately. This
   * exposes your keys to anyone who views site
   * network requests or source. Strongly prefer
   * Netlify Functions + environment vars for prod.
   ***********************************************/

  // --- Put your keys here temporarily if you want single-file operation:
  const GOOGLE_MAPS_API_KEY = "<INSERT_GOOGLE_KEY_HERE>";
  const OPENWEATHER_API_KEY = "<INSERT_OPENWEATHER_KEY_HERE>";

  // Locations -- keep these in sync with your UI
  const WEATHER_CITY = "Denver";
  const HOME_ADDRESS = "11625 Community Center Drive Northglenn, CO 80233";
  const WORK_ADDRESS = "707 17th Street Denver, CO 80202";

  // Place IDs (for transit requests)
  const TRANSIT_ORIGIN = "place_id:ChIJg_vQ_u0Q_IcRVHnE3g";
  const TRANSIT_DESTINATION = "place_id:ChIJg-X4oV-XzIMR0W9fT8oF_5E";

  // Traffic config
  const TRAFFIC_BUFFER = 1.25;
  const ALERT_THRESHOLD = 1.10;
  const WARNING_THRESHOLD = 1.05;

  // Preferred endpoints:
  // Netlify Functions (recommended if you add them): prefix '/.netlify/functions/'
  const DIRECTIONS_FN = "/.netlify/functions/google-directions";
  const WEATHER_FN = "/.netlify/functions/weather";

  // Fallback endpoints (Netlify redirect proxy to Google if you have netlify.toml)
  const DIRECTIONS_PROXY = "/api-google/directions/json";
  const WEATHER_PROXY = "https://api.openweathermap.org/data/2.5/weather";

  /* ----------------------
     THEME + LAYOUT
     ---------------------- */
  function toggleTheme(){
    const btn = document.getElementById('theme-toggle');
    document.body.classList.toggle('is-dark');
    const isDark = document.body.classList.contains('is-dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    if(btn) btn.innerHTML = isDark ? '<i class="fas fa-sun"></i> Switch to Light' : '<i class="fas fa-moon"></i> Switch to Dark';
  }

  function applyInitialTheme(){
    const saved = localStorage.getItem('theme');
    document.body.classList.remove('is-dark');
    if(saved === 'dark') document.body.classList.add('is-dark');
    const btn = document.getElementById('theme-toggle');
    if(btn){
      const isDark = document.body.classList.contains('is-dark');
      btn.innerHTML = isDark ? '<i class="fas fa-sun"></i> Switch to Light' : '<i class="fas fa-moon"></i> Switch to Dark';
    }
  }

  function setPeakTimeLayout(){
    const h = new Date().getHours();
    document.body.classList.remove('morning-peak','evening-peak');
    if(h >=6 && h < 10) document.body.classList.add('morning-peak');
    else if(h >=15 && h < 19) document.body.classList.add('evening-peak');
  }

  /* ----------------------
     UI helpers
     ---------------------- */
  function setGreeting(){
    const el = document.querySelector('.header-content h1');
    if(!el) return;
    const h = new Date().getHours();
    el.textContent = h < 12 ? "Good Morning!" : (h < 18 ? "Good Afternoon!" : "Good Evening!");
  }

  function updateDate(){
    const el = document.getElementById('current-date');
    if(!el) return;
    const options = { weekday:'long', month:'long', day:'numeric' };
    el.textContent = new Date().toLocaleDateString('en-US', options);
  }

  function getWeatherIcon(code){
    const map = {
      '01d':'fa-sun','01n':'fa-moon','02d':'fa-cloud-sun','02n':'fa-cloud-moon',
      '03d':'fa-cloud','03n':'fa-cloud','04d':'fa-cloud-meatball','04n':'fa-cloud-meatball',
      '09d':'fa-cloud-showers-heavy','09n':'fa-cloud-showers-heavy','10d':'fa-cloud-sun-rain','10n':'fa-cloud-moon-rain',
      '11d':'fa-bolt','11n':'fa-bolt','13d':'fa-snowflake','13n':'fa-snowflake','50d':'fa-smog','50n':'fa-smog'
    };
    return map[code] || 'fa-question-circle';
  }

  /* ----------------------
     Utilities: traffic status
     ---------------------- */
  function getTrafficStatus(liveDuration, freeFlowDuration){
    if(!liveDuration || !freeFlowDuration) return 'good';
    const normal = freeFlowDuration * TRAFFIC_BUFFER;
    if(liveDuration > normal * ALERT_THRESHOLD) return 'alert';
    if(liveDuration > normal * WARNING_THRESHOLD) return 'warning';
    return 'good';
  }

  function applyCardStatusById(cardId, status){
    const card = document.getElementById(cardId);
    if(!card) return;
    card.classList.remove('status-good','status-warning','status-alert');
    card.classList.add(`status-${status}`);
  }

  function applyItemStatus(itemElement, status){
    if(!itemElement) return;
    itemElement.classList.remove('status-good','status-warning','status-alert');
    itemElement.classList.add(`status-${status}`);
  }

  /* ----------------------
     Deep link helper
     ---------------------- */
  function createMapsUrl(origin, destination, mode){
    // Use Google Maps deep link for human-friendly addresses
    return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${encodeURIComponent(mode)}`;
  }

  /* ----------------------
     FETCH: Weather
     - tries serverless function first, else falls back to client-side fetch
     ---------------------- */
  async function fetchWeather(){
    const tempEl = document.getElementById('weather-temp');
    const descEl = document.getElementById('weather-desc');
    const iconEl = document.getElementById('weather-icon');
    const cityEl = document.getElementById('weather-city-display');

    if(iconEl) iconEl.className='fas fa-sync-alt spinner';
    if(cityEl) cityEl.textContent='Loading...';
    try{
      // Try Netlify function first
      let resp = null;
      try {
        resp = await fetch(`${WEATHER_FN}?city=${encodeURIComponent(WEATHER_CITY)}`);
        if(!resp.ok) throw new Error('No serverless');
      } catch(e){
        // fallback to public OpenWeather (requires OPENWEATHER_API_KEY present)
        if(!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY.includes('<INSERT')) {
          throw new Error('No weather function and no API key present. Add a key or provide Netlify function.');
        }
        const url = `${WEATHER_PROXY}?q=${encodeURIComponent(WEATHER_CITY)},US&units=metric&appid=${OPENWEATHER_API_KEY}`;
        resp = await fetch(url);
        if(!resp.ok) throw new Error(`OpenWeather network ${resp.status}`);
      }

      const data = await resp.json();
      if(!data || !data.weather || !data.weather.length || !data.main) throw new Error('Incomplete weather data');

      const tempF = Math.round(data.main.temp * 9/5 + 32);
      const description = data.weather[0].description ? (data.weather[0].description.charAt(0).toUpperCase()+data.weather[0].description.slice(1)) : 'Weather';

      if(tempEl) tempEl.textContent = `${tempF}°F`;
      if(descEl) descEl.textContent = description;
      if(cityEl) cityEl.textContent = data.name || WEATHER_CITY;
      if(iconEl){
        const fa = getWeatherIcon(data.weather[0].icon);
        iconEl.className = `fas ${fa}`;
      }
    } catch(err){
      console.error('fetchWeather error:',err);
      if(tempEl) tempEl.textContent='--°F';
      if(descEl) descEl.textContent='Error loading data';
      if(cityEl) cityEl.textContent=WEATHER_CITY;
      if(iconEl) iconEl.className='fas fa-exclamation-triangle';
    }
  }

  /* ----------------------
     FETCH: Directions/Commute
     - tries serverless function first, else falls back to proxy redirect (requires GOOGLE_MAPS_API_KEY for fallback)
     - safe transit fallback when transit steps missing
     ---------------------- */
  async function fetchCommute(origin, destination, mode, timeId, detailsId, iconId, linkId, cardId){
    // DOM refs
    const timeEl = document.getElementById(timeId);
    const detailsEl = document.getElementById(detailsId);
    const iconEl = iconId ? document.getElementById(iconId) : null;
    const linkEl = linkId ? document.getElementById(linkId) : null;
    const cardEl = cardId ? document.getElementById(cardId) : (linkEl ? linkEl : null);

    if(timeEl) timeEl.innerHTML = '<span class="spinner"></span>';
    if(detailsEl) detailsEl.textContent = mode === 'driving' ? 'Checking traffic...' : 'Checking schedule...';
    if(iconEl) iconEl.className = 'fas fa-sync-alt spinner';

    try{
      // Try Netlify function first
      let resp = null;
      try {
        const fnUrl = `${DIRECTIONS_FN}?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&mode=${encodeURIComponent(mode)}`;
        resp = await fetch(fnUrl);
        if(!resp.ok) throw new Error('No serverless directions');
      } catch(e){
        // Fallback to proxy redirect - requires client API key included in URL
        if(!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes('<INSERT')) {
          throw new Error('No directions function and no API key present. Add a key or provide Netlify function.');
        }
        const proxyUrl = `${DIRECTIONS_PROXY}?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&mode=${encodeURIComponent(mode)}&departure_time=now&key=${GOOGLE_MAPS_API_KEY}`;
        resp = await fetch(proxyUrl);
        if(!resp.ok) throw new Error(`Proxy network ${resp.status}`);
      }

      const data = await resp.json();
      if(!data) throw new Error('Empty directions response');

      // Google directions-specific checks:
      if(data.status && data.status !== 'OK') {
        // Could be REQUEST_DENIED, ZERO_RESULTS, OVER_QUERY_LIMIT, etc.
        throw new Error(`Google API: ${data.status}`);
      }
      if(!data.routes || !data.routes.length) throw new Error('No routes found');

      const leg = data.routes[0].legs && data.routes[0].legs[0];
      if(!leg) throw new Error('No leg data');

      // durations (values in seconds)
      const freeFlowSec = leg.duration ? leg.duration.value : null;
      const liveSec = (leg.duration_in_traffic && leg.duration_in_traffic.value) ? leg.duration_in_traffic.value : freeFlowSec;

      let detailsText = '';
      let trafficStatus = 'good';

      if(mode === 'driving'){
        trafficStatus = getTrafficStatus(liveSec, freeFlowSec);
        detailsText = leg.duration_in_traffic ? 'Live Traffic' : 'No Traffic Data';
        // update card color
        if(cardEl) applyCardStatusById(cardId, trafficStatus);
      } else {
        // Transit safe processing
        const steps = Array.isArray(leg.steps) ? leg.steps : [];
        const transitStep = steps.find(s => s.travel_mode === 'TRANSIT' && s.transit_details && s.transit_details.departure_time);

        if(transitStep && transitStep.transit_details){
          const line = transitStep.transit_details.line || {};
          const depTime = transitStep.transit_details.departure_time ? transitStep.transit_details.departure_time.text : 'TBD';
          const depStop = transitStep.transit_details.departure_stop ? transitStep.transit_details.departure_stop.name : 'Unknown';
          detailsText = `${line.short_name || line.name || 'Transit'} @ ${depTime} from ${String(depStop).split(' Station')[0]}`;
          trafficStatus = 'good';
          if(cardEl) applyCardStatusById(cardId, trafficStatus);
        } else {
          // fallback to human-friendly walking instructions if no transit
          const instr = steps.map(s => (s.html_instructions || '').replace(/<[^>]+>/g,'')).filter(Boolean).slice(0,3).join(' → ');
          detailsText = instr || 'Walk / No immediate transit route';
          trafficStatus = 'warning';
          if(cardEl) applyCardStatusById(cardId, trafficStatus);
        }
      }

      // update time and UI
      const minutes = (liveSec && !isNaN(liveSec)) ? Math.round(liveSec / 60) : null;
      if(timeEl) timeEl.textContent = (minutes !== null ? `${minutes} min` : '--');
      if(detailsEl) detailsEl.textContent = detailsText;

      if(iconEl){
        iconEl.className = mode === 'driving' ? 'fas fa-car' : 'fas fa-subway';
      }

      // set deep link (use human-friendly addresses)
      const orig = (mode === 'driving') ? HOME_ADDRESS : '112th Avenue & York Street Station';
      const dest = (mode === 'driving') ? WORK_ADDRESS : 'Denver Union Station';
      if(linkEl){
        linkEl.href = createMapsUrl(orig, dest, mode);
        linkEl.setAttribute('aria-label', `${mode} from ${orig} to ${dest}`);
      }

      // also apply status to the link (commute-item) element if present
      if(linkEl) applyItemStatus(linkEl, trafficStatus);

    } catch(err){
      console.error('fetchCommute error', err);
      if(timeEl) timeEl.textContent = '--';
      if(detailsEl) detailsEl.textContent = (mode === 'driving') ? 'Drive Error (Check proxy/key)' : 'Transit Error (Check Place IDs/proxy)';
      if(iconEl) iconEl.className = 'fas fa-exclamation-triangle';
      if(linkEl){ linkEl.href = '#'; applyItemStatus(linkEl,'alert'); }
      if(cardId) applyCardStatusById(cardId,'alert');
    }
  } // fetchCommute

  function fetchAllCommutes(){
    // Driving
    fetchCommute(HOME_ADDRESS, WORK_ADDRESS, 'driving', 'h2w-drive-time','h2w-drive-details','h2w-drive-icon','h2w-drive-link','h2w-card');
    fetchCommute(WORK_ADDRESS, HOME_ADDRESS, 'driving', 'w2h-drive-time','w2h-drive-details','w2h-drive-icon','w2h-drive-link','w2h-card');

    // Transit (use place IDs)
    fetchCommute(TRANSIT_ORIGIN, TRANSIT_DESTINATION, 'transit', 'h2w-transit-time','h2w-transit-details','h2w-transit-icon','h2w-transit-link','h2w-card');
    fetchCommute(TRANSIT_DESTINATION, TRANSIT_ORIGIN, 'transit', 'w2h-transit-time','w2h-transit-details','w2h-transit-icon','w2h-transit-link','w2h-card');
  }

  /* ----------------------
     Initialization + intervals
     ---------------------- */
  function initDashboard(){
    applyInitialTheme();
    const toggle = document.getElementById('theme-toggle');
    if(toggle) toggle.addEventListener('click', toggleTheme);

    setGreeting();
    updateDate();
    setPeakTimeLayout();

    fetchWeather();
    fetchAllCommutes();

    setInterval(fetchWeather, 300000); // 5 min
    setInterval(fetchAllCommutes, 300000); // 5 min
    setInterval(updateDate, 60000); // 1 min
    setInterval(setPeakTimeLayout, 60000); // 1 min
  }

  window.addEventListener('load', initDashboard);
  </script>
</body>
</html>