<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Commuter Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* -------------------------------------
           GLOBAL THEME & TYPOGRAPHY
           ------------------------------------- */
        :root {
            --background: #fcfcfc;
            --surface: #ffffff;
            --text: #1a1a1a;
            --muted: #6b7280; 
            --border: #e5e7eb; 
            --success: #10b981; 
            --warn: #f59e0b; 
            --danger: #ef4444; 
            --accent: #3b82f6; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --accent-rgb: 59, 130, 246; 
            --text-rgb: 26, 26, 26;     
            --warn-rgb: 245, 158, 11;   
        }

        .dark {
            --background: #181a20;
            --surface: #20232a;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #374151;
            --success: #4ade80; 
            --warn: #fbbf24; 
            --danger: #f87171; 
            --accent: #60a5fa; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --accent-rgb: 96, 165, 250; 
            --text-rgb: 229, 231, 235;
            --warn-rgb: 251, 191, 36;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 30px;
            background-color: var(--background);
            color: var(--text);
            transition: background-color 0.4s, color 0.4s;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, border-color 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .dark .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card-header-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-icon {
            background-color: var(--accent);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .header-card {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center; 
            padding: 0 10px 0 0; 
            background-color: transparent; 
            box-shadow: none; 
            border: none; 
        }
        
        .header-card > div:first-child {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #commuteTitle {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text);
            line-height: 1;
        }

        #headerSubtitle {
            font-size: 1rem;
            color: var(--muted);
            font-weight: 500;
            margin-top: 5px;
        }

        .controls {
            display: flex;
            flex-direction: row; 
            align-items: center; 
            gap: 15px; 
        }

        .controls button {
            background-color: var(--accent);
            color: white; 
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s, color 0.3s;
            font-weight: 600;
            width: auto;
            min-width: 120px;
        }
        
        #themeToggle {
            background-color: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px;
            min-width: auto;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
        }
        
        .controls button:hover, #themeToggle:hover {
            opacity: 0.9;
        }

        .schedule-data-group {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .schedule-data-column {
            flex: 1;
            background-color: rgba(var(--text-rgb), 0.03); 
            padding: 15px;
            border-radius: 10px;
        }
        
        .schedule-data-column:nth-child(2) {
            background-color: rgba(var(--accent-rgb), 0.05); 
            flex-grow: 0;
        }

        .schedule-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 5px;
        }

        #requiredDepartureTime {
            font-size: 2.2rem; 
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1px;
            display: block;
            margin-top: 0;
            color: var(--text); 
        }
        
        #targetArrivalDisplay {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1.1;
        }

        #departureNote {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 10px;
            color: var(--muted);
        }

        .current-time-block {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        #currentTimeBig {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1px;
        }
        
        .current-time-block button {
            width: 100%;
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Weather in Schedule Card Styling */
        .weather-info {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        #weatherTemp {
            font-size: 3rem; 
            font-weight: 800;
            color: var(--danger);
            line-height: 1;
        }

        .weather-details {
            display: flex;
            flex-direction: column;
            gap: 5px; 
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--muted);
        }
        
        #weatherIcon img {
             filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.2));
             transition: filter 0.3s;
             width: 50px; 
             height: 50px;
        }
        
        .drive-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            transition: border-color 0.3s;
        }
        
        .drive-item:last-of-type {
            border-bottom: none;
            margin-bottom: 10px;
        }
        
        .drive-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
            transition: color 0.3s;
        }

        .drive-eta {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            display: inline-block;
            margin-right: 10px;
            transition: color 0.3s;
        }
        
        .drive-normal {
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 500;
        }

        .drive-fill-container {
            height: 10px;
            background-color: var(--border);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .drive-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-out, background-color 0.5s;
        }
        
        .transit-direction {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            transition: border-color 0.3s;
        }

        .transit-direction h3 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.3s;
        }
        
        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            font-size: 1rem;
            background-color: rgba(var(--text-rgb), 0.03); 
            transition: background-color 0.3s;
        }
        
        .prediction-item.next-up {
            background-color: rgba(var(--accent-rgb), 0.1);
        }
        
        .schedule-time {
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        .schedule-countdown {
            color: var(--success);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .schedule-arriving {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .schedule-critical {
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--warn); 
            animation: pulse-critical 2s infinite alternate;
        }
        
        @keyframes pulse-critical {
            from { color: var(--warn); transform: scale(1.0); }
            50% { color: var(--danger); transform: scale(1.05); }
            to { color: var(--warn); transform: scale(1.0); }
        }

        .schedule-departing {
            color: var(--danger);
            font-weight: 900;
            font-size: 1.1rem;
            animation: pulse-red 1s infinite alternate;
        }
        
        @keyframes pulse-red {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        .schedule-no-service {
            color: var(--muted);
            font-style: italic;
            padding: 15px;
            text-align: center;
        }
        
        #transitMapBtn {
            width: 100%;
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 20px; 
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }
        
        #driveToWorkBtn {
            width: 100%;
            background-color: var(--warn); 
            color: var(--text); 
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 15px; 
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s, color 0.3s;
        }


        #alerts-card {
            grid-column: 1 / -1; 
            display: none; 
            border-left: 5px solid var(--warn);
            background-color: rgba(var(--warn-rgb), 0.1); 
            transition: background-color 0.3s, border-left-color 0.3s;
        }

        .alert-header {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--warn);
            display: flex; 
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .alert-item {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
            font-size: 0.95rem;
            align-items: flex-start;
        }

        .alert-icon {
            flex-shrink: 0;
            font-size: 1.1em;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        .control-group input[type="checkbox"] {
            transform: scale(1.1);
            accent-color: var(--accent);
            transition: accent-color 0.3s;
        }
        
        /* COLLAPSIBLE STYLES */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* margin-bottom: 20px; - Removed, handled by card-header-group now */
        }

        .collapsible-icon {
            transition: transform 0.3s;
            font-size: 1.5rem;
            line-height: 1;
            margin-left: 15px; /* Ensure space between title and icon */
        }
        
        .card[data-collapsed="true"] .collapsible-icon {
            transform: rotate(-90deg); /* Arrow points right (‚ñ∂) */
        }
        
        .card[data-collapsed="true"] .card-content {
            display: none;
        }
        
        .card[data-collapsed="false"] .collapsible-icon {
            transform: rotate(0deg); /* Arrow points down (‚ñº) */
        }
        
        /* Specific header style overrides for better visual flow on collapsible cards */
        /* Default state: full margin/padding/border */
        #driveTimesCard .card-header-group, 
        #transitCard .card-header-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        /* Collapsed state: removes the extra space and border */
        .card[data-collapsed="true"] #driveHeader .card-header-group,
        .card[data-collapsed="true"] #transitHeader .card-header-group {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        /* Handle the Alerts card specific classes for collapse */
        #alerts-card[data-collapsed="true"] .card-content {
            display: none !important;
        }

    </style>
</head>
<body class="dark">

    <div class="header-card">
        <div>
            <div id="commuteTitle">Commute Dashboard</div>
            <div id="headerSubtitle">Monday, Afternoon</div>
        </div>
        <div class="controls">
            <button id="refreshBtn">Refresh Now</button>
            <button id="themeToggle">üåì</button>
        </div>
    </div>
    
    <div id="alerts-card" class="card" data-collapsed="true">
        <div id="alertsHeader" class="alert-header">
            <span>‚ö†Ô∏è Service Alerts</span>
            <span class="collapsible-icon" data-target="alerts-card">‚ñ∂</span>
        </div>
        <div class="card-content" id="alertsContent">
            </div>
    </div>

    <div class="dashboard-grid">
        
        <div class="card" id="workScheduleCard">
            
            <div class="card-header-group">
                <div class="card-icon">‚è∞</div>
                <div>
                    <div class="schedule-label">Today's Schedule</div>
                    <div class="card-title-text">Work: <span id="scheduleTimeWindow">08:00 - 17:30</span></div>
                </div>
            </div>

            <div class="weather-info">
                <div id="weatherIcon"></div>
                <div>
                    <div id="weatherTemp">--¬∞F</div>
                    <div id="weatherDesc" style="font-weight: 600;">Loading...</div>
                </div>
                <div class="weather-details">
                    <span id="weatherFeels"></span>
                    <span id="weatherWind"></span>
                    <span id="weatherHumidity"></span>
                </div>
            </div>

            <div class="schedule-data-group">
                <div class="schedule-data-column">
                    <div class="schedule-label">Required Drive Departure Time</div>
                    <span id="requiredDepartureTime">N/A</span>
                    <div id="departureNote">No required departure time (non-work or past arrival target).</div>
                </div>
                
                <div class="schedule-data-column">
                    <div class="schedule-label" style="text-align: right;">Target Arrival:</div>
                    <div id="targetArrivalDisplay" style="text-align: right;">07:30 AM</div>
                </div>
            </div>

            <div class="current-time-block">
                <div class="schedule-label">Current Time</div>
                <div id="currentTimeBig" style="margin-bottom: 10px;">03:52 PM</div>
                <button id="openWorkMapBtn">Open Work Map</button>
            </div>
            
        </div>
        
        <div class="card" id="driveTimesCard" data-collapsed="true">
            <div id="driveHeader" class="collapsible-header">
                <div class="card-header-group">
                    <div class="card-icon" style="background-color: var(--warn);">üöó</div>
                    <div class="card-title-text">Drive Times</div>
                </div>
                <span class="collapsible-icon" data-target="driveTimesCard">‚ñ∂</span>
            </div>

            <div class="card-content">
                <div style="margin-bottom: 15px;">
                    <label for="avoidHighway" class="control-group">
                        <input type="checkbox" id="avoidHighway" checked> Avoid Highways (Favor Slower Routes)
                    </label>
                </div>

                <div class="drive-item">
                    <div class="drive-header">To Work (Home ‚Üí Office)</div>
                    <div class="drive-fill-container">
                        <div id="driveToWorkFill" class="drive-fill"></div>
                    </div>
                    <span id="driveToWorkETA" class="drive-eta">Calculating...</span>
                    <span id="driveToWorkNormal" class="drive-normal"></span>
                    <div id="driveToWorkNote" style="font-size: 0.8em; color: var(--muted); margin-top: 5px;"></div>
                </div>

                <div class="drive-item">
                    <div class="drive-header">To Home (Office ‚Üí Home)</div>
                    <div class="drive-fill-container">
                        <div id="driveToHomeFill" class="drive-fill"></div>
                    </div>
                    <span id="driveToHomeETA" class="drive-eta">Calculating...</span>
                    <span id="driveToHomeNormal" class="drive-normal"></span>
                    <div id="driveToHomeNote" style="font-size: 0.8em; color: var(--muted); margin-top: 5px;"></div>
                </div>
                
                <button id="driveToWorkBtn">View Live Traffic</button>
                <a id="openWorkBtn" style="display: none;"></a> 
            </div>
        </div>

        <div class="card" id="transitCard" data-collapsed="true">
            <div id="transitHeader" class="collapsible-header">
                <div class="card-header-group">
                    <div class="card-icon" style="background-color: var(--accent);">üöÜ</div>
                    <div class="card-title-text">N Line Transit Schedule</div>
                </div>
                <span class="collapsible-icon" data-target="transitCard">‚ñ∂</span>
            </div>

            <div class="card-content">
                <div id="currentDayScheduleSummary" style="font-size: 0.95rem; color: var(--muted); margin-bottom: 15px;">--</div>

                <div class="transit-direction">
                    <h3>Southbound (112th ‚Üí Union Station)</h3>
                    <div id="sb-window" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">--</div>
                    <div id="sb-predictions">
                        <div class="schedule-no-service">Loading schedule...</div>
                    </div>
                </div>

                <div class="transit-direction">
                    <h3>Northbound (Union Station ‚Üí 112th)</h3>
                    <div id="nb-window" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">--</div>
                    <div id="nb-predictions">
                        <div class="schedule-no-service">Loading schedule...</div>
                    </div>
                </div>
                
                <button id="transitMapBtn">Open Transit Map</button>
                <a id="sbMapBtn" style="display: none;"></a> 
                <a id="nbMapBtn" style="display: none;"></a>
            </div>
        </div>

    </div>

    <script>
        // Use a single CONFIG object for easy updates
        const CONFIG = {
            // API KEYS
            OPENWEATHER_API_KEY: '1c91f81f2adfd1b633d19842869a1a11',
            GOOGLE_MAPS_API_KEY: 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY',
            
            // ADDRESSES
            HOME_ADDR: '11625 Community Center Drive, Northglenn, CO 80233',
            WORK_ADDR: '707 17th Street, Denver, CO 80202',
            N_ORIGIN: '112th & Northglenn Station, Northglenn, CO',
            N_DEST: 'Denver Union Station, Denver, CO',
            
            // CONSTANTS
            BASELINE_DRIVE_MINS: 25, 
            ARRIVAL_BUFFER_MINS: 30, // Arrive this many minutes before work start
            MAX_PREDICTIONS: 3,
            OPENWEATHER_CITY_ID: 5419384,
            CRITICAL_TRANSIT_SECONDS: 300, // 5 minutes = 300 seconds

            // WORK SCHEDULE (HH:MM strings)
            // Day: 0=Sunday, 1=Monday... 6=Saturday
            WORK_SCHEDULE: {
                1: { start: '08:00', end: '17:30' }, 
                2: { start: '08:00', end: '17:30' }, 
                3: { start: '08:00', end: '17:30' }, 
                4: { start: '08:00', end: '17:30' }, 
                5: { start: '08:00', end: '16:30' }, 
                0: null, 
                6: null  
            },
            
            // RTD SCHEDULE (N Line)
            RTD_SCHEDULES: {
                'MT': { start_sb: { h: 4, m: 46 }, end_sb: { h: 22, m: 16 }, start_nb: { h: 5, m: 26 }, end_nb: { h: 22, m: 56 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
                'F': { start_sb: { h: 4, m: 46 }, end_sb: { h: 22, m: 46 }, start_nb: { h: 5, m: 26 }, end_nb: { h: 23, m: 26 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
                'SAT': { start_sb: { h: 5, m: 46 }, end_sb: { h: 23, m: 16 }, start_nb: { h: 6, m: 26 }, end_nb: { h: 23, m: 56 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
                'SUN': { start_sb: { h: 5, m: 46 }, end_sb: { h: 21, m: 46 }, start_nb: { h: 6, m: 26 }, end_nb: { h: 22, m: 26 }, sbMinutes: [16, 46], nbMinutes: [26, 56] }
            },
            
            // ALERTS (Hardcoded for demo)
            ALERTS: [
                /* Example alerts (uncomment to see them displayed)
                { type: 'DELAY', message: 'N Line running 15 minutes late due to signal issues near 88th.' },
                { type: 'ADVISORY', message: 'I-25 Southbound has heavy congestion this afternoon.' }
                */
            ]
        };

        // DOM REFERENCES - Consolidated for efficiency
        const DOM_REFS = {
            headerSubtitle: document.getElementById('headerSubtitle'),
            scheduleTimeWindow: document.getElementById('scheduleTimeWindow'),
            targetArrivalDisplay: document.getElementById('targetArrivalDisplay'),
            currentTimeBig: document.getElementById('currentTimeBig'),
            openWorkMapBtn: document.getElementById('openWorkMapBtn'), 
            requiredDepartureTime: document.getElementById('requiredDepartureTime'),
            departureNote: document.getElementById('departureNote'),
            openWorkBtn: document.getElementById('openWorkBtn'), 
            driveToWorkBtn: document.getElementById('driveToWorkBtn'), 
            currentDayScheduleSummary: document.getElementById('currentDayScheduleSummary'),
            // WEATHER ELEMENTS (MOVED)
            weatherTempEl: document.getElementById('weatherTemp'),
            weatherDescEl: document.getElementById('weatherDesc'),
            weatherIconEl: document.getElementById('weatherIcon'),
            weatherFeelsEl: document.getElementById('weatherFeels'),
            weatherWindEl: document.getElementById('weatherWind'),
            weatherHumidityEl: document.getElementById('weatherHumidity'),
            // END WEATHER
            driveToWorkETA: document.getElementById('driveToWorkETA'),
            driveToWorkNormal: document.getElementById('driveToWorkNormal'),
            driveToHomeETA: document.getElementById('driveToHomeETA'),
            driveToHomeNormal: document.getElementById('driveToHomeNormal'),
            driveToWorkFill: document.getElementById('driveToWorkFill'),
            driveToHomeFill: document.getElementById('driveToHomeFill'),
            driveToWorkNote: document.getElementById('driveToWorkNote'),
            driveToHomeNote: document.getElementById('driveToHomeNote'),
            avoidCheckbox: document.getElementById('avoidHighway'),
            sbWindowEl: document.getElementById('sb-window'),
            nbWindowEl: document.getElementById('nb-window'),
            sbPredictionsContainer: document.getElementById('sb-predictions'),
            nbPredictionsContainer: document.getElementById('nb-predictions'),
            transitMapBtn: document.getElementById('transitMapBtn'), 
            sbMapBtn: document.getElementById('sbMapBtn'), 
            nbMapBtn: document.getElementById('nbMapBtn'), 
            alertsCard: document.getElementById('alerts-card'),
            alertsHeader: document.getElementById('alertsHeader'),
            alertsContent: document.getElementById('alertsContent'),
            refreshBtn: document.getElementById('refreshBtn'),
            themeToggle: document.getElementById('themeToggle'),
            // NEW COLLAPSIBLE CARD HEADERS
            driveHeader: document.getElementById('driveHeader'),
            transitHeader: document.getElementById('transitHeader'),
            driveCard: document.getElementById('driveTimesCard'),
            transitCard: document.getElementById('transitCard')
        };


        let directionsService = null;
        let traffic_interval = null; 
        let transit_interval = null; 

        /* -------------------------
        ¬† ¬†Helpers and Time
        ¬† ¬†------------------------- */
        // Consolidated helper for setting content
        function safeSet(el, txt, html=false){ 
            if(!el) return;
            if(html) el.innerHTML = txt ?? '‚Äî';
            else el.textContent = txt ?? '‚Äî'; 
        }

        // Time formatters
        const formatTime = (d) => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}); 
        const formatTimeShort = (d) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: true}).replace(/\s/g, ''); 
        
        const getCssVariable = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

        function setDayTime(){ 
            const now = new Date(); 
            const h = now.getHours(); 
            let part = (h >= 17) ? 'Evening' : (h >= 12) ? 'Afternoon' : 'Morning'; 
            safeSet(DOM_REFS.headerSubtitle, `${now.toLocaleDateString(undefined,{weekday:'long'})}, ${part}`); 
            safeSet(DOM_REFS.currentTimeBig, formatTime(now));
        }

        /* -------------------------
        ¬† ¬†Weather (OpenWeather 2.5)
        ¬† ¬†------------------------- */
        async function loadWeather(){
        ¬† try{
        ¬† ¬† const url = `https://api.openweathermap.org/data/2.5/weather?id=${CONFIG.OPENWEATHER_CITY_ID}&units=imperial&appid=${CONFIG.OPENWEATHER_API_KEY}`;
        ¬† ¬† const res = await fetch(url);
        ¬† ¬† if(!res.ok) throw new Error('weather fetch failed: HTTP ' + res.status);
        ¬† ¬† const d = await res.json();
        ¬† ¬† 
        ¬† ¬† const current = d;
        ¬† ¬† safeSet(DOM_REFS.weatherTempEl, Math.round(current.main.temp) + '¬∞F');
        ¬† ¬† const desc = current.weather?.[0]?.description ?? '';
        ¬† ¬† safeSet(DOM_REFS.weatherDescEl, desc ? (desc[0].toUpperCase()+desc.slice(1)) : '‚Äî');
        ¬† ¬† safeSet(DOM_REFS.weatherFeelsEl, 'Feels: ' + Math.round(current.main.feels_like) + '¬∞F');
        ¬† ¬† safeSet(DOM_REFS.weatherWindEl, 'Wind: ' + Math.round(current.wind.speed) + ' mph');
        ¬† ¬† safeSet(DOM_REFS.weatherHumidityEl, 'Humidity: ' + current.main.humidity + '%');
        ¬† ¬† 
        ¬† ¬† if(current.weather?.[0]?.icon){
        ¬† ¬† ¬† DOM_REFS.weatherIconEl.innerHTML = '';
        ¬† ¬† ¬† const img = document.createElement('img');
        ¬† ¬† ¬† img.src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@2x.png`;
        ¬† ¬† ¬† img.alt = desc;
        ¬† ¬† ¬† DOM_REFS.weatherIconEl.appendChild(img);
        ¬† ¬† }

        ¬† }catch(err){ 
        ¬† ¬† console.error('Weather error:', err); 
        ¬† ¬† safeSet(DOM_REFS.weatherTempEl,'Error'); 
        ¬† }
        }

        /* -------------------------
        ¬† ¬†Schedule Logic (Work)
        ¬† ¬†------------------------- */

        function getScheduleForToday() {
            const now = new Date();
            const day = now.getDay();
            const schedule = CONFIG.WORK_SCHEDULE[day];
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            
            if (!schedule) {
                safeSet(DOM_REFS.scheduleTimeWindow, `${dayNames[day]} (No Work)`);
                safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
                safeSet(DOM_REFS.targetArrivalDisplay, '--:--');
                safeSet(DOM_REFS.departureNote, 'No required departure time (non-work day).');
                DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
                return null;
            }
            
            const [h, m] = schedule.start.split(':').map(Number);
            const workStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);

            // Calculate Target Arrival (Work Start - Buffer Time)
            const requiredTargetArrival = new Date(workStartTime.getTime() - (CONFIG.ARRIVAL_BUFFER_MINS * 60 * 1000));
            
            safeSet(DOM_REFS.scheduleTimeWindow, `${schedule.start} - ${schedule.end}`);
            safeSet(DOM_REFS.targetArrivalDisplay, formatTimeShort(requiredTargetArrival)); 
            
            // If current time is past work start + grace period, no required departure needed
            if (now.getTime() > workStartTime.getTime() + (30 * 60 * 1000)) { 
                safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
                safeSet(DOM_REFS.departureNote, 'No required departure time (work in progress).');
                DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
                return null;
            }
            
            return requiredTargetArrival;
        }


        /* -------------------------
        ¬† ¬†Drive (DirectionsService)
        ¬† ¬†------------------------- */
        function updateDrive(origin,destination,etaEl,normalEl,fillEl,noteEl,targetArrival,isMorning){
        ¬† if(!directionsService){ safeSet(etaEl,'Maps not ready'); return; }
        ¬† safeSet(etaEl,'Calculating‚Ä¶');
        ¬† safeSet(normalEl, `(Normal: ${CONFIG.BASELINE_DRIVE_MINS} mins)`);
        ¬† fillEl.style.width='0%';
        ¬† 
          const isAvoidingHighways = DOM_REFS.avoidCheckbox.checked;

        ¬† directionsService.route({
        ¬† ¬† origin, destination,
        ¬† ¬† travelMode: google.maps.TravelMode.DRIVING,
        ¬† ¬† drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' },
        ¬† ¬† avoidHighways: !!isAvoidingHighways
        ¬† }, (result, status) => { 
        ¬† ¬† if(status !== google.maps.DirectionsStatus.OK || !result.routes.length){ 
        ¬† ¬† ¬† console.error('Drive error', status, result); 
        ¬† ¬† ¬† safeSet(etaEl,'Error: No Route Found'); 
              fillEl.style.width = '100%';
              fillEl.style.background = getCssVariable('--muted');
        ¬† ¬† ¬† return; 
        ¬† ¬† }
        ¬† ¬† 
        ¬† ¬† const leg = result.routes[0].legs[0];
        ¬† ¬† const mins = (leg.duration_in_traffic?.value || leg.duration?.value)/60;
            
            const delayMins = Math.round(mins - CONFIG.BASELINE_DRIVE_MINS);
            let delayText = (delayMins > 0) ? ` (+${delayMins} min delay)` : (delayMins < 0) ? ` (${Math.abs(delayMins)} min faster)` : ` (On schedule)`;
            
            safeSet(etaEl, (leg.duration_in_traffic?.text || leg.duration?.text || 'N/A') + delayText);
        ¬† ¬† 
        ¬† ¬† const pct = Math.min(Math.round((mins / CONFIG.BASELINE_DRIVE_MINS) * 100), 100);
        ¬† ¬† fillEl.style.width = pct + '%';
        ¬† ¬† 
        ¬† ¬† const { success: successColor, warn: warnColor, danger: dangerColor } = {
                success: getCssVariable('--success'),
                warn: getCssVariable('--warn'),
                danger: getCssVariable('--danger')
            };

        ¬† ¬† fillEl.style.background = (mins <= CONFIG.BASELINE_DRIVE_MINS + 5) ? successColor : 
                                    (mins <= CONFIG.BASELINE_DRIVE_MINS + 15) ? warnColor : dangerColor;
        ¬† ¬† 
        ¬† ¬† if(noteEl) safeSet(noteEl, 'Last updated: ' + new Date().toLocaleTimeString());

            if (isMorning && targetArrival) {
                const requiredDepartureMs = targetArrival.getTime() - (mins * 60 * 1000) + (CONFIG.ARRIVAL_BUFFER_MINS * 60 * 1000); 
                const requiredDeparture = new Date(requiredDepartureMs);
                const now = new Date();
                const diffMins = Math.ceil((requiredDeparture.getTime() - now.getTime()) / 60000);

                safeSet(DOM_REFS.requiredDepartureTime, formatTimeShort(requiredDeparture));

                if (diffMins > 30) {
                    safeSet(DOM_REFS.departureNote, `You have ${diffMins} minutes until you must leave.`);
                    DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--accent');
                } else if (diffMins > 0) {
                    safeSet(DOM_REFS.departureNote, `You **MUST** leave in ${diffMins} minutes to arrive on time!`, true);
                    DOM_REFS.requiredDepartureTime.style.color = warnColor;
                } else {
                    safeSet(DOM_REFS.departureNote, `üî¥ Leave **IMMEDIATELY** or you will be late.`, true);
                    DOM_REFS.requiredDepartureTime.style.color = dangerColor;
                }
            } else if (isMorning && !targetArrival) {
                safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
                safeSet(DOM_REFS.departureNote, 'No required departure time (non-work or past arrival target).');
                DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
            }
        ¬† });
        }


        /* -------------------------------------------
        ¬† ¬†Transit: RTD Scheduled Countdown 
        ¬† ¬†------------------------------------------- */

        function getRTDScheduleForToday() {
            const now = new Date();
            const day = now.getDay(); 
            const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            
            let key = (day >= 1 && day <= 4) ? 'MT' : (day === 5) ? 'F' : (day === 6) ? 'SAT' : 'SUN';
            
            safeSet(DOM_REFS.currentDayScheduleSummary, `${dayNames[day]} Schedule is Active. Trains run every 30 minutes.`);
            
            return CONFIG.RTD_SCHEDULES[key];
        }

        function formatCountdown(targetTime) {
            const diffMs = targetTime.getTime() - new Date().getTime();
            const diffSeconds = Math.floor(diffMs / 1000);
            
            const DEPARTED_GRACE_MS = -7000;
            const DEPARTURE_START_MS = 15000;
            const TRAIN_ARRIVING_END_MS = (14 * 60 * 1000) + 45000; 
            const TRAIN_ARRIVING_START_MS = 15 * 60 * 1000;

            if (diffMs <= DEPARTED_GRACE_MS) return { text: "Departed", class: 'schedule-countdown' };
            if (diffMs <= DEPARTURE_START_MS && diffMs > DEPARTED_GRACE_MS) return { text: "Departure", class: 'schedule-departing' };
            if (diffMs > TRAIN_ARRIVING_END_MS && diffMs <= TRAIN_ARRIVING_START_MS) return { text: "Train Arriving", class: 'schedule-arriving' };
            
            // CRITICAL LOGIC: If less than 5 minutes (300 seconds)
            if (diffSeconds > DEPARTURE_START_MS/1000 && diffSeconds <= CONFIG.CRITICAL_TRANSIT_SECONDS) {
                 return { text: `in ${diffSeconds}s`, class: 'schedule-critical' };
            }
            
            const minutes = Math.floor(diffSeconds / 60);
            const seconds = diffSeconds % 60;
            
            const text = (minutes < 1 && diffSeconds > DEPARTURE_START_MS / 1000) ? `${diffSeconds}s` : `${minutes}m ${seconds}s`;
            return { text: `in ${text}`, class: 'schedule-countdown' };
        }

        function getServiceDates(schedule, direction) {
            const now = new Date();
            const day = now.getDay();
            const start = schedule[direction === 'nb' ? 'start_nb' : 'start_sb'];
            const end = schedule[direction === 'nb' ? 'end_nb' : 'end_sb'];

            return {
                startOfDay: new Date(now.getFullYear(), now.getMonth(), now.getDate(), start.h, start.m, 0),
                endOfDay: new Date(now.getFullYear(), now.getMonth(), now.getDate(), end.h, end.m, 0)
            };
        }

        function getNextThreeDepartures(scheduledMinutes, schedule, direction) {
            const now = new Date();
            let departures = [];
            const { startOfDay, endOfDay } = getServiceDates(schedule, direction);

            if (now.getTime() < startOfDay.getTime() || now.getTime() > endOfDay.getTime() + 60000) {
                 return { departures: [], nextStart: startOfDay };
            }

            for (let i = 0; i < 3; i++) {
                const hourToCheck = now.getHours() + i;
                
                scheduledMinutes.forEach(targetMinute => {
                    let departure = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hourToCheck, targetMinute, 0);
                    
                    if (departure.getTime() >= now.getTime() - 7000 && departure.getTime() <= endOfDay.getTime()) { 
                        departures.push(departure);
                    }
                });
            }
            
            return {
                departures: departures.sort((a, b) => a.getTime() - b.getTime()).slice(0, CONFIG.MAX_PREDICTIONS),
                nextStart: startOfDay
            };
        }

        function updateTransit() {
            const schedule = getRTDScheduleForToday();
            
            if (!schedule) {
                safeSet(DOM_REFS.sbWindowEl, 'No Scheduled Service.');
                safeSet(DOM_REFS.nbWindowEl, 'No Scheduled Service.');
                safeSet(DOM_REFS.sbPredictionsContainer, `<div class="schedule-no-service">No RTD Schedule Found for Today.</div>`, true);
                safeSet(DOM_REFS.nbPredictionsContainer, `<div class="schedule-no-service">No RTD Schedule Found for Today.</div>`, true);
                return;
            }

            // Update Service Window Displays
            const formatWindow = (start, end) => `Service Window: ${formatTime(start)} - ${formatTime(end)}`;
            const { startOfDay: nbStart, endOfDay: nbEnd } = getServiceDates(schedule, 'nb');
            safeSet(DOM_REFS.nbWindowEl, formatWindow(nbStart, nbEnd));
            const { startOfDay: sbStart, endOfDay: sbEnd } = getServiceDates(schedule, 'sb');
            safeSet(DOM_REFS.sbWindowEl, formatWindow(sbStart, sbEnd));


            // Render Predictions
            const renderPredictions = (container, scheduledMinutes, direction, mapBtn) => {
                const { departures, nextStart } = getNextThreeDepartures(scheduledMinutes, schedule, direction);
                
                // Map link setup (hidden links are still required to set the URL for the single button)
                const origin = direction === 'sb' ? CONFIG.N_ORIGIN : CONFIG.N_DEST;
                const destination = direction === 'sb' ? CONFIG.N_DEST : CONFIG.N_ORIGIN;
                mapBtn.href = `https://www.google.com/maps/dir/${encodeURIComponent(origin)}/${encodeURIComponent(destination)}/@40.0, -105.0,11z/data=!4m2!4m1!3e3`;

                if (departures.length === 0) {
                    const message = (nextStart.getTime() > new Date().getTime()) ? `Service begins at ${formatTime(nextStart)}.` : `Service has ended for today.`;
                    safeSet(container, `<div class="schedule-no-service">${message}</div>`, true);
                    return;
                }

                let html = '';
                departures.forEach((departureTime, index) => {
                    const { text: countdownText, class: countdownElementClass } = formatCountdown(departureTime);
                    
                    html += `
                        <div class="prediction-item ${index === 0 ? 'next-up' : ''}">
                            <span class="schedule-time">${formatTimeShort(departureTime)}</span>
                            <span class="${countdownElementClass}">${countdownText}</span>
                        </div>
                    `;
                });
                safeSet(container, html, true);
            };

            renderPredictions(DOM_REFS.sbPredictionsContainer, schedule.sbMinutes, 'sb', DOM_REFS.sbMapBtn);
            renderPredictions(DOM_REFS.nbPredictionsContainer, schedule.nbMinutes, 'nb', DOM_REFS.nbMapBtn);
        }

        /**
         * Updates the displayed countdowns for transit every second by targeting their rendered content.
         */
        function updateTransitDisplay() {
            // Check if containers exist and have children (meaning data has been rendered at least once)
            ['sb-predictions', 'nb-predictions'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container || !container.children.length) return;

                // Iterate over each prediction item in the container's children
                Array.from(container.children).forEach((item) => {
                    const timeSpan = item.querySelector('.schedule-time');
                    // Look for any of the possible countdown classes
                    const countdownEl = item.querySelector('.schedule-countdown, .schedule-departing, .schedule-critical, .schedule-arriving');
                    
                    if (!countdownEl || !timeSpan) return;

                    // Extract the time string, then parse it for today
                    const timeStr = timeSpan.textContent.match(/(\d{1,2}:\d{2} (?:AM|PM))/);
                    if (!timeStr) return; 

                    // This is a robust way to get a Date object for today based on the displayed time string
                    const now = new Date();
                    const dateStr = now.toDateString();
                    const targetTime = new Date(`${dateStr} ${timeStr[0]}`);

                    // Handle wrap-around midnight if necessary
                    if (targetTime.getTime() < now.getTime() - (15 * 60 * 1000)) { // 15 min tolerance for departed trains
                         targetTime.setDate(targetTime.getDate() + 1);
                    }

                    const { text: countdownText, class: countdownElementClass } = formatCountdown(targetTime);
                    
                    // Update the text and class name dynamically
                    safeSet(countdownEl, countdownText);
                    countdownEl.className = countdownElementClass; // Update class for color change/animation
                });
            });
        }


        function renderAlerts() {
            if (CONFIG.ALERTS.length === 0) {
                DOM_REFS.alertsCard.style.display = 'none'; 
                return;
            }

            DOM_REFS.alertsCard.style.display = 'block';

            let alertsHtml = '';
            
            CONFIG.ALERTS.forEach(alert => {
                const icon = (alert.type === 'DELAY') ? '‚è≥' : (alert.type === 'ADVISORY') ? 'üì¢' : '‚ÑπÔ∏è';
                alertsHtml += `<div class="alert-item"><span class="alert-icon">${icon}</span><span><strong>${alert.type}:</strong> ${alert.message}</span></div>`;
            });
            
            safeSet(DOM_REFS.alertsContent, alertsHtml, true);
        }
        
        /* -------------------------
        ¬† ¬†Collapsible Logic
        ¬† ¬†------------------------- */

        function toggleCollapse(cardId) {
            const card = document.getElementById(cardId);
            const icon = card.querySelector(`.collapsible-icon[data-target="${cardId}"]`);
            
            if (!card || !icon) return;

            const isCollapsed = card.getAttribute('data-collapsed') === 'true';
            const newCollapsedState = !isCollapsed;

            card.setAttribute('data-collapsed', newCollapsedState);
            icon.textContent = newCollapsedState ? '‚ñ∂' : '‚ñº';
        }


        /* -------------------------
        ¬† ¬†Full refresh Handlers
        ¬† ¬†------------------------- */
        function refreshTrafficAndSchedule() {
        ¬† ¬† const targetArrival = getScheduleForToday();

        ¬† ¬† if (directionsService) {
                updateDrive(CONFIG.HOME_ADDR, CONFIG.WORK_ADDR, DOM_REFS.driveToWorkETA, DOM_REFS.driveToWorkNormal, DOM_REFS.driveToWorkFill, DOM_REFS.driveToWorkNote, targetArrival, true);
                updateDrive(CONFIG.WORK_ADDR, CONFIG.HOME_ADDR, DOM_REFS.driveToHomeETA, DOM_REFS.driveToHomeNormal, DOM_REFS.driveToHomeFill, DOM_REFS.driveToHomeNote, null, false);
            }
            
            updateTransit(); // Also run full transit update

            // Map Link Update Logic for Buttons
            const avoidParam = DOM_REFS.avoidCheckbox.checked ? '&avoid=highways' : '';
            const driveMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(CONFIG.HOME_ADDR)}&destination=${encodeURIComponent(CONFIG.WORK_ADDR)}&travelmode=driving${avoidParam}`;
            const transitMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(CONFIG.N_ORIGIN)}&destination=${encodeURIComponent(CONFIG.WORK_ADDR)}&travelmode=transit`;
            
            // Hidden link used for drive link in the drive card to maintain old logic
            DOM_REFS.openWorkBtn.href = driveMapUrl;

            // Button actions
            DOM_REFS.openWorkMapBtn.onclick = () => window.open(driveMapUrl, '_blank'); // Work Schedule Button
            DOM_REFS.driveToWorkBtn.onclick = () => window.open(driveMapUrl, '_blank'); // Drive Card Button
            DOM_REFS.transitMapBtn.onclick = () => window.open(transitMapUrl, '_blank'); // Transit Card Button
        }

        function initialAndStaticLoad() {
            setDayTime();
        ¬† ¬† loadWeather();
        ¬† ¬† renderAlerts();
            updateRgbVariables(); // Ensure theme colors are set at startup
        }


        /* -------------------------
        ¬† ¬†Events & Intervals
        ¬† ¬†------------------------- */

        function updateRgbVariables() {
            const isDark = document.body.classList.contains('dark');
            // These lines correctly set the :root-level color variables (`--*-rgb`)
            const accent = isDark ? '#60a5fa' : '#3b82f6'; 
            const text = isDark ? '#e5e7eb' : '#1a1a1a';
            const warn = isDark ? '#fbbf24' : '#f59e0b';

            function hexToRgb(hex) {
                const bigint = parseInt(hex.replace('#', ''), 16);
                return `${(bigint >> 16) & 255}, ${(bigint >> 8) & 255}, ${bigint & 255}`;
            }

            document.documentElement.style.setProperty('--accent-rgb', hexToRgb(accent));
            document.documentElement.style.setProperty('--text-rgb', hexToRgb(text));
            document.documentElement.style.setProperty('--warn-rgb', hexToRgb(warn));
        }

        function setupEventsAndIntervals() {
            // Event Listeners
            DOM_REFS.refreshBtn.addEventListener('click', () => {
                initialAndStaticLoad();
                refreshTrafficAndSchedule();
            });

            DOM_REFS.themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                updateRgbVariables();
            });

            DOM_REFS.avoidCheckbox.addEventListener('change', refreshTrafficAndSchedule);
            
            // Collapsible Event Listeners - ATTACHED DIRECTLY TO HEADERS
            DOM_REFS.driveHeader.addEventListener('click', (e) => {
                // Ignore clicks that land directly on the icons/text inside the header group
                if (e.target.closest('.card-icon') || e.target.closest('.card-title-text')) return;
                toggleCollapse('driveTimesCard');
            });
            DOM_REFS.transitHeader.addEventListener('click', (e) => {
                // Ignore clicks that land directly on the icons/text inside the header group
                if (e.target.closest('.card-icon') || e.target.closest('.card-title-text')) return;
                toggleCollapse('transitCard');
            });
            
            // Note: Alerts header uses a different class but we still attach to the element
            DOM_REFS.alertsHeader.addEventListener('click', () => toggleCollapse('alerts-card')); 


            // Intervals
            setInterval(setDayTime, 1000); 
            setInterval(updateTransitDisplay, 1000); // Fast countdown update
            setInterval(updateTransit, 3 * 60 * 1000); // Full transit schedule re-render
            setInterval(loadWeather, 10 * 60 * 1000);
        }

        function startTrafficInterval() {
            // Run full traffic update less frequently than transit
            traffic_interval = setInterval(refreshTrafficAndSchedule, 3 * 60 * 1000);
        }

        /* -------------------------
        ¬† ¬†Google Maps Initialization
        ¬† ¬†------------------------- */
        function initMaps(){
        ¬† directionsService = new google.maps.DirectionsService();
        ¬† 
            refreshTrafficAndSchedule();
            startTrafficInterval();
        }

        (function loadMaps(){
        ¬† ¬† const s = document.createElement('script');
        ¬† ¬† s.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMaps`;
        ¬† ¬† s.async = true;
        ¬† ¬† s.defer = true;
        ¬† ¬† s.setAttribute('loading', 'async');
        ¬† ¬† window.initMaps = initMaps;
        ¬† ¬† document.head.appendChild(s);
        })();

        /* Initial load and setup */
        // Run initial load functions and setup event listeners.
        initialAndStaticLoad();
        setupEventsAndIntervals();
    </script>
</body>
</html>
