<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commute Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* UPDATED CSS STYLES - RTD Blue Theme */
        :root{
            --bg:#f9f9fc; /* Soft white background */
            --text:#0b1220; 
            --card:#ffffff; 
            --muted:#6b7280; 
            --accent:#004792; /* Deep RTD Blue */
            --success:#10b981; 
            --warn:#f59e0b; 
            --danger:#ef4444; 
            --shadow:0 10px 30px rgba(6,12,34,0.08);
        }
        body.dark{
            --bg:#071126; 
            --text:#e6eef8; 
            --card:#0f1724; 
            --muted:#9aa6b2; 
            --accent:#4a86e8; /* Lighter Blue for contrast in dark mode */
            --shadow:0 12px 36px rgba(0,0,0,0.6);
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
        .app{max-width:820px;margin:20px auto;padding:18px;display:flex;flex-direction:column;gap:18px}
        .header{display:flex;justify-content:space-between;align-items:center}
        .title{font-size:22px;font-weight:800;margin:0}
        .sub{color:var(--muted);font-size:13px}
        .controls{display:flex;gap:8px;align-items:center}
        .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--shadow); transition: background 0.3s;}
        .btn:hover{filter: brightness(1.1);}
        .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
        body.dark .btn.ghost{border-color: rgba(255,255,255,0.1);}
        .grid{display:grid;gap:16px}
        .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px}
        .row{display:flex;align-items:center;gap:12px}
        .left-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff}
        .weather-icon{background:linear-gradient(135deg,#ffd166,#ff9a66);color:#111}
        .commute-icon{background:linear-gradient(135deg,#60a5fa,#4f46e5)}
        .title-sm{font-weight:700}
        .metric-large{font-weight:900;font-size:24px} 
        .schedule-metric{font-weight:900;font-size:32px; color: var(--accent);} /* Extra large for leave time */
        .small-muted{color:var(--muted);font-size:13px}
        .direction-row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1;min-width:220px;background:rgba(0,0,0,0.02);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:10px}
        body.dark .col{background:rgba(255,255,255,0.03);}
        .progress-bar{height:8px;background:rgba(0,0,0,0.06);border-radius:8px;overflow:hidden}
        .progress-fill{height:100%;width:0%;background:var(--success);transition:width .5s linear,background .3s}
        .transit-large{font-size:36px;font-weight:800;text-align:center;margin:6px 0;color:var(--accent)}
        .transit-details{display:flex;justify-content:space-between;font-weight:700}
        .link-btn{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);text-decoration:none;font-weight:700;font-size:13px;text-align:center; transition: border-color 0.3s;}
        .link-btn:hover{border-color: var(--accent); color: var(--accent);}
        body.dark .link-btn{border-color: rgba(255,255,255,0.1);}
        .footer{color:var(--muted);text-align:center;font-size:13px;margin-top:6px}
        .note{font-size:12px;color:var(--muted)}

        /* Directional Accent Bars */
        .col-accent-sb { border-left: 4px solid var(--accent); } /* Deep Blue */
        .col-accent-nb { border-left: 4px solid var(--warn); } /* Amber/Yellow */
        
        /* Next Train List Styling */
        .next-schedules-list { 
            font-size: 14px; 
            margin-top: 10px; 
            padding-top: 5px; 
            border-top: 1px solid rgba(0,0,0,0.1); 
            display: flex; 
            flex-wrap: wrap;
            color: var(--muted);
        }
        body.dark .next-schedules-list {
            border-top-color: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

<div class="app">
    <header class="header">
        <div>
            <h1 class="title">Commute Dashboard</h1>
            <div class="sub" id="dayTime">Loadingâ€¦</div>
        </div>
        <div class="controls">
            <button id="refreshBtn" class="btn">Refresh Now</button>
            <button id="themeToggle" class="btn ghost">â˜€ï¸/ğŸŒ™</button>
        </div>
    </header>

    <main class="grid">
        
        <section class="card">
            <div class="row">
                <div class="left-icon commute-icon" style="background: linear-gradient(135deg, #ef4444, #f59e0b);">â°</div>
                <div style="flex:1">
                    <div class="title-sm">Today's Schedule</div>
                    <div class="metric-large" id="scheduleStatus">â€”</div>
                </div>
            </div>

            <div class="direction-row">
                <div class="col" style="flex: 2; min-width: 300px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <div class="title-sm">Required Drive Departure Time</div>
                        <div class="small-muted">Target Arrival: <span id="targetArrivalTime">â€”</span></div>
                    </div>
                    <div class="schedule-metric" id="requiredDepartureTime">â€”</div>
                    <div class="small-muted" id="departureNote">â€”</div>
                </div>

                <div class="col" style="flex: 1; min-width: 150px;">
                    <div class="title-sm">Current Time</div>
                    <div class="metric-large" id="currentTimeDisplay" style="font-weight: 700;">â€”</div>
                    <a id="openWorkBtn" class="link-btn" href="#" target="_blank" style="margin-top: auto;">Open Work Map</a>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="row">
                <div class="left-icon commute-icon">ğŸš—</div>
                <div style="flex:1">
                    <div class="title-sm">Live Traffic Conditions</div>
                    <div class="small-muted">Home â†” Work (presets)</div>
                </div>
                <div style="min-width:160px;text-align:right">
                    <label><input type="checkbox" id="avoidHighway"> Avoid Highways</label>
                </div>
            </div>

            <div class="direction-row">
                <div class="col">
                    <div style="display:flex;align-items:baseline;justify-content:space-between;">
                        <div style="display:flex;align-items:baseline;gap:8px;">
                            <div class="title-sm"><strong>To Work</strong></div>
                            <div class="metric-large" id="driveToWorkETA">Loadingâ€¦</div>
                        </div>
                        <div class="small-muted" id="driveToWorkNormal" style="font-size:14px;">(Normal: â€”)</div> 
                    </div>
                    <div class="progress-bar"><div id="driveToWorkFill" class="progress-fill" style="width:0%"></div></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1"></div>
                        <div class="small-muted" id="driveToWorkNote">Last updated: â€”</div>
                    </div>
                </div>

                <div class="col">
                    <div style="display:flex;align-items:baseline;justify-content:space-between;">
                        <div style="display:flex;align-items:baseline;gap:8px;">
                            <div class="title-sm"><strong>To Home</strong></div>
                            <div class="metric-large" id="driveToHomeETA">Loadingâ€¦</div>
                        </div>
                        <div class="small-muted" id="driveToHomeNormal" style="font-size:14px;">(Normal: â€”)</div>
                    </div>
                    <div class="progress-bar"><div id="driveToHomeFill" class="progress-fill" style="width:0%"></div></div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1"></div>
                        <div class="small-muted" id="driveToHomeNote">Last updated: â€”</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="row">
                <div class="left-icon commute-icon">ğŸš‰</div>
                <div style="flex:1">
                    <div class="title-sm">Transit â€” N Line (Scheduled Countdown)</div>
                    <div class="small-muted">112th & Northglenn Station â†” Denver Union Station</div>
                </div>
            </div>

            <div class="direction-row">
                <div class="col col-accent-sb" id="sbCol">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Southbound (To Denver)</strong></div>
                        <a id="sbMapBtn" class="link-btn" href="#" target="_blank">Open Map</a>
                    </div>
                    <div class="transit-large" id="sbCountdown">â€”</div>
                    <div class="transit-details">
                        <div id="sbDep">Depart â€”</div>
                        <div id="sbArr">Arrive â€”</div>
                        <div id="sbDur">â€”</div>
                    </div>
                    <div class="next-schedules-list">
                        <span style="font-weight:700; color: var(--text); padding-right: 5px;">Next:</span> 
                        <span id="sbNextTimes" class="small-muted">â€”</span>
                    </div>
                </div>

                <div class="col col-accent-nb" id="nbCol">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Northbound (To Northglenn)</strong></div>
                        <a id="nbMapBtn" class="link-btn" href="#" target="_blank">Open Map</a>
                    </div>
                    <div class="transit-large" id="nbCountdown">â€”</div>
                    <div class="transit-details">
                        <div id="nbDep">Depart â€”</div>
                        <div id="nbArr">Arrive â€”</div>
                        <div id="nbDur">â€”</div>
                    </div>
                    <div class="next-schedules-list">
                        <span style="font-weight:700; color: var(--text); padding-right: 5px;">Next:</span> 
                        <span id="nbNextTimes" class="small-muted">â€”</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="row">
                <div class="left-icon weather-icon">â˜€ï¸</div>
                <div style="flex:1">
                    <div class="title-sm">Current Weather (Denver)</div>
                    <div class="metric-large" id="weatherTemp">â€”</div>
                </div>
                <div style="text-align:right">
                    <div id="weatherDesc" class="title-sm">â€”</div>
                    <div class="small-muted" id="weatherFeels">â€”</div>
                    <div class="small-muted" id="weatherWind">â€”</div>
                    <div class="small-muted" id="weatherHumidity">â€”</div>
                </div>
                <div id="weatherIcon"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>Data from OpenWeatherMap and Google Maps Directions Service (Schedules only).</p>
    </footer>
</div>

<script>
/* -------------------------
Â  Â API KEYS (your keys)
Â  Â ------------------------- */
// NOTE: Replace these placeholders with your actual keys
const OPENWEATHER_API_KEY = '1c91f81f2adfd1b633d19842869a1a11';
const GOOGLE_MAPS_API_KEYÂ  = 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY';

/* Preset addresses/stations (Google-friendly strings) */
const HOME_ADDR = '11625 Community Center Drive, Northglenn, CO 80233';
const WORK_ADDR = '707 17th Street, Denver, CO 80202';
const N_ORIGINÂ  = '112th & Northglenn Station, Northglenn, CO';
const N_DESTÂ  Â  = 'Denver Union Station, Denver, CO';

// Drive Time Constants
const BASELINE_DRIVE_MINS = 25; 
const ARRIVAL_BUFFER_MINS = 30; // Arrive 30 minutes before work starts

// Define Weekly Work Schedule (military time string 'HH:MM')
// Day: 0=Sunday, 1=Monday... 6=Saturday
const WORK_SCHEDULE = {
    1: { start: '08:00', end: '17:30' }, // Monday
    2: { start: '08:00', end: '17:30' }, // Tuesday
    3: { start: '08:00', end: '17:30' }, // Wednesday
    4: { start: '08:00', end: '17:30' }, // Thursday
    5: { start: '08:00', end: '16:30' }, // Friday
    0: null, // Sunday
    6: null  // Saturday
};

/* -------------------------
Â  Â DOM refs (ALL DEFINITIONS ARE HERE)
    --- FIX: All elements must be linked via document.getElementById() ---
Â  Â ------------------------- */
const dayTimeEl = document.getElementById('dayTime');
const currentTimeDisplay = document.getElementById('currentTimeDisplay');
const scheduleStatus = document.getElementById('scheduleStatus');
const targetArrivalTime = document.getElementById('targetArrivalTime');
const requiredDepartureTime = document.getElementById('requiredDepartureTime');
const departureNote = document.getElementById('departureNote');
const openWorkBtn = document.getElementById('openWorkBtn');

// Weather Refs
const weatherTempEl = document.getElementById('weatherTemp');
const weatherDescEl = document.getElementById('weatherDesc');
const weatherIconEl = document.getElementById('weatherIcon');
const weatherFeelsEl = document.getElementById('weatherFeels');
const weatherWindEl = document.getElementById('weatherWind');
const weatherHumidityEl = document.getElementById('weatherHumidity');

// Drive Time Refs
const driveToWorkETA = document.getElementById('driveToWorkETA');
const driveToWorkNormal = document.getElementById('driveToWorkNormal');
const driveToHomeETA = document.getElementById('driveToHomeETA');
const driveToHomeNormal = document.getElementById('driveToHomeNormal');
const driveToWorkFill = document.getElementById('driveToWorkFill');
const driveToHomeFill = document.getElementById('driveToHomeFill');
const driveToWorkNote = document.getElementById('driveToWorkNote');
const driveToHomeNote = document.getElementById('driveToHomeNote');
const avoidCheckbox = document.getElementById('avoidHighway');

// Transit Refs
const sbCountdownEl = document.getElementById('sbCountdown');
const sbDepEl = document.getElementById('sbDep');
const sbArrEl = document.getElementById('sbArr');
const sbDurEl = document.getElementById('sbDur');
const sbMapBtn = document.getElementById('sbMapBtn');
const nbCountdownEl = document.getElementById('nbCountdown');
const nbDepEl = document.getElementById('nbDep');
const nbArrEl = document.getElementById('nbArr');
const nbDurEl = document.getElementById('nbDur');
const nbMapBtn = document.getElementById('nbMapBtn');
const sbNextTimes = document.getElementById('sbNextTimes');
const nbNextTimes = document.getElementById('nbNextTimes');


let directionsService = null;

/* helpers */
function safeSet(el,txt){ if(el) el.textContent = txt ?? 'â€”'; }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function clearIv(iv){ if(iv) clearInterval(iv); }

function setDayTime(){ 
    const now=new Date(); 
    const h=now.getHours(); 
    let part='Morning'; 
    if(h>=12 && h<17) part='Afternoon'; 
    else if(h>=17) part='Evening'; 
    dayTimeEl.textContent = `${now.toLocaleDateString(undefined,{weekday:'long'})}, ${part}`; 
    currentTimeDisplay.textContent = formatTime(now); // Update current time display
}

/* -------------------------
Â  Â Weather (OpenWeather)
Â  Â ------------------------- */
async function loadWeather(){
Â  try{
Â  Â  const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Denver,US&units=imperial&appid=${OPENWEATHER_API_KEY}`);
Â  Â  if(!res.ok) throw new Error('weather fetch failed');
Â  Â  const d = await res.json();
Â  Â  safeSet(weatherTempEl, Math.round(d.main.temp) + 'Â°F');
Â  Â  const desc = d.weather?.[0]?.description ?? '';
Â  Â  safeSet(weatherDescEl, desc ? (desc[0].toUpperCase()+desc.slice(1)) : 'â€”');
Â  Â  safeSet(weatherFeelsEl, 'Feels: ' + Math.round(d.main.feels_like) + 'Â°F');
Â  Â  safeSet(weatherWindEl, 'Wind: ' + Math.round(d.wind.speed) + ' mph');
Â  Â  safeSet(weatherHumidityEl, 'Humidity: ' + d.main.humidity + '%');
Â  Â  if(d.weather?.[0]?.icon){
Â  Â  Â  weatherIconEl.innerHTML = '';
Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  img.src = `https://openweathermap.org/img/wn/${d.weather[0].icon}@2x.png`;
Â  Â  Â  img.alt = desc;
Â  Â  Â  img.style.width='48px'; img.style.height='48px'; img.style.borderRadius='8px';
Â  Â  Â  weatherIconEl.appendChild(img);
Â  Â  }
Â  }catch(err){ console.error(err); safeSet(weatherTempEl,'Error'); }
}

/* -------------------------
Â  Â Schedule Logic
Â  Â ------------------------- */

function getScheduleForToday() {
    const now = new Date();
    const day = now.getDay(); // 0 (Sunday) to 6 (Saturday)
    const schedule = WORK_SCHEDULE[day];
    
    if (!schedule) {
        safeSet(scheduleStatus, 'Non-Work Day');
        return null;
    }
    
    // Parse work start time (e.g., '08:00')
    const [h, m] = schedule.start.split(':').map(Number);
    const targetArrival = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m - ARRIVAL_BUFFER_MINS, 0);

    // If target arrival time has passed (plus 30 min grace period), don't show departure guidance
    const currentTime = now.getTime();
    if (currentTime > targetArrival.getTime() + (30 * 60 * 1000)) { 
        safeSet(scheduleStatus, `Work: ${schedule.start} - ${schedule.end}`); // Still show schedule, but mark as in progress
        safeSet(targetArrivalTime, formatTime(targetArrival));
        return null; // Return null to signal no active target
    }

    safeSet(scheduleStatus, `Work: ${schedule.start} - ${schedule.end}`);
    safeSet(targetArrivalTime, formatTime(targetArrival));
    
    return targetArrival;
}


/* -------------------------
Â  Â Drive (DirectionsService)
Â  Â ------------------------- */
function updateDrive(origin,destination,etaEl,normalEl,fillEl,noteEl,targetArrival){
Â  if(!directionsService){ safeSet(etaEl,'Maps not ready'); return; }
Â  safeSet(etaEl,'Calculatingâ€¦');
Â  safeSet(normalEl, `(Normal: ${BASELINE_DRIVE_MINS} mins)`);
Â  fillEl.style.width='0%';
Â  
Â  directionsService.route({
Â  Â  origin, destination,
Â  Â  travelMode: google.maps.TravelMode.DRIVING,
Â  Â  drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' },
Â  Â  avoidHighways: !!avoidCheckbox.checked
Â  }, (result, status) => { 
Â  Â  if(status !== google.maps.DirectionsStatus.OK || !result.routes.length){ 
Â  Â  Â  console.error('Drive error', status, result); 
Â  Â  Â  safeSet(etaEl,'Error: No Route Found'); 
      fillEl.style.width = '100%';
      fillEl.style.background = 'var(--muted)';
Â  Â  Â  return; 
Â  Â  }
Â  Â  
Â  Â  const leg = result.routes[0].legs[0];
Â  Â  // Duration in seconds -> minutes
Â  Â  const mins = (leg.duration_in_traffic?.value || leg.duration?.value)/60;
    
    // --- Traffic Delay Delta Calculation ---
    const delayMins = Math.round(mins - BASELINE_DRIVE_MINS);
    let delayText = '';

    if (delayMins > 0) {
        delayText = ` (+${delayMins} min delay)`;
    } else if (delayMins < 0) {
        delayText = ` (${Math.abs(delayMins)} min faster)`;
    } else {
        delayText = ` (On schedule)`;
    }
    
Â  Â  safeSet(etaEl, (leg.duration_in_traffic?.text || leg.duration?.text || 'N/A') + delayText);
Â  Â  
Â  Â  // Progress bar color/width logic
Â  Â  const pct = Math.min(Math.round((mins / BASELINE_DRIVE_MINS) * 100), 100);
Â  Â  fillEl.style.width = pct + '%';
Â  Â  
Â  Â  if(mins <= BASELINE_DRIVE_MINS + 5) fillEl.style.background = 'var(--success)';
Â  Â  else if(mins <= BASELINE_DRIVE_MINS + 15) fillEl.style.background = 'var(--warn)';
Â  Â  else fillEl.style.background = 'var(--danger)';
Â  Â  
Â  Â  if(noteEl) noteEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();

    // --- Schedule Card Integration ---
    if (targetArrival && destination === WORK_ADDR) {
        // Calculate the required departure time: Target Arrival - Travel Duration (in milliseconds)
        const requiredDepartureMs = targetArrival.getTime() - (mins * 60 * 1000);
        const requiredDeparture = new Date(requiredDepartureMs);
        const now = new Date();
        const diffMs = requiredDeparture.getTime() - now.getTime();
        const diffMins = Math.ceil(diffMs / 60000);

        safeSet(requiredDepartureTime, formatTime(requiredDeparture));

        if (diffMins > 30) {
            safeSet(departureNote, `You have ${diffMins} minutes until you must leave.`);
            requiredDepartureTime.style.color = 'var(--accent)';
        } else if (diffMins > 0) {
            safeSet(departureNote, `You MUST leave in ${diffMins} minutes to arrive on time!`);
            requiredDepartureTime.style.color = 'var(--warn)';
        } else {
            safeSet(departureNote, `ğŸ”´ Leave IMMEDIATELY or you will be late.`);
            requiredDepartureTime.style.color = 'var(--danger)';
        }
    } else if (destination === WORK_ADDR) {
        // Not a work day or target missed
        safeSet(requiredDepartureTime, 'N/A');
        safeSet(departureNote, 'No required departure time (non-work or past arrival target).');
        requiredDepartureTime.style.color = 'var(--muted)';
    }
Â  });
}

/* -------------------------
Â  Â Transit: next-N-train finder
Â  Â ------------------------- */

// Auto-refresh countdown function
function startCountdown(date, displayEl, direction){
Â  if (displayEl._iv) clearInterval(displayEl._iv);

Â  function tick(){
Â  Â  const diff = date - new Date();
Â  Â  const mm = Math.floor(diff/60000);
Â  Â  const ss = Math.floor((diff%60000)/1000);
Â  Â  
Â  Â  if(diff <= 0){
Â  Â  Â  displayEl.textContent = 'Departing now';
Â  Â  Â  clearInterval(displayEl._iv);
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  updateNextTrain(direction);
Â  Â  Â  }, 5000); // 5 seconds wait before refreshing
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const mmStr = mm < 10 ? '0'+mm : ''+mm;
Â  Â  const ssStr = ss < 10 ? '0'+ss : ''+ss;
Â  Â  displayEl.textContent = `${mmStr}:${ssStr}`;
Â  }
Â  
Â  tick();
Â  displayEl._iv = setInterval(tick, 1000);
}

// Function to find the top 3 scheduled candidates (array)
async function findNextNTrain(origin, destination, direction){
Â  if(!directionsService) return null;
Â  return new Promise((resolve) => {
Â  Â  directionsService.route({
Â  Â  Â  origin,
Â  Â  Â  destination,
Â  Â  Â  travelMode: google.maps.TravelMode.TRANSIT,
Â  Â  Â  transitOptions: { 
Â  Â  Â  Â  modes: [google.maps.TransitMode.RAIL], 
        // FIX: Using the correct API constant for routing preference
Â  Â  Â  Â  routingPreference: google.maps.TransitRoutePreference.LESS_TRANSFERS 
Â  Â  Â  }, 
Â  Â  Â  provideRouteAlternatives: true
Â  Â  }, (result, status) => { 
Â  Â  Â  if(status !== google.maps.DirectionsStatus.OK || !result?.routes?.length){ 
Â  Â  Â  Â  console.error('findNextNTrain error STATUS:', status, 'RESULT:', result);
Â  Â  Â  Â  resolve(null); 
Â  Â  Â  Â  return; 
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  const now = new Date();
Â  Â  Â  const candidates = [];
Â  Â  Â  
Â  Â  Â  result.routes.forEach(route => {
Â  Â  Â  Â  const leg = route.legs && route.legs[0];
Â  Â  Â  Â  if(!leg) return;
Â  Â  Â  Â  const steps = leg.steps || [];
Â  Â  Â  Â  steps.forEach(step => {
Â  Â  Â  Â  Â  if(!step.transit || !step.transit.line) return;
Â  Â  Â  Â  Â  const shortName = (step.transit.line.short_name || '').toString();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if(shortName.toUpperCase() !== 'N') return;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const depTime = step.transit.departure_time && step.transit.departure_time.value;
Â  Â  Â  Â  Â  const arrTime = step.transit.arrival_time && step.transit.arrival_time.value;

Â  Â  Â  Â  Â  if(!depTime) return;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const depDate = new Date(depTime);
Â  Â  Â  Â  Â  const arrDate = arrTime ? new Date(arrTime) : new Date(depDate.getTime() + (step.duration?.value ? step.duration.value * 1000 : 25 * 60000));
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if(depDate <= now) return;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  candidates.push({dep: depDate, arr: arrDate, headsign: step.transit.headsign || step.transit.line.name});
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  if(!candidates.length){ resolve(null); return; }
Â  Â  Â  
Â  Â  Â  candidates.sort((a,b)=>a.dep - b.dep);
Â  Â  Â  resolve(candidates.slice(0, 3)); 
Â  Â  });
Â  });
}

// Function to update the display for one direction (sb or nb)
async function updateNextTrain(direction){
Â  const origin = direction === 'sb' ? N_ORIGIN : N_DEST;
Â  const destination = direction === 'sb' ? N_DEST : N_ORIGIN;
Â  const countdownEl = direction === 'sb' ? sbCountdownEl : nbCountdownEl;
Â  const depEl = direction === 'sb' ? sbDepEl : nbDepEl;
Â  const arrEl = direction === 'sb' ? sbArrEl : nbArrEl;
Â  const durEl = direction === 'sb' ? sbDurEl : nbDurEl;
Â  const mapBtn = direction === 'sb' ? sbMapBtn : nbMapBtn;
Â  const nextTimesEl = direction === 'sb' ? sbNextTimes : nbNextTimes;

Â  if (countdownEl._iv) clearInterval(countdownEl._iv);

Â  safeSet(countdownEl, 'Searchingâ€¦');
Â  safeSet(depEl, 'Depart â€”');
Â  safeSet(arrEl, 'Arrive â€”');
Â  safeSet(durEl, 'â€”');
Â  safeSet(nextTimesEl, 'â€”');

Â  try{
Â  Â  const candidates = await findNextNTrain(origin, destination, direction); 
Â  Â  
Â  Â  if(!candidates || candidates.length === 0){
Â  Â  Â  safeSet(countdownEl,'No trains found');
Â  Â  Â  safeSet(nextTimesEl, 'No upcoming trains scheduled.');
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const candidate = candidates[0];
Â  Â  const dep = candidate.dep;
Â  Â  const arr = candidate.arr;
Â  Â  const durMin = Math.round((arr - dep)/60000);
Â  Â  
Â  Â  safeSet(depEl, 'Depart ' + formatTime(dep));
Â  Â  safeSet(arrEl, 'Arrive ' + formatTime(arr));
Â  Â  safeSet(durEl, durMin + ' min');
Â  Â  
Â  Â  if(mapBtn) {
Â  Â  Â  mapBtn.href = `https://www.google.com/maps/dir/${encodeURIComponent(origin)}/${encodeURIComponent(destination)}?api=1&travelmode=transit&transit_mode=rail`;
Â  Â  }
Â  Â  
Â  Â  startCountdown(dep, countdownEl, direction); 
Â  Â  
Â  Â  const nextDepartures = candidates.slice(1).map(c => formatTime(c.dep)).join(' â€¢ ');
Â  Â  
Â  Â  if (nextDepartures) {
Â  Â  Â  safeSet(nextTimesEl, nextDepartures);
Â  Â  } else {
Â  Â  Â  safeSet(nextTimesEl, 'No further immediate schedules.');
Â  Â  }
Â  Â  
Â  }catch(err){
Â  Â  console.error('updateNextTrain error', err);
Â  Â  safeSet(countdownEl, 'Error');
Â  Â  safeSet(nextTimesL, 'Error loading schedules.');
Â  }
}


/* -------------------------
Â  Â Full refresh
Â  Â ------------------------- */
function refreshAll(){
Â  setDayTime();
Â  loadWeather();
Â  
Â  // Get today's required arrival time
Â  const targetArrival = getScheduleForToday();

Â  // Update drive times, passing the new targetArrival time for the To Work calculation
Â  updateDrive(HOME_ADDR, WORK_ADDR, driveToWorkETA, driveToWorkNormal, driveToWorkFill, driveToWorkNote, targetArrival);
Â  // Homebound route does not need target time
Â  updateDrive(WORK_ADDR, HOME_ADDR, driveToHomeETA, driveToHomeNormal, driveToHomeFill, driveToHomeNote, null);
  
  // Set the map link for the schedule card
  const avoidParam = avoidCheckbox.checked ? '&avoid=highways' : '';
  openWorkBtn.href = `https://www.google.com/maps/dir/${encodeURIComponent(HOME_ADDR)}/${encodeURIComponent(WORK_ADDR)}?api=1&travelmode=driving${avoidParam}`;
Â  
Â  // transit: both directions
Â  updateNextTrain('sb');
Â  updateNextTrain('nb');
}

/* events & intervals */
document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('themeToggle').addEventListener('click', ()=>document.body.classList.toggle('dark'));
avoidCheckbox.addEventListener('change', ()=> refreshAll());

// Update time every second for the clock and to keep departure countdown accurate
setInterval(setDayTime, 1000); 
setInterval(loadWeather, 10*60*1000);
// Automatic traffic/schedule refresh every 3 minutes (more frequent for critical departure time)
setInterval(()=>{ if(directionsService) refreshAll(); }, 3*60*1000); 

/* initialize Google Maps JS and DirectionsService */
function initMaps(){
Â  directionsService = new google.maps.DirectionsService();
Â  refreshAll();
}
(function loadMaps(){
Â  const s = document.createElement('script');
Â  s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMaps`;
Â  s.async = true;
Â  s.defer = true;
Â  window.initMaps = initMaps;
Â  document.head.appendChild(s);
})();

/* initial load */
setDayTime();
loadWeather();
</script>

</body>
</html>
