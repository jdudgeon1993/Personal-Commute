<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Taskify Commute Dashboard - Real-time commute information">
  <meta name="theme-color" content="#1e293b">
  <title>Taskify || Commute Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    *:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    /**
     * Taskify Commute Dashboard - Redesigned
     *
     * FEATURES:
     * - Tab-based navigation (Drive Time, N Line, Today's Schedule, Search Locator)
     * - No time-based visibility sequences - everything always visible
     * - 15-minute unified refresh interval with manual refresh button
     * - Simplified greeting system (Good Morning/Evening, Workday/Weekend)
     * - Weather integration in header
     * - Clean, simple layout
     */

    const { useState, useEffect, useCallback, useMemo } = React;

    // Constants
    const CONSTANTS = {
      REFRESH_INTERVAL: 900000, // 15 minutes
      CLOCK_INTERVAL: 1000, // 1 second for clock
      TRANSIT_INTERVAL: 60000, // 1 minute for transit (needs more frequent updates)
      API_KEYS: {
        GOOGLE_MAPS: window.ENV?.GOOGLE_MAPS_API_KEY || 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY',
        OPENWEATHER: window.ENV?.OPENWEATHER_API_KEY || '1c91f81f2adfd1b633d19842869a1a11'
      }
    };

    const config = {
      locations: {
        home: { lat: 39.9066611, lng: -104.987454 },
        garage: { lat: 39.747676849365234, lng: -104.9898452758789 },
        work: { lat: 39.74645233154297, lng: -104.99141693115234 }
      },
      weather: {
        lat: 39.8858,
        lon: -104.9872
      },
      rtdStops: {
        southbound: '35254',
        northbound: '34668'
      }
    };

    const CommuteDashboard = () => {
      // State
      const [currentTime, setCurrentTime] = useState(new Date());
      const [activeTab, setActiveTab] = useState('drive'); // drive, nline, schedule, search
      const [weather, setWeather] = useState(null);
      const [driveData, setDriveData] = useState(null);
      const [transitDataSB, setTransitDataSB] = useState(null);
      const [transitDataNB, setTransitDataNB] = useState(null);
      const [todayTasks, setTodayTasks] = useState([]);
      const [todayEvents, setTodayEvents] = useState([]);
      const [searchFrom, setSearchFrom] = useState('');
      const [searchTo, setSearchTo] = useState('');
      const [searchResults, setSearchResults] = useState(null);
      const [avoidHighways, setAvoidHighways] = useState(false);
      const [isDarkMode, setIsDarkMode] = useState(() => {
        try {
          const saved = localStorage.getItem('darkMode');
          return saved !== null ? JSON.parse(saved) : true;
        } catch (e) {
          return true;
        }
      });
      const [loading, setLoading] = useState({
        weather: true,
        drive: true,
        transit: true,
        tasks: false,
        search: false
      });
      const [plannerToken, setPlannerToken] = useState(() => {
        try {
          return localStorage.getItem('plannerToken') || null;
        } catch (e) {
          return null;
        }
      });
      const [lastRefresh, setLastRefresh] = useState(new Date());

      // Save dark mode preference
      useEffect(() => {
        try {
          localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
        } catch (e) {
          console.error('Error saving darkMode:', e);
        }
      }, [isDarkMode]);

      // Greeting logic - simple time-based greeting
      const getGreeting = () => {
        const hour = currentTime.getHours();
        const day = currentTime.getDay();
        const isWeekend = day === 0 || day === 6;

        let timeGreeting = hour < 12 ? 'Good Morning' : 'Good Evening';
        let contextGreeting = isWeekend ? 'Enjoy your Weekend' : 'Have a great Workday';

        return { timeGreeting, contextGreeting, isWeekend };
      };

      const greeting = getGreeting();

      // Clock update (every second)
      useEffect(() => {
        const interval = setInterval(() => {
          setCurrentTime(new Date());
        }, CONSTANTS.CLOCK_INTERVAL);
        return () => clearInterval(interval);
      }, []);

      // Fetch weather
      const fetchWeather = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, weather: true }));
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${config.weather.lat}&lon=${config.weather.lon}&appid=${CONSTANTS.API_KEYS.OPENWEATHER}&units=imperial`
          );
          const data = await response.json();
          setWeather(data);
        } catch (error) {
          console.error('Weather error:', error);
          setWeather({
            main: { temp: 72, feels_like: 70, humidity: 50 },
            weather: [{ description: 'clear sky', icon: '01d' }],
            wind: { speed: 5 },
            _isFallback: true
          });
        } finally {
          setLoading(prev => ({ ...prev, weather: false }));
        }
      }, []);

      // Fetch drive times
      const fetchDriveTimes = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, drive: true }));
          const apiKey = CONSTANTS.API_KEYS.GOOGLE_MAPS;
          const routingPreference = avoidHighways ? 'TRAFFIC_AWARE_OPTIMAL' : 'TRAFFIC_AWARE';

          const morningRoute = {
            origin: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
            destination: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            travelMode: 'DRIVE',
            routingPreference: routingPreference,
            ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const eveningRoute = {
            origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            destination: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
            travelMode: 'DRIVE',
            routingPreference: routingPreference,
            ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const walkRoute = {
            origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            destination: { location: { latLng: { latitude: config.locations.work.lat, longitude: config.locations.work.lng }}},
            travelMode: 'WALK',
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const [morningRes, eveningRes, walkRes] = await Promise.all([
            fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(morningRoute)
            }),
            fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(eveningRoute)
            }),
            fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(walkRoute)
            })
          ]);

          const morningData = await morningRes.json();
          const eveningData = await eveningRes.json();
          const walkData = await walkRes.json();

          if (morningData.routes && morningData.routes.length > 0) {
            const morningDuration = parseInt(morningData.routes[0].duration.replace('s', ''));
            const morningDistance = morningData.routes[0].distanceMeters;
            const eveningDuration = parseInt(eveningData.routes[0].duration.replace('s', ''));
            const eveningDistance = eveningData.routes[0].distanceMeters;
            const walkDuration = parseInt(walkData.routes[0].duration.replace('s', ''));
            const walkDistance = walkData.routes[0].distanceMeters;

            setDriveData({
              morning: {
                duration: { text: `${Math.round(morningDuration / 60)} mins`, value: morningDuration },
                distance: { text: `${(morningDistance * 0.000621371).toFixed(1)} mi` }
              },
              evening: {
                duration: { text: `${Math.round(eveningDuration / 60)} mins`, value: eveningDuration },
                distance: { text: `${(eveningDistance * 0.000621371).toFixed(1)} mi` }
              },
              walk: {
                duration: { text: `${Math.round(walkDuration / 60)} mins`, value: walkDuration },
                distance: { text: `${(walkDistance * 0.000621371).toFixed(1)} mi` }
              }
            });
          } else {
            throw new Error('No routes returned');
          }
        } catch (error) {
          console.error('Drive time error:', error);
          setDriveData({
            morning: { duration: { text: '30 mins', value: 1800 }, distance: { text: '14.2 mi' }},
            evening: { duration: { text: '30 mins', value: 1800 }, distance: { text: '14.2 mi' }},
            walk: { duration: { text: '8 mins', value: 480 }, distance: { text: '0.4 mi' }},
            _isFallback: true
          });
        } finally {
          setLoading(prev => ({ ...prev, drive: false }));
        }
      }, [avoidHighways]);

      // Fetch transit data
      const fetchTransitData = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, transit: true }));
          const apiEndpoint = 'https://rtd-n-line-api.onrender.com/api/rtd/arrivals';

          const [sbResponse, nbResponse] = await Promise.all([
            fetch(`${apiEndpoint}/${config.rtdStops.southbound}?t=${Date.now()}`, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache',
              headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
              signal: AbortSignal.timeout(30000)
            }),
            fetch(`${apiEndpoint}/${config.rtdStops.northbound}?t=${Date.now()}`, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache',
              headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
              signal: AbortSignal.timeout(30000)
            })
          ]);

          const sbData = await sbResponse.json();
          const nbData = await nbResponse.json();

          // Process southbound
          let sbTrains = [];
          if (sbData.arrivals && Array.isArray(sbData.arrivals) && sbData.arrivals.length > 0) {
            const filteredSB = sbData.arrivals.filter(arrival => {
              const isNLine = arrival.routeId === '117N' || arrival.route === 'N Line';
              return isNLine && arrival.directionId === 1;
            });

            sbTrains = filteredSB.slice(0, 3).map(arrival => {
              let arrivalTimestamp = null;
              let displayTime = arrival.arrivalTimeFormatted;
              let delayMinutes = 0;

              if (arrival.arrivalTime && typeof arrival.arrivalTime === 'number') {
                arrivalTimestamp = arrival.arrivalTime * 1000;
                const arrivalDate = new Date(arrivalTimestamp);
                displayTime = arrivalDate.toLocaleTimeString('en-US', {
                  hour: 'numeric',
                  minute: '2-digit',
                  hour12: true
                });

                if (arrival.scheduledArrivalTime && typeof arrival.scheduledArrivalTime === 'number') {
                  const scheduledTimestamp = arrival.scheduledArrivalTime * 1000;
                  delayMinutes = Math.round((arrivalTimestamp - scheduledTimestamp) / 60000);
                }
              }

              return {
                time: displayTime,
                arrivalTimestamp: arrivalTimestamp,
                delay: delayMinutes,
                status: arrival.status || 'On Time'
              };
            });
          }

          // Process northbound
          let nbTrains = [];
          if (nbData.arrivals && Array.isArray(nbData.arrivals) && nbData.arrivals.length > 0) {
            const filteredNB = nbData.arrivals.filter(arrival => {
              const isNLine = arrival.routeId === '117N' || arrival.route === 'N Line';
              return isNLine && arrival.directionId === 0;
            });

            nbTrains = filteredNB.slice(0, 3).map(arrival => {
              let arrivalTimestamp = null;
              let displayTime = arrival.arrivalTimeFormatted;
              let delayMinutes = 0;

              if (arrival.arrivalTime && typeof arrival.arrivalTime === 'number') {
                arrivalTimestamp = arrival.arrivalTime * 1000;
                const arrivalDate = new Date(arrivalTimestamp);
                displayTime = arrivalDate.toLocaleTimeString('en-US', {
                  hour: 'numeric',
                  minute: '2-digit',
                  hour12: true
                });

                if (arrival.scheduledArrivalTime && typeof arrival.scheduledArrivalTime === 'number') {
                  const scheduledTimestamp = arrival.scheduledArrivalTime * 1000;
                  delayMinutes = Math.round((arrivalTimestamp - scheduledTimestamp) / 60000);
                }
              }

              return {
                time: displayTime,
                arrivalTimestamp: arrivalTimestamp,
                delay: delayMinutes,
                status: arrival.status || 'On Time'
              };
            });
          }

          setTransitDataSB(sbTrains);
          setTransitDataNB(nbTrains);
        } catch (error) {
          console.error('Transit error:', error);
          setTransitDataSB([]);
          setTransitDataNB([]);
        } finally {
          setLoading(prev => ({ ...prev, transit: false }));
        }
      }, []);

      // Fetch today's tasks and events from planner
      const fetchTodaySchedule = useCallback(async () => {
        if (!plannerToken) return;

        try {
          setLoading(prev => ({ ...prev, tasks: true }));
          const response = await fetch(`https://rtd-n-line-api.onrender.com/api/planner/today/${plannerToken}`);
          const data = await response.json();

          if (data.tasks) setTodayTasks(data.tasks);
          if (data.events) setTodayEvents(data.events);
        } catch (error) {
          console.error('Schedule fetch error:', error);
          setTodayTasks([]);
          setTodayEvents([]);
        } finally {
          setLoading(prev => ({ ...prev, tasks: false }));
        }
      }, [plannerToken]);

      // Search location drive times
      const searchDriveTimes = useCallback(async () => {
        if (!searchFrom || !searchTo) return;

        try {
          setLoading(prev => ({ ...prev, search: true }));
          const apiKey = CONSTANTS.API_KEYS.GOOGLE_MAPS;

          const routeWithHighway = {
            origin: { location: { latLng: { latitude: parseFloat(searchFrom.split(',')[0]), longitude: parseFloat(searchFrom.split(',')[1]) }}},
            destination: { location: { latLng: { latitude: parseFloat(searchTo.split(',')[0]), longitude: parseFloat(searchTo.split(',')[1]) }}},
            travelMode: 'DRIVE',
            routingPreference: 'TRAFFIC_AWARE',
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const routeNoHighway = {
            ...routeWithHighway,
            routeModifiers: { avoidHighways: true }
          };

          const [withHighwayRes, noHighwayRes] = await Promise.all([
            fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters' },
              body: JSON.stringify(routeWithHighway)
            }),
            fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters' },
              body: JSON.stringify(routeNoHighway)
            })
          ]);

          const withHighwayData = await withHighwayRes.json();
          const noHighwayData = await noHighwayRes.json();

          if (withHighwayData.routes && withHighwayData.routes.length > 0) {
            const withHighwayDuration = parseInt(withHighwayData.routes[0].duration.replace('s', ''));
            const withHighwayDistance = withHighwayData.routes[0].distanceMeters;
            const noHighwayDuration = parseInt(noHighwayData.routes[0].duration.replace('s', ''));
            const noHighwayDistance = noHighwayData.routes[0].distanceMeters;

            setSearchResults({
              withHighway: {
                duration: `${Math.round(withHighwayDuration / 60)} mins`,
                distance: `${(withHighwayDistance * 0.000621371).toFixed(1)} mi`
              },
              noHighway: {
                duration: `${Math.round(noHighwayDuration / 60)} mins`,
                distance: `${(noHighwayDistance * 0.000621371).toFixed(1)} mi`
              }
            });
          }
        } catch (error) {
          console.error('Search error:', error);
          setSearchResults({ error: 'Unable to calculate route' });
        } finally {
          setLoading(prev => ({ ...prev, search: false }));
        }
      }, [searchFrom, searchTo]);

      // Initial data fetch
      useEffect(() => {
        fetchWeather();
        fetchDriveTimes();
        fetchTransitData();
        if (plannerToken) fetchTodaySchedule();
      }, [fetchWeather, fetchDriveTimes, fetchTransitData, fetchTodaySchedule]);

      // 15-minute refresh for weather and drive times
      useEffect(() => {
        const interval = setInterval(() => {
          fetchWeather();
          fetchDriveTimes();
          if (plannerToken) fetchTodaySchedule();
          setLastRefresh(new Date());
        }, CONSTANTS.REFRESH_INTERVAL);
        return () => clearInterval(interval);
      }, [fetchWeather, fetchDriveTimes, fetchTodaySchedule, plannerToken]);

      // 1-minute refresh for transit (needs more frequent updates)
      useEffect(() => {
        const interval = setInterval(() => {
          fetchTransitData();
        }, CONSTANTS.TRANSIT_INTERVAL);
        return () => clearInterval(interval);
      }, [fetchTransitData]);

      // Manual refresh all
      const handleManualRefresh = () => {
        fetchWeather();
        fetchDriveTimes();
        fetchTransitData();
        if (plannerToken) fetchTodaySchedule();
        setLastRefresh(new Date());
      };

      // Theme colors
      const theme = isDarkMode
        ? 'from-gray-900 to-gray-800 text-white'
        : 'from-gray-50 to-gray-100 text-gray-900';
      const cardBg = isDarkMode ? 'bg-gray-800' : 'bg-white';
      const textColor = isDarkMode ? 'text-white' : 'text-gray-900';
      const textMuted = isDarkMode ? 'text-gray-400' : 'text-gray-600';
      const borderColor = isDarkMode ? 'border-gray-700' : 'border-gray-200';

      // Render train card
      const renderTrainCard = (train, idx) => {
        if (!train.arrivalTimestamp) return null;

        const now = Date.now();
        const minutesUntil = Math.round((train.arrivalTimestamp - now) / 60000);

        let urgencyColor = isDarkMode ? 'bg-gray-700' : 'bg-gray-100';
        if (minutesUntil <= 5) urgencyColor = isDarkMode ? 'bg-red-900 bg-opacity-30' : 'bg-red-50';
        else if (minutesUntil <= 10) urgencyColor = isDarkMode ? 'bg-orange-900 bg-opacity-30' : 'bg-orange-50';
        else if (minutesUntil <= 15) urgencyColor = isDarkMode ? 'bg-yellow-900 bg-opacity-30' : 'bg-yellow-50';

        let delayColor = 'bg-green-100 text-green-700';
        if (train.delay > 3) delayColor = 'bg-red-100 text-red-700';
        else if (train.delay > 0) delayColor = 'bg-yellow-100 text-yellow-700';

        return (
          <div key={idx} className={`p-4 rounded-xl ${urgencyColor} border ${borderColor}`}>
            <div className="flex justify-between items-center">
              <div>
                <p className={`text-2xl font-bold ${textColor}`}>
                  {minutesUntil < 0 ? 'Departed' : minutesUntil === 0 ? 'Now' : `${minutesUntil} min`}
                </p>
                <p className={`text-sm ${textMuted}`}>{train.time}</p>
              </div>
              <div className="text-right">
                <span className={`px-2 py-1 rounded text-xs font-semibold ${delayColor}`}>
                  {train.delay > 0 ? `+${train.delay} min` : 'On Time'}
                </span>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className={`min-h-screen bg-gradient-to-br ${theme} p-4 sm:p-6`}>
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className={`${cardBg} rounded-2xl shadow-xl p-6 mb-6 border ${borderColor}`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                <div>
                  <h1 className={`text-3xl sm:text-4xl font-bold ${textColor} mb-2`}>
                    Taskify || Commute Dashboard
                  </h1>
                  <p className={`text-lg ${textMuted}`}>
                    {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} ‚Ä¢ {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                  <div className="mt-2">
                    <p className={`text-xl font-semibold ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                      {greeting.timeGreeting} ‚Ä¢ {greeting.contextGreeting}
                    </p>
                  </div>
                </div>

                {/* Weather widget in header */}
                {weather && !weather._isFallback && (
                  <div className={`flex items-center gap-4 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} px-4 py-3 rounded-xl`}>
                    <img src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png`} alt={weather.weather[0].description} className="w-16 h-16" />
                    <div>
                      <p className={`text-3xl font-bold ${textColor}`}>{Math.round(weather.main.temp)}¬∞F</p>
                      <p className={`text-sm ${textMuted} capitalize`}>{weather.weather[0].description}</p>
                    </div>
                  </div>
                )}
              </div>

              {/* Controls */}
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={handleManualRefresh}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${isDarkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                  aria-label="Refresh all data"
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Refresh Now
                </button>

                <button
                  onClick={() => setIsDarkMode(!isDarkMode)}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${isDarkMode ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-400' : 'bg-gray-800 text-white hover:bg-gray-700'}`}
                  aria-label={isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                >
                  {isDarkMode ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                </button>

                <div className={`px-3 py-2 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'} ${textMuted} text-sm`}>
                  Last refresh: {lastRefresh.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>

            {/* Navigation Tabs */}
            <div className={`${cardBg} rounded-2xl shadow-xl p-2 mb-6 border ${borderColor}`}>
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={() => setActiveTab('drive')}
                  className={`flex-1 min-w-[120px] px-4 py-3 rounded-xl font-semibold transition-all ${
                    activeTab === 'drive'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  üöó Drive Time
                </button>

                <button
                  onClick={() => setActiveTab('nline')}
                  className={`flex-1 min-w-[120px] px-4 py-3 rounded-xl font-semibold transition-all ${
                    activeTab === 'nline'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  üöÜ N Line Schedule
                </button>

                <button
                  onClick={() => setActiveTab('schedule')}
                  className={`flex-1 min-w-[120px] px-4 py-3 rounded-xl font-semibold transition-all ${
                    activeTab === 'schedule'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  üìÖ Today's Schedule
                </button>

                <button
                  onClick={() => setActiveTab('search')}
                  className={`flex-1 min-w-[120px] px-4 py-3 rounded-xl font-semibold transition-all ${
                    activeTab === 'search'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : isDarkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  üîç Search Locator
                </button>
              </div>
            </div>

            {/* Tab Content */}
            <div className="slide-in">
              {/* Drive Time Tab */}
              {activeTab === 'drive' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-6 border ${borderColor}`}>
                  <div className="flex items-center justify-between mb-6">
                    <h2 className={`text-2xl font-bold ${textColor}`}>üöó Drive Times</h2>
                    <button
                      onClick={fetchDriveTimes}
                      className={`px-3 py-2 rounded-lg text-sm ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                      disabled={loading.drive}
                    >
                      {loading.drive ? '‚è≥' : 'üîÑ'} Refresh
                    </button>
                  </div>

                  {driveData && (
                    <>
                      {driveData._isFallback && (
                        <div className={`p-3 rounded-lg mb-4 ${isDarkMode ? 'bg-yellow-900 bg-opacity-30 text-yellow-300' : 'bg-yellow-100 text-yellow-800'}`}>
                          <p className="text-sm">‚ö†Ô∏è Using estimated times - Google Maps API unavailable</p>
                        </div>
                      )}

                      <div className="flex items-center justify-between mb-4">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <span className={`text-sm font-medium ${textColor}`}>Avoid Highways</span>
                          <div className="relative">
                            <input type="checkbox" checked={avoidHighways} onChange={(e) => setAvoidHighways(e.target.checked)} className="sr-only" />
                            <div className={`w-14 h-8 rounded-full transition-colors ${avoidHighways ? 'bg-green-500' : 'bg-gray-300'}`}>
                              <div className={`absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform ${avoidHighways ? 'translate-x-6' : ''}`} />
                            </div>
                          </div>
                        </label>

                        <a
                          href={`https://www.google.com/maps/dir/${config.locations.home.lat},${config.locations.home.lng}/${config.locations.work.lat},${config.locations.work.lng}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className={`px-4 py-2 rounded-lg text-sm font-medium ${isDarkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                        >
                          üó∫Ô∏è Open in Maps
                        </a>
                      </div>

                      <div className="grid md:grid-cols-3 gap-4">
                        <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-orange-900 bg-opacity-30 border-orange-700' : 'bg-orange-50 border-orange-200'}`}>
                          <p className={`text-sm font-semibold mb-3 ${isDarkMode ? 'text-orange-400' : 'text-orange-800'}`}>üöó Home ‚Üí Garage</p>
                          <p className={`text-3xl font-bold mb-1 ${isDarkMode ? 'text-orange-300' : 'text-orange-900'}`}>{driveData.morning.duration.text}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-orange-400' : 'text-orange-700'}`}>{driveData.morning.distance.text}</p>
                        </div>

                        <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                          <p className={`text-sm font-semibold mb-3 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>üö∂ Garage ‚Üí Work</p>
                          <p className={`text-3xl font-bold mb-1 ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>{driveData.walk.duration.text}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{driveData.walk.distance.text}</p>
                        </div>

                        <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-purple-900 bg-opacity-30 border-purple-700' : 'bg-purple-50 border-purple-200'}`}>
                          <p className={`text-sm font-semibold mb-3 ${isDarkMode ? 'text-purple-400' : 'text-purple-800'}`}>üè† Garage ‚Üí Home</p>
                          <p className={`text-3xl font-bold mb-1 ${isDarkMode ? 'text-purple-300' : 'text-purple-900'}`}>{driveData.evening.duration.text}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-purple-400' : 'text-purple-700'}`}>{driveData.evening.distance.text}</p>
                        </div>
                      </div>

                      <div className={`mt-4 p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <p className={`text-sm ${textColor}`}>
                          <span className="font-semibold">Total commute time: </span>
                          {Math.round(driveData.morning.duration.value / 60) + Math.round(driveData.walk.duration.value / 60)} minutes
                        </p>
                      </div>
                    </>
                  )}
                </div>
              )}

              {/* N Line Schedule Tab */}
              {activeTab === 'nline' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-6 border ${borderColor}`}>
                  <div className="flex items-center justify-between mb-6">
                    <h2 className={`text-2xl font-bold ${textColor}`}>üöÜ RTD N Line Schedule</h2>
                    <button
                      onClick={fetchTransitData}
                      className={`px-3 py-2 rounded-lg text-sm ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                      disabled={loading.transit}
                    >
                      {loading.transit ? '‚è≥' : 'üîÑ'} Refresh
                    </button>
                  </div>

                  {/* Southbound */}
                  <div className="mb-6">
                    <div className={`flex items-center gap-2 mb-3 pb-2 border-b-2 ${isDarkMode ? 'border-orange-700' : 'border-orange-300'}`}>
                      <span className="text-2xl">‚¨áÔ∏è</span>
                      <h3 className={`text-xl font-bold ${isDarkMode ? 'text-orange-300' : 'text-orange-900'}`}>Southbound</h3>
                      <span className={`text-sm ${textMuted}`}>To Downtown / Union Station</span>
                    </div>
                    <div className="space-y-3">
                      {transitDataSB && transitDataSB.length > 0 ? (
                        transitDataSB.map((train, idx) => renderTrainCard(train, idx))
                      ) : (
                        <div className={`p-6 text-center rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <p className={textMuted}>No upcoming southbound trains</p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Northbound */}
                  <div>
                    <div className={`flex items-center gap-2 mb-3 pb-2 border-b-2 ${isDarkMode ? 'border-purple-700' : 'border-purple-300'}`}>
                      <span className="text-2xl">‚¨ÜÔ∏è</span>
                      <h3 className={`text-xl font-bold ${isDarkMode ? 'text-purple-300' : 'text-purple-900'}`}>Northbound</h3>
                      <span className={`text-sm ${textMuted}`}>To Northglenn/112th</span>
                    </div>
                    <div className={`mb-3 p-3 rounded-lg ${isDarkMode ? 'bg-purple-900 bg-opacity-20' : 'bg-purple-50'}`}>
                      <p className={`text-xs ${isDarkMode ? 'text-purple-300' : 'text-purple-800'}`}>
                        ‚ÑπÔ∏è Trains sit at Union Station for 15 min before departure. Times show DEPARTURE countdown.
                      </p>
                    </div>
                    <div className="space-y-3">
                      {transitDataNB && transitDataNB.length > 0 ? (
                        transitDataNB.map((train, idx) => renderTrainCard(train, idx))
                      ) : (
                        <div className={`p-6 text-center rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <p className={textMuted}>No upcoming northbound trains</p>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className={`mt-4 p-4 rounded-lg ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                    <p className={`text-sm ${isDarkMode ? 'text-blue-300' : 'text-blue-800'}`}>
                      <span className="font-semibold">üî¥ Live RTD data</span> ‚Ä¢ Updates every minute
                    </p>
                  </div>
                </div>
              )}

              {/* Today's Schedule Tab */}
              {activeTab === 'schedule' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-6 border ${borderColor}`}>
                  <h2 className={`text-2xl font-bold ${textColor} mb-6`}>üìÖ Today's Schedule</h2>

                  {!plannerToken ? (
                    <div className={`text-center py-12 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl`}>
                      <p className={`text-lg mb-4 ${textColor}`}>Connect your planner to see today's tasks and events</p>
                      <input
                        type="text"
                        placeholder="Enter Planner Token (e.g., PLAN-ABC123)"
                        className={`px-4 py-2 rounded-lg border mb-4 ${isDarkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            setPlannerToken(e.target.value);
                            localStorage.setItem('plannerToken', e.target.value);
                          }
                        }}
                      />
                      <p className={`text-xs ${textMuted}`}>Press Enter to save</p>
                    </div>
                  ) : (
                    <>
                      {loading.tasks ? (
                        <div className="text-center py-8">
                          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                          <p className={textMuted}>Loading schedule...</p>
                        </div>
                      ) : (
                        <>
                          {/* Tasks */}
                          <div className="mb-6">
                            <h3 className={`text-xl font-semibold ${textColor} mb-3`}>‚úÖ Tasks</h3>
                            {todayTasks.length === 0 ? (
                              <p className={textMuted}>No tasks for today</p>
                            ) : (
                              <div className="space-y-2">
                                {todayTasks.map((task, idx) => (
                                  <div key={idx} className={`p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <p className={`font-medium ${textColor}`}>{task.title}</p>
                                    {task.time && <p className={`text-sm ${textMuted}`}>{task.time}</p>}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Events */}
                          <div>
                            <h3 className={`text-xl font-semibold ${textColor} mb-3`}>üìÜ Events</h3>
                            {todayEvents.length === 0 ? (
                              <p className={textMuted}>No events for today</p>
                            ) : (
                              <div className="space-y-2">
                                {todayEvents.map((event, idx) => (
                                  <div key={idx} className={`p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <p className={`font-medium ${textColor}`}>{event.title}</p>
                                    {event.time && <p className={`text-sm ${textMuted}`}>{event.time}</p>}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          <button
                            onClick={() => {
                              setPlannerToken(null);
                              localStorage.removeItem('plannerToken');
                            }}
                            className="mt-4 text-sm text-red-500 hover:text-red-600"
                          >
                            Disconnect planner
                          </button>
                        </>
                      )}
                    </>
                  )}
                </div>
              )}

              {/* Search Locator Tab */}
              {activeTab === 'search' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-6 border ${borderColor}`}>
                  <h2 className={`text-2xl font-bold ${textColor} mb-6`}>üîç Search Drive Times</h2>

                  <div className="space-y-4 mb-6">
                    <div>
                      <label className={`block text-sm font-medium ${textColor} mb-2`}>From Location (lat,lng)</label>
                      <input
                        type="text"
                        value={searchFrom}
                        onChange={(e) => setSearchFrom(e.target.value)}
                        placeholder="39.9067,-104.9875"
                        className={`w-full px-4 py-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                      />
                    </div>

                    <div>
                      <label className={`block text-sm font-medium ${textColor} mb-2`}>To Location (lat,lng)</label>
                      <input
                        type="text"
                        value={searchTo}
                        onChange={(e) => setSearchTo(e.target.value)}
                        placeholder="39.7467,-104.9898"
                        className={`w-full px-4 py-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                      />
                    </div>

                    <button
                      onClick={searchDriveTimes}
                      disabled={!searchFrom || !searchTo || loading.search}
                      className={`w-full px-4 py-3 rounded-lg font-semibold ${
                        !searchFrom || !searchTo || loading.search
                          ? 'bg-gray-400 cursor-not-allowed'
                          : isDarkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'
                      } text-white transition-all`}
                    >
                      {loading.search ? 'Searching...' : 'Search Drive Times'}
                    </button>
                  </div>

                  {searchResults && (
                    <div className="space-y-4">
                      {searchResults.error ? (
                        <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-red-900 bg-opacity-30 text-red-300' : 'bg-red-50 text-red-800'}`}>
                          <p>{searchResults.error}</p>
                        </div>
                      ) : (
                        <>
                          <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-green-900 bg-opacity-30 border-green-700' : 'bg-green-50 border-green-200'}`}>
                            <p className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-green-400' : 'text-green-800'}`}>üõ£Ô∏è With Highway</p>
                            <p className={`text-2xl font-bold ${isDarkMode ? 'text-green-300' : 'text-green-900'}`}>{searchResults.withHighway.duration}</p>
                            <p className={`text-sm ${isDarkMode ? 'text-green-400' : 'text-green-700'}`}>{searchResults.withHighway.distance}</p>
                          </div>

                          <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                            <p className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>üöó Without Highway</p>
                            <p className={`text-2xl font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>{searchResults.noHighway.duration}</p>
                            <p className={`text-sm ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{searchResults.noHighway.distance}</p>
                          </div>
                        </>
                      )}
                    </div>
                  )}

                  <div className={`mt-6 p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-sm ${textMuted} mb-2`}>
                      <span className="font-semibold">Quick locations:</span>
                    </p>
                    <div className="grid grid-cols-2 gap-2 text-xs">
                      <button
                        onClick={() => setSearchFrom('39.9067,-104.9875')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Home
                      </button>
                      <button
                        onClick={() => setSearchFrom('39.7477,-104.9898')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Garage
                      </button>
                      <button
                        onClick={() => setSearchTo('39.7477,-104.9898')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Garage
                      </button>
                      <button
                        onClick={() => setSearchTo('39.7465,-104.9914')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Work
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className={`mt-6 text-center ${textMuted}`}>
              <p className="text-xs">
                üîÑ Auto-refresh: Every 15 minutes (Transit: Every 1 minute)
              </p>
              <p className="text-xs mt-2">
                Taskify || Commute Dashboard ‚Ä¢ RTD N Line ‚Ä¢ Denver Metro
              </p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<CommuteDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
