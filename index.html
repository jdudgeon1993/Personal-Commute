<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commute Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f0f2f5; --text:#111827; --card:#fff; --muted:#6b7280; --accent:#4f46e5;
  --success:#10b981; --warn:#facc15; --danger:#ef4444; --shadow:0 6px 18px rgba(15,23,42,0.08);
  --status-gray:#9ca3af;
}
body.dark{
  --bg:#0f1724; --text:#f3f6fb; --card:#1e293b; --muted:#9ca3af;
  --accent:#7c89ff; --success:#34d399; --warn:#fbbf24; --danger:#f87171; --shadow:0 8px 24px rgba(0,0,0,0.6);
  --status-gray:#475569;
}
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:var(--text);}
.app{max-width:960px;margin:auto;padding:18px; display:flex; flex-direction:column; gap:18px;}
header{display:flex; justify-content:space-between; align-items:center; gap:12px;}
.title-block{display:flex; flex-direction:column;}
h1{margin:0; font-size:22px; font-weight:800;}
.muted{color:var(--muted); font-size:13px;}
.controls{display:flex; gap:8px; align-items:center;}
.btn{padding:8px 14px; border-radius:12px; border:none; font-weight:600; cursor:pointer; background:var(--accent); color:#fff; box-shadow:var(--shadow); transition:all 0.18s;}
.btn.ghost{background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.06);}
.grid{display:grid; gap:16px;}
/* responsive: stacked on mobile, two-column >=1000px */
@media (min-width:1000px){ .grid{grid-template-columns:1fr 1fr;} }
.card{position:relative; background:var(--card); border-radius:16px; padding:18px; display:flex; flex-direction:column; gap:12px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.04); transition:transform .18s, box-shadow .18s;}
.card:hover{transform:translateY(-4px); box-shadow:0 18px 36px rgba(15,23,42,0.08);}
.card .status-accent{position:absolute; top:0; right:0; width:10px; height:100%; border-radius:0 16px 16px 0; background:var(--status-gray); transition:background .3s;}
.commute-header{display:flex; align-items:center; gap:12px;}
.icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;}
.icon.weather{background:linear-gradient(135deg,#ffd166,#ff9a66); color:#1f2937;}
.icon.drive{background:linear-gradient(135deg,#60a5fa,#4f46e5);}
.icon.transit{background:linear-gradient(135deg,#34d399,#10b981); color:#072014;}
.header-sub{font-size:13px;color:var(--muted);}
.section{margin-top:8px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.04);}
body.dark .section{border-top-color:rgba(255,255,255,0.04);}
.direction-row{display:flex; gap:16px; flex-wrap:wrap;}
.direction-col{flex:1; min-width:180px; background:rgba(0,0,0,0.03); padding:12px;border-radius:12px; display:flex; flex-direction:column; gap:8px;}
body.dark .direction-col{background:rgba(255,255,255,0.03);}
.small-label{font-size:13px;color:var(--muted);}
.big-value{font-size:18px;font-weight:700;}
.progress-bar{height:8px;border-radius:8px;background:rgba(0,0,0,0.08);overflow:hidden;}
.progress-fill{height:100%; width:0%; background:var(--success); transition:width .6s ease, background .4s ease;}
.radio-seg{display:flex;border-radius:10px; overflow:hidden; border:1px solid rgba(0,0,0,0.06); width:100%; max-width:320px;}
body.dark .radio-seg{border:1px solid rgba(255,255,255,0.04);}
.radio-seg button{flex:1;padding:8px 10px;border:0;background:transparent;cursor:pointer;font-weight:600;color:var(--muted);}
.radio-seg button.active{background:var(--accent); color:#fff;}
.timeline{display:flex;flex-direction:column;gap:8px;max-height:200px;overflow:auto;padding-right:4px;}
.timeline-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:10px;font-weight:700;}
.timeline-item.green{background:var(--success);color:#fff;}
.timeline-item.yellow{background:var(--warn);color:#111;}
.timeline-item.red{background:var(--danger);color:#fff;}
.footer-row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:6px;}
.small{font-size:13px;color:var(--muted);}

/* last-updated pill */
.updated-pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:13px;color:var(--muted);}
body.dark .updated-pill{background:rgba(255,255,255,0.03);color:var(--muted);}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Commute Dashboard</h1>
      <div class="muted" id="dayTime">Loading‚Ä¶</div>
    </div>
    <div class="controls">
      <button class="btn" id="refreshBtn" title="Refresh now">‚ü≥ Refresh</button>
      <button class="btn ghost" id="themeToggle" title="Toggle theme">Toggle</button>
    </div>
  </header>

  <main class="grid">

    <!-- Weather Card -->
    <section class="card" id="weatherCard">
      <div class="status-accent" id="weatherAccent"></div>
      <div class="commute-header">
        <div class="icon weather">‚òÄÔ∏è</div>
        <div>
          <div style="font-weight:700">Weather ‚Äî Denver</div>
          <div class="header-sub" id="weatherDesc">Loading‚Ä¶</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="big-value" id="weatherTemp">‚Äî</div>
        <div class="small-label" id="weatherFeels">‚Äî</div>
      </div>

      <div class="section" style="display:flex;gap:8px;flex-wrap:wrap;">
        <div class="pill small updated-pill" id="weatherWind">Wind ‚Äî</div>
        <div class="pill small updated-pill" id="weatherHumidity">Humidity ‚Äî</div>
      </div>
    </section>

    <!-- Drive Card -->
    <section class="card" id="driveCard">
      <div class="status-accent" id="driveAccent"></div>
      <div class="commute-header">
        <div class="icon drive">üöó</div>
        <div>
          <div style="font-weight:700">Drive</div>
          <div class="header-sub">Home ‚Üî Work</div>
        </div>
      </div>

      <!-- segmented radio under header (clean placement) -->
      <div style="margin-top:6px;">
        <div class="radio-seg" role="tablist" id="driveToggle">
          <button data-val="best" class="active" id="seg-fast">Fastest</button>
          <button data-val="avoidHighways" id="seg-avoid">Avoid Highways</button>
        </div>
      </div>

      <div class="section">
        <div class="small-label">Southbound ‚Äî To Work (Home ‚Üí Work)</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small-label">ETA</div>
          <div class="big-value" id="driveToWork">Loading‚Ä¶</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="driveToWorkBar"></div></div>
      </div>

      <div class="section">
        <div class="small-label">Northbound ‚Äî To Home (Work ‚Üí Home)</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="small-label">ETA</div>
          <div class="big-value" id="driveToHome">Loading‚Ä¶</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="driveToHomeBar"></div></div>
      </div>
    </section>

    <!-- Transit Card -->
    <section class="card" id="transitCard">
      <div class="status-accent" id="transitAccent"></div>
      <div class="commute-header">
        <div class="icon transit">üöâ</div>
        <div>
          <div style="font-weight:700">Transit ‚Äî N Line</div>
          <div class="header-sub">112th & Northglenn ‚Üî Denver Union Station</div>
        </div>
      </div>

      <div class="section direction-row">
        <div class="direction-col">
          <div class="small-label" style="font-weight:700">Southbound</div>
          <div class="small-label" id="sbRouteDesc" style="margin-bottom:6px;">112th & Northglenn ‚Üí Denver Union Station</div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="small-label">Next</div>
            <div class="big-value" id="trainToWork">Loading‚Ä¶</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <div class="small-label">Countdown</div>
            <div class="big-value" id="trainToWorkCountdown">‚Äî</div>
          </div>
          <div class="timeline" id="trainToWorkTimeline"></div>
        </div>

        <div class="direction-col">
          <div class="small-label" style="font-weight:700">Northbound</div>
          <div class="small-label" id="nbRouteDesc" style="margin-bottom:6px;">Denver Union Station ‚Üí 112th & Northglenn</div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="small-label">Next</div>
            <div class="big-value" id="trainToHome">Loading‚Ä¶</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <div class="small-label">Countdown</div>
            <div class="big-value" id="trainToHomeCountdown">‚Äî</div>
          </div>
          <div class="timeline" id="trainToHomeTimeline"></div>
        </div>
      </div>
    </section>

    <!-- Alerts Card -->
    <section class="card" id="alertsCard">
      <div class="status-accent" id="alertsAccent"></div>
      <div class="commute-header">
        <div class="icon" style="background:linear-gradient(135deg,#ef4444,#f59e0b)">‚ö†Ô∏è</div>
        <div>
          <div style="font-weight:700">Alerts</div>
          <div class="header-sub">Weather & Transit notices</div>
        </div>
      </div>

      <div class="section">
        <div id="alertsText" class="small">No alerts at this time</div>
      </div>
    </section>

  </main>

  <div class="footer-row">
    <div class="small updated-pill" id="lastUpdated">Updated: ‚Äî</div>
    <div class="small muted">Auto-refresh: 10 minutes</div>
  </div>
</div>

<script>
/* -----------------------------
   Config & Addresses (replace keys if necessary)
------------------------------*/
const OPENWEATHER_API_KEY = '1c91f81f2adfd1b633d19842869a1a11';
const GOOGLE_MAPS_API_KEY = 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY';

const HOME = '11625 Community Center Drive Northglenn CO 80233';
const WORK = '707 17th Street Denver CO 80202';
const N_ORIGIN = '112th & Northglenn Station, Northglenn, CO';
const N_DEST = 'Denver Union Station, Denver, CO';

const TRAIN_LABELS = {
  SOUTHBOUND: '112th & Northglenn ‚Üí Denver Union Station',
  NORTHBOUND: 'Denver Union Station ‚Üí 112th & Northglenn'
};

/* -----------------------------
   Elements
------------------------------*/
const dayTimeEl = document.getElementById('dayTime');
const lastUpdatedEl = document.getElementById('lastUpdated');

const weatherTempEl = document.getElementById('weatherTemp');
const weatherDescEl = document.getElementById('weatherDesc');
const weatherFeelsEl = document.getElementById('weatherFeels');
const weatherWindEl = document.getElementById('weatherWind');
const weatherHumidityEl = document.getElementById('weatherHumidity');

const driveToWorkEl = document.getElementById('driveToWork');
const driveToHomeEl = document.getElementById('driveToHome');
const driveToWorkBar = document.getElementById('driveToWorkBar');
const driveToHomeBar = document.getElementById('driveToHomeBar');

const segFastBtn = document.getElementById('seg-fast');
const segAvoidBtn = document.getElementById('seg-avoid');

const driveAccent = document.getElementById('driveAccent');
const transitAccent = document.getElementById('transitAccent');

const trainToWorkEl = document.getElementById('trainToWork');
const trainToHomeEl = document.getElementById('trainToHome');
const trainToWorkCountdown = document.getElementById('trainToWorkCountdown');
const trainToHomeCountdown = document.getElementById('trainToHomeCountdown');
const trainToWorkTimeline = document.getElementById('trainToWorkTimeline');
const trainToHomeTimeline = document.getElementById('trainToHomeTimeline');

const alertsText = document.getElementById('alertsText');
const alertsAccent = document.getElementById('alertsAccent');

let directionsService = null;
let workTrainInterval = null;
let homeTrainInterval = null;

/* -----------------------------
   Utilities
------------------------------*/
function updateDayTime(){
  const now = new Date();
  const hours = now.getHours();
  let part = 'Morning';
  if(hours >= 12 && hours < 17) part = 'Afternoon';
  else if(hours >= 17) part = 'Evening';
  dayTimeEl.textContent = `${now.toLocaleDateString(undefined,{weekday:'long'})}, ${part}`;
}

function setLastUpdated(){
  const now = new Date();
  lastUpdatedEl.textContent = `Updated: ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
}

/* -----------------------------
   Weather
------------------------------*/
async function fetchWeather(){
  try{
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Denver,US&units=imperial&appid=${OPENWEATHER_API_KEY}`);
    if(!res.ok) throw new Error('Weather fetch failed');
    const data = await res.json();
    const temp = Math.round(data.main.temp)+'¬∞F';
    const desc = data.weather?.[0]?.description ?? '‚Äî';
    const icon = data.weather?.[0]?.icon;
    const feels = Math.round(data.main.feels_like)+'¬∞F';
    const wind = `${Math.round(data.wind.speed)} mph`;
    const humidity = `${data.main.humidity}%`;
    weatherTempEl.textContent = temp;
    weatherDescEl.textContent = desc[0]?.toUpperCase() + desc.slice(1);
    weatherFeelsEl.textContent = `Feels: ${feels}`;
    weatherWindEl.textContent = `Wind: ${wind}`;
    weatherHumidityEl.textContent = `Humidity: ${humidity}`;
    // alerts (OpenWeather may provide alerts in other endpoints - placeholder)
    // Update small visual
  }catch(e){
    console.error(e);
    weatherTempEl.textContent = 'Error';
    weatherDescEl.textContent = 'Weather unavailable';
  }
}

/* -----------------------------
   Drive (Maps JS DirectionsService)
------------------------------*/
function setDriveBarColor(barEl, mins){
  // thresholds: <=20 green, <=40 yellow, else red
  if(mins == null || isNaN(mins)) {
    barEl.style.width = '0%';
    barEl.style.backgroundColor = 'rgba(156,163,175,0.6)'; // gray
    return;
  }
  const pct = Math.min(Math.max((mins / 60) * 100, 0), 100);
  barEl.style.width = pct + '%';
  if(mins <= 20) barEl.style.backgroundColor = 'var(--success)';
  else if(mins <= 40) barEl.style.backgroundColor = 'var(--warn)';
  else barEl.style.backgroundColor = 'var(--danger)';
}

function setCardAccent(cardAccentEl,mins,kind){
  // kind: 'drive' or 'transit'
  if(mins == null || isNaN(mins)) {
    cardAccentEl.style.background = 'var(--status-gray)';
    return;
  }
  if(mins <= 20) cardAccentEl.style.background = 'var(--success)';
  else if(mins <= 40) cardAccentEl.style.background = 'var(--warn)';
  else cardAccentEl.style.background = 'var(--danger)';
}

function getDriveTime(origin, destination, el, barEl, avoidHighways){
  if(!directionsService){ el.textContent = 'Maps not ready'; return; }
  el.textContent = 'Calculating‚Ä¶';
  barEl.style.width = '0%';
  directionsService.route({
    origin, destination, travelMode: google.maps.TravelMode.DRIVING,
    drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' },
    avoidHighways: avoidHighways
  }, (result, status) => {
    if(status !== 'OK'){
      console.warn('Directions error', status);
      el.textContent = 'Error';
      setDriveBarColor(barEl, null);
      return;
    }
    const leg = result.routes[0].legs[0];
    const mins = Math.round((leg.duration_in_traffic?.value ?? leg.duration.value) / 60);
    el.textContent = leg.duration_in_traffic?.text ?? leg.duration.text ?? 'N/A';
    setDriveBarColor(barEl, mins);
    // set overall drive accent by using average of both directions later
  });
}

/* -----------------------------
   Transit (DirectionsService with transit & simple timeline)
------------------------------*/
function updateTrainTimelineDOM(upcoming, timelineEl){
  timelineEl.innerHTML = '';
  upcoming.forEach(u => {
    const now = new Date();
    const diffMs = Math.max(0, u.dep - now);
    const minutes = Math.floor(diffMs / 60000);
    const item = document.createElement('div');
    item.className = 'timeline-item';
    if(minutes <= 5) item.classList.add('red');
    else if(minutes <= 15) item.classList.add('yellow');
    else item.classList.add('green');
    const timeText = u.dep.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    item.textContent = `${timeText}  ‚Äî  ${minutes}m`;
    timelineEl.appendChild(item);
  });
}

function getNLine(origin, destination, label, elNext, elCountdown, timelineEl){
  if(!directionsService){ elNext.textContent = 'Maps not ready'; return; }
  elNext.textContent = 'Searching‚Ä¶';
  timelineEl.innerHTML = '';
  directionsService.route({
    origin, destination, travelMode: google.maps.TravelMode.TRANSIT,
    transitOptions: { modes: [ 'RAIL' ] }, provideRouteAlternatives: false
  }, (result, status) => {
    if(status !== 'OK'){ console.warn('Transit directions error', status); elNext.textContent = 'Error'; return; }
    try{
      const leg = result.routes[0].legs[0];
      // filter steps for rail / N line
      const steps = leg.steps.filter(s => s.transit && s.transit.line && (String(s.transit.line.short_name) === 'N' || /N/.test(s.transit.line.name)));
      if(!steps.length){ elNext.textContent = 'No N Line trains now'; return; }
      const upcoming = [];
      steps.slice(0,5).forEach(step => {
        const dep = new Date(step.transit.departure_time.value);
        const arr = new Date(step.transit.arrival_time.value);
        upcoming.push({ dep, arr, headsign: step.transit.headsign || step.transit.line.short_name });
      });
      // show next one at top
      const next = upcoming[0];
      elNext.textContent = `${next.dep.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ‚Üí ${next.arr.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
      // set countdown now and start interval updating countdown (return previous cleared by caller)
      function updateCountdownDisplay(){
        const now = new Date();
        const diff = Math.max(0, next.dep - now);
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        elCountdown.textContent = `${mins}m ${secs}s`;
      }
      updateCountdownDisplay();
      updateTrainTimelineDOM(upcoming, timelineEl);
      return { upcoming, updateCountdownDisplay };
    }catch(e){
      console.error(e);
      elNext.textContent = 'Transit parse error';
    }
  });
}

/* -----------------------------
   Overall refresh logic & intervals
------------------------------*/
let workCountdownInterval = null;
let homeCountdownInterval = null;

async function refreshAll(){
  updateDayTime();
  setLastUpdated();

  // weather
  fetchWeather();

  // drive settings
  const avoidHighways = segAvoidBtn.classList.contains('active');

  // drive times (calls DirectionsService -> requires maps js loaded)
  getDriveTime(HOME, WORK, driveToWorkEl, driveToWorkBar, avoidHighways);
  getDriveTime(WORK, HOME, driveToHomeEl, driveToHomeBar, avoidHighways);

  // transit - Southbound (112th -> Union)
  // We'll call getNLine which does a route() and returns upcoming structure via callback pattern.
  // Because DirectionsService.route is async via callback, we wrap in a Promise to get countdown updater.
  function nlinePromise(origin, dest, elNext, elCountdown, timelineEl){
    return new Promise((resolve) => {
      directionsService.route({
        origin: origin,
        destination: dest,
        travelMode: google.maps.TravelMode.TRANSIT,
        transitOptions: { modes: ['RAIL'] }, provideRouteAlternatives:false
      }, (result, status) => {
        if(status !== 'OK'){ resolve({ error: true }); return; }
        const leg = result.routes[0].legs[0];
        const steps = leg.steps.filter(s => s.transit && s.transit.line && (String(s.transit.line.short_name) === 'N' || /N/.test(s.transit.line.name)));
        if(!steps.length){ elNext.textContent = 'No N Line trains now'; resolve({ none:true }); return; }
        const upcoming = [];
        steps.slice(0,5).forEach(step => {
          const dep = new Date(step.transit.departure_time.value);
          const arr = new Date(step.transit.arrival_time.value);
          upcoming.push({dep, arr});
        });
        const next = upcoming[0];
        elNext.textContent = `${next.dep.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ‚Üí ${next.arr.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
        // initial timeline
        updateTrainTimelineDOM(upcoming, timelineEl);
        // resolver provides data for countdown updater & min until next
        resolve({ upcoming, next });
      });
    });
  }

  // Clear previous intervals
  if(workCountdownInterval){ clearInterval(workCountdownInterval); workCountdownInterval = null; }
  if(homeCountdownInterval){ clearInterval(homeCountdownInterval); homeCountdownInterval = null; }

  // Southbound
  const sbRes = await nlinePromise(N_ORIGIN, N_DEST, trainToWorkEl, trainToWorkCountdown, trainToWorkTimeline);
  if(sbRes && sbRes.next){
    workCountdownInterval = setInterval(()=> {
      const diff = Math.max(0, sbRes.next.dep - new Date());
      const mins = Math.floor(diff/60000);
      const secs = Math.floor((diff%60000)/1000);
      trainToWorkCountdown.textContent = `${mins}m ${secs}s`;
      // update accent color for transit based on earliest next (we will also consider northbound below)
      setCardAccent(transitAccent, mins, 'transit');
    }, 1000);
  } else {
    trainToWorkCountdown.textContent = '‚Äî';
  }

  // Northbound
  const nbRes = await nlinePromise(N_DEST, N_ORIGIN, trainToHomeEl, trainToHomeCountdown, trainToHomeTimeline);
  if(nbRes && nbRes.next){
    homeCountdownInterval = setInterval(()=> {
      const diff = Math.max(0, nbRes.next.dep - new Date());
      const mins = Math.floor(diff/60000);
      const secs = Math.floor((diff%60000)/1000);
      trainToHomeCountdown.textContent = `${mins}m ${secs}s`;
      // combine min with southbound to set transit accent as the earliest wait
      const sbMin = sbRes && sbRes.next ? Math.floor((sbRes.next.dep - new Date())/60000) : Infinity;
      const earliest = Math.min(sbMin, mins);
      setCardAccent(transitAccent, earliest, 'transit');
    }, 1000);
  } else {
    trainToHomeCountdown.textContent = '‚Äî';
  }

  // If both drive directions have valid mins, set driveAccent to average (or worst)
  // We fetch raw displayed text and attempt to parse minutes from 'xx mins' text returned by Maps.
  function parseMinutesFromText(txt){
    if(!txt || typeof txt !== 'string') return null;
    const m = txt.match(/(\d+)\s*min/);
    if(m) return parseInt(m[1],10);
    const mm = txt.match(/(\d+)\s*h/); // hours fallback
    if(mm) return parseInt(mm[1],10)*60;
    return null;
  }
  // small timeout to let directions callbacks fill values
  setTimeout(()=>{
    const a = parseMinutesFromText(driveToWorkEl.textContent);
    const b = parseMinutesFromText(driveToHomeEl.textContent);
    // choose worst-case for accent readability (if either heavy -> red)
    const candidate = [a,b].filter(v=>v!=null);
    if(candidate.length){
      const worst = Math.max(...candidate);
      setCardAccent(driveAccent, worst, 'drive');
    } else {
      driveAccent.style.background = 'var(--status-gray)';
    }
  }, 800);
}

/* -----------------------------
   Segmented control handlers
------------------------------*/
function setSegmentActive(val){
  if(val === 'best'){
    segFastBtn.classList.add('active');
    segAvoidBtn.classList.remove('active');
  } else {
    segFastBtn.classList.remove('active');
    segAvoidBtn.classList.add('active');
  }
}

/* -----------------------------
   Wiring up theme, refresh, init map
------------------------------*/
document.getElementById('refreshBtn').addEventListener('click', ()=> {
  refreshAll();
});

document.getElementById('themeToggle').addEventListener('click', ()=> {
  document.body.classList.toggle('dark');
});

/* segmented buttons */
segFastBtn.addEventListener('click', ()=>{ setSegmentActive('best'); refreshAll(); });
segAvoidBtn.addEventListener('click', ()=>{ setSegmentActive('avoidHighways'); refreshAll(); });

/* init map and start periodic refresh */
function initMapAndStart(){
  directionsService = new google.maps.DirectionsService();
  // initial load
  refreshAll();
  // auto refresh every 10 minutes
  setInterval(refreshAll, 600000); // 600000 ms = 10 minutes
}

/* load Google Maps JS API (calls initMapAndStart when loaded) */
(function loadMaps(){
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMapAndStart`;
  s.async = true;
  s.defer = true;
  window.initMapAndStart = initMapAndStart;
  document.head.appendChild(s);
})();

/* set initial UI state */
setSegmentActive('best');
updateDayTime();
setLastUpdated();

// small safety: if maps fails to load within 8s, still show last-updated and allow refresh
setTimeout(()=> { if(!directionsService) { console.warn('Maps script not yet ready.'); setLastUpdated(); } }, 8000);

</script>
</body>
</html>