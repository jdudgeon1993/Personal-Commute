<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Commute Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const CommuteDashboard = () => {
      const [currentTime, setCurrentTime] = useState(new Date());
      const [weather, setWeather] = useState(null);
      const [driveData, setDriveData] = useState(null);
      const [transitData, setTransitData] = useState(null);
      const [avoidHighways, setAvoidHighways] = useState(false);
      const [transitStatus, setTransitStatus] = useState({ 
        status: 'loading', 
        message: 'Connecting to RTD server...', 
        lastUpdate: null 
      });
      const [apiEndpoint, setApiEndpoint] = useState('https://rtd-n-line-api.onrender.com/api/rtd/arrivals');
      const [isDarkMode, setIsDarkMode] = useState(true);
      const [showCommuteInfo, setShowCommuteInfo] = useState(false);
      const [manualMode, setManualMode] = useState(null);
      const [driveCollapsed, setDriveCollapsed] = useState(true);
      const [transitCollapsed, setTransitCollapsed] = useState(true);
      
      const rtdStops = {
        southbound: '35254',
        northbound: '34668'
      };

      const config = {
        workSchedule: {
          weekday: { start: '08:00', end: '17:30' },
          friday: { start: '08:00', end: '16:30' }
        },
        locations: {
          home: { lat: 39.8858, lng: -104.9872 },
          garage: { lat: 39.7510, lng: -104.9897 },
          work: { lat: 39.7480, lng: -104.9914 }
        },
        weather: {
          lat: 39.8858,
          lon: -104.9872
        }
      };

      const getTimeMode = () => {
        if (manualMode) return manualMode;
        const hour = currentTime.getHours();
        const day = currentTime.getDay();
        if (day === 0 || day === 6) return 'weekend';
        if (hour < 8) return 'morning';
        if (hour >= 8 && hour < 17) return 'workday';
        return 'evening';
      };

      const timeMode = getTimeMode();
      const shouldShowCommute = timeMode !== 'workday' || showCommuteInfo;

      const calculateLeaveByTime = (arrivalTime, travelMinutes) => {
        const [hours, minutes] = arrivalTime.split(':').map(Number);
        const arrival = new Date(currentTime);
        arrival.setHours(hours, minutes, 0);
        const leaveBy = new Date(arrival.getTime() - (travelMinutes + 10) * 60000);
        return leaveBy.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      };

      useEffect(() => {
        const fetchWeather = async () => {
          try {
            const response = await fetch(
              `https://api.openweathermap.org/data/2.5/weather?lat=${config.weather.lat}&lon=${config.weather.lon}&appid=1c91f81f2adfd1b633d19842869a1a11&units=imperial`
            );
            if (!response.ok) throw new Error('Weather API error');
            const data = await response.json();
            setWeather(data);
          } catch (error) {
            console.error('Weather fetch error:', error);
            setWeather({
              main: { temp: 45, feels_like: 42, humidity: 65 },
              weather: [{ description: 'partly cloudy', icon: '02d' }],
              wind: { speed: 8 },
              visibility: 16093
            });
          }
        };
        fetchWeather();
        const interval = setInterval(fetchWeather, 600000);
        return () => clearInterval(interval);
      }, []);

      useEffect(() => {
        const fetchDriveTime = async () => {
          try {
            const apiKey = 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY';
            const routingPreference = avoidHighways ? 'TRAFFIC_AWARE_OPTIMAL' : 'TRAFFIC_AWARE';
            
            const morningRoute = {
              origin: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
              destination: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
              travelMode: 'DRIVE',
              routingPreference: routingPreference,
              ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
              computeAlternativeRoutes: false,
              languageCode: 'en-US',
              units: 'IMPERIAL'
            };
            
            const eveningRoute = {
              origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
              destination: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
              travelMode: 'DRIVE',
              routingPreference: routingPreference,
              ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
              computeAlternativeRoutes: false,
              languageCode: 'en-US',
              units: 'IMPERIAL'
            };
            
            const walkRoute = {
              origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
              destination: { location: { latLng: { latitude: config.locations.work.lat, longitude: config.locations.work.lng }}},
              travelMode: 'WALK',
              computeAlternativeRoutes: false,
              languageCode: 'en-US',
              units: 'IMPERIAL'
            };
            
            const [morningRes, eveningRes, walkRes] = await Promise.all([
              fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
                body: JSON.stringify(morningRoute)
              }),
              fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
                body: JSON.stringify(eveningRoute)
              }),
              fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': apiKey, 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
                body: JSON.stringify(walkRoute)
              })
            ]);
            
            const morningData = await morningRes.json();
            const eveningData = await eveningRes.json();
            const walkData = await walkRes.json();
            
            if (morningData.routes && morningData.routes.length > 0) {
              const morningDuration = parseInt(morningData.routes[0].duration.replace('s', ''));
              const morningDistance = morningData.routes[0].distanceMeters;
              const eveningDuration = parseInt(eveningData.routes[0].duration.replace('s', ''));
              const eveningDistance = eveningData.routes[0].distanceMeters;
              const walkDuration = parseInt(walkData.routes[0].duration.replace('s', ''));
              const walkDistance = walkData.routes[0].distanceMeters;
              
              setDriveData({
                morning: {
                  duration: { text: `${Math.round(morningDuration / 60)} mins`, value: morningDuration },
                  distance: { text: `${(morningDistance * 0.000621371).toFixed(1)} mi` }
                },
                evening: {
                  duration: { text: `${Math.round(eveningDuration / 60)} mins`, value: eveningDuration },
                  distance: { text: `${(eveningDistance * 0.000621371).toFixed(1)} mi` }
                },
                walk: {
                  duration: { text: `${Math.round(walkDuration / 60)} mins`, value: walkDuration },
                  distance: { text: `${(walkDistance * 0.000621371).toFixed(1)} mi` }
                }
              });
            } else {
              throw new Error('No routes returned');
            }
          } catch (error) {
            console.error('Drive time error:', error);
            const hour = currentTime.getHours();
            let trafficMultiplier = 1;
            if (hour >= 7 && hour <= 9) trafficMultiplier = 1.3;
            else if (hour >= 16 && hour <= 18) trafficMultiplier = 1.4;
            
            setDriveData({
              morning: { duration: { text: `${Math.round(30 * trafficMultiplier)} mins`, value: 1800 * trafficMultiplier }, distance: { text: '14.2 mi' }},
              evening: { duration: { text: `${Math.round(30 * trafficMultiplier)} mins`, value: 1800 * trafficMultiplier }, distance: { text: '14.2 mi' }},
              walk: { duration: { text: '8 mins', value: 480 }, distance: { text: '0.4 mi' }}
            });
          }
        };
        
        fetchDriveTime();
        const interval = setInterval(fetchDriveTime, 300000);
        return () => clearInterval(interval);
      }, [avoidHighways, currentTime.getHours()]);

      useEffect(() => {
        const fetchTransitData = async () => {
          const startTime = Date.now();
          
          try {
            setTransitStatus({ 
              status: 'loading', 
              message: 'Fetching train data...', 
              lastUpdate: transitStatus.lastUpdate 
            });
            
            const direction = (timeMode === 'morning' || timeMode === 'workday') ? 'southbound' : 'northbound';
            const stopId = rtdStops[direction];
            
            const url = `${apiEndpoint}/${stopId}?t=${Date.now()}`;
            
            const response = await fetch(url, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache',
              headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
              signal: AbortSignal.timeout(30000)
            });
            
            const loadTime = Date.now() - startTime;
            
            if (loadTime > 5000) {
              setTransitStatus({ 
                status: 'waking', 
                message: `Server woke up in ${Math.round(loadTime/1000)}s`, 
                lastUpdate: new Date() 
              });
            }
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            let upcomingTrains = [];
            
            if (data.arrivals && Array.isArray(data.arrivals) && data.arrivals.length > 0) {
              const filteredArrivals = data.arrivals.filter(arrival => {
                if (direction === 'southbound') {
                  return arrival.directionId === 1;
                } else {
                  return arrival.directionId === 0;
                }
              });
              
              upcomingTrains = filteredArrivals
                .slice(0, 3)
                .map(arrival => {
                  let arrivalTimestamp = null;
                  let displayTime = arrival.arrivalTimeFormatted;
                  
                  if (arrival.arrivalTime && typeof arrival.arrivalTime === 'number') {
                    arrivalTimestamp = arrival.arrivalTime * 1000;
                    const arrivalDate = new Date(arrivalTimestamp);
                    displayTime = arrivalDate.toLocaleTimeString('en-US', { 
                      hour: 'numeric', 
                      minute: '2-digit',
                      hour12: true 
                    });
                  }
                  
                  return {
                    time: displayTime,
                    arrivalTimestamp: arrivalTimestamp,
                    delay: 0,
                    status: arrival.status || 'On Time',
                    vehicleId: arrival.vehicleId
                  };
                });
              
              setTransitData(upcomingTrains);
              setTransitStatus({ 
                status: 'live', 
                message: `Live data ‚Ä¢ ${upcomingTrains.length} trains ‚Ä¢ ${data.stopName || 'N Line'}`, 
                lastUpdate: new Date() 
              });
            } else {
              throw new Error('No arrivals data');
            }
            
          } catch (error) {
            console.error('Transit error:', error);
            setTransitStatus({ 
              status: 'error', 
              message: `Error: ${error.message}`, 
              lastUpdate: transitStatus.lastUpdate 
            });
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const baseSchedule = timeMode === 'morning' || timeMode === 'workday' 
              ? [405, 425, 445, 465, 485, 505, 525, 545, 565]
              : [1020, 1040, 1060, 1080, 1100, 1120, 1140];
            
            const upcomingTrains = baseSchedule.filter(m => m > currentMinutes).slice(0, 3).map(minutes => {
              const trainTime = new Date(now);
              trainTime.setHours(Math.floor(minutes / 60), minutes % 60, 0);
              return {
                time: trainTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                arrivalTimestamp: trainTime.getTime(),
                status: 'Estimated (API Offline)'
              };
            });
            setTransitData(upcomingTrains.length > 0 ? upcomingTrains : null);
          }
        };

        fetchTransitData();
        const interval = setInterval(fetchTransitData, 60000);
        return () => clearInterval(interval);
      }, [timeMode, apiEndpoint]);

      useEffect(() => {
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      const themeColors = {
        light: {
          morning: 'from-orange-50 to-yellow-50',
          workday: 'from-blue-50 to-slate-50',
          evening: 'from-purple-50 to-indigo-50',
          weekend: 'from-green-50 to-teal-50'
        },
        dark: {
          morning: 'from-gray-900 to-gray-800',
          workday: 'from-slate-900 to-slate-800',
          evening: 'from-gray-900 to-indigo-950',
          weekend: 'from-slate-900 to-gray-800'
        }
      };

      const currentTheme = isDarkMode ? themeColors.dark[timeMode] : themeColors.light[timeMode];
      const textColor = isDarkMode ? 'text-white' : 'text-gray-800';
      const cardBg = isDarkMode ? 'bg-gray-800' : 'bg-white';
      const textMuted = isDarkMode ? 'text-gray-400' : 'text-gray-600';

      const isFriday = currentTime.getDay() === 5;
      const leaveTime = isFriday ? '4:30 PM' : '5:30 PM';
      const totalMorningMinutes = driveData ? (driveData.morning.duration.value + driveData.walk.duration.value) / 60 : 23;
      const leaveByTime = calculateLeaveByTime('07:30', totalMorningMinutes);

      if (!weather || !driveData || !transitData) {
        return (
          <div className={`min-h-screen bg-gradient-to-br ${currentTheme} flex items-center justify-center`}>
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
              <div className={`text-xl ${textColor}`}>Loading your commute data...</div>
            </div>
          </div>
        );
      }
      return (
        <div className={`min-h-screen bg-gradient-to-br ${currentTheme} p-6 transition-all duration-1000`}>
          <div className="max-w-6xl mx-auto">
            <div className="mb-8">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className={`text-4xl font-bold ${textColor}`}>
                    {timeMode === 'morning' && 'üåÖ Good Morning'}
                    {timeMode === 'workday' && 'üíº Work Mode'}
                    {timeMode === 'evening' && 'üåÜ Evening Commute'}
                    {timeMode === 'weekend' && '‚òÄÔ∏è Weekend'}
                  </h1>
                  <p className={`text-xl ${textMuted}`}>
                    {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} ‚Ä¢ {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </div>
                
                <div className="flex flex-wrap gap-2 justify-end">
                  <button
                    onClick={() => setIsDarkMode(!isDarkMode)}
                    className={`px-4 py-2 rounded-lg font-medium transition-all ${
                      isDarkMode 
                        ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-400' 
                        : 'bg-gray-800 text-white hover:bg-gray-700'
                    }`}
                  >
                    {isDarkMode ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                  </button>
                  
                  {timeMode === 'morning' && (
                    <button
                      onClick={() => setManualMode('evening')}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-all"
                    >
                      üåÜ Switch to Evening
                    </button>
                  )}
                  
                  {timeMode === 'evening' && (
                    <button
                      onClick={() => setManualMode('morning')}
                      className="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition-all"
                    >
                      üåÖ Switch to Morning
                    </button>
                  )}
                  
                  {timeMode === 'workday' && (
                    <button
                      onClick={() => setShowCommuteInfo(!showCommuteInfo)}
                      className={`px-4 py-2 rounded-lg font-medium transition-all ${
                        showCommuteInfo
                          ? 'bg-blue-600 text-white hover:bg-blue-700'
                          : 'bg-green-600 text-white hover:bg-green-700'
                      }`}
                    >
                      {showCommuteInfo ? 'üíº Hide Commute' : 'üëÅÔ∏è Show Commute'}
                    </button>
                  )}
                  
                  {manualMode && (
                    <button
                      onClick={() => setManualMode(null)}
                      className="px-4 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-all"
                    >
                      üîÑ Auto Mode
                    </button>
                  )}
                </div>
              </div>
            </div>

            <div className={`${cardBg} rounded-2xl shadow-xl p-6 mb-6 ${isDarkMode ? 'border border-gray-700' : ''}`}>
              <div className="flex items-center gap-3 mb-6">
                <svg className={`w-8 h-8 ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
                <h2 className={`text-2xl font-bold ${textColor}`}>Today's Schedule</h2>
              </div>
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  {timeMode === 'morning' && (
                    <div className="space-y-4">
                      <div className={`border-l-4 border-orange-500 p-4 rounded ${isDarkMode ? 'bg-orange-900 bg-opacity-30' : 'bg-orange-50'}`}>
                        <p className={`text-sm font-semibold mb-1 ${isDarkMode ? 'text-orange-400' : 'text-orange-800'}`}>‚è∞ LEAVE BY</p>
                        <p className={`text-3xl font-bold ${isDarkMode ? 'text-orange-300' : 'text-orange-900'}`}>{leaveByTime}</p>
                        <p className={`text-xs mt-2 ${isDarkMode ? 'text-orange-400' : 'text-orange-700'}`}>Includes 10 min buffer + traffic</p>
                      </div>
                      <div className={`p-4 rounded ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                        <p className={`text-sm font-semibold mb-1 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>Recommended Arrival</p>
                        <p className={`text-2xl font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>7:30 AM</p>
                      </div>
                      <div className={`p-4 rounded ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <p className={`text-sm ${textMuted}`}>Work Starts: <span className={`font-bold ${textColor}`}>8:00 AM</span></p>
                        <p className={`text-sm ${textMuted}`}>Work Ends: <span className={`font-bold ${textColor}`}>{isFriday ? '4:30 PM' : '5:30 PM'}</span></p>
                      </div>
                      <div className={`p-3 rounded text-center ${isDarkMode ? 'bg-green-900 bg-opacity-30' : 'bg-green-50'}`}>
                        <p className={`text-sm font-medium ${isDarkMode ? 'text-green-400' : 'text-green-800'}`}>üí™ Time to get moving!</p>
                      </div>
                    </div>
                  )}
                  {timeMode === 'workday' && (
                    <div className="space-y-4">
                      <div className={`p-4 rounded ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                        <p className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>üìç Currently at Work</p>
                        <p className={`text-lg ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>Work ends at <span className="font-bold">{isFriday ? '4:30 PM' : '5:30 PM'}</span></p>
                      </div>
                      <div className={`p-4 rounded text-center ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <p className="text-2xl mb-2">‚òï</p>
                        <p className={`text-sm ${textMuted}`}>You're doing great!</p>
                      </div>
                    </div>
                  )}
                  {timeMode === 'evening' && (
                    <div className="space-y-4">
                      <div className={`border-l-4 border-purple-500 p-4 rounded ${isDarkMode ? 'bg-purple-900 bg-opacity-30' : 'bg-purple-50'}`}>
                        <p className={`text-sm font-semibold mb-1 ${isDarkMode ? 'text-purple-400' : 'text-purple-800'}`}>üè† Heading Home</p>
                        <p className={`text-lg ${isDarkMode ? 'text-purple-300' : 'text-purple-900'}`}>Leaving at <span className="font-bold">{leaveTime}</span></p>
                      </div>
                      <div className={`p-4 rounded ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                        <p className={`text-sm font-semibold mb-1 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>Expected Arrival</p>
                        <p className={`text-2xl font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>
                          {new Date(new Date().setHours(isFriday ? 16 : 17, isFriday ? 30 : 30) + (driveData?.evening?.duration?.value || 1080) * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                        </p>
                      </div>
                    </div>
                  )}
                  {timeMode === 'weekend' && (
                    <div className={`p-6 rounded-xl text-center ${isDarkMode ? 'bg-green-900 bg-opacity-30' : 'bg-green-50'}`}>
                      <p className="text-4xl mb-3">üéâ</p>
                      <p className={`text-xl font-bold ${isDarkMode ? 'text-green-300' : 'text-green-900'}`}>Enjoy your weekend!</p>
                    </div>
                  )}
                </div>
                <div className={`bg-gradient-to-br p-6 rounded-xl ${isDarkMode ? 'from-sky-900 to-blue-900' : 'from-sky-100 to-blue-100'}`}>
                  <div className="flex items-center gap-2 mb-4">
                    <svg className={`w-6 h-6 ${isDarkMode ? 'text-blue-300' : 'text-blue-700'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 15a4 4 0 104 4H3m18-4a4 4 0 11-4 4m0 0a5 5 0 015-5"></path></svg>
                    <h3 className={`text-lg font-bold ${isDarkMode ? 'text-blue-100' : 'text-blue-900'}`}>Current Weather</h3>
                  </div>
                  {weather && (
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className={`text-5xl font-bold ${isDarkMode ? 'text-blue-100' : 'text-blue-900'}`}>{Math.round(weather.main.temp)}¬∞F</span>
                        <img src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png`} alt={weather.weather[0].description} className="w-20 h-20" />
                      </div>
                      <p className={`text-xl capitalize ${isDarkMode ? 'text-blue-200' : 'text-blue-800'}`}>{weather.weather[0].description}</p>
                      <div className={`grid grid-cols-2 gap-2 text-sm ${isDarkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                        <div>Feels like: <span className="font-semibold">{Math.round(weather.main.feels_like)}¬∞F</span></div>
                        <div>Humidity: <span className="font-semibold">{weather.main.humidity}%</span></div>
                        <div>Wind: <span className="font-semibold">{Math.round(weather.wind.speed)} mph</span></div>
                        <div>Visibility: <span className="font-semibold">{(weather.visibility / 1609).toFixed(1)} mi</span></div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {shouldShowCommute && (
              <div className={`${cardBg} rounded-2xl shadow-xl overflow-hidden mb-6 ${isDarkMode ? 'border border-gray-700' : ''}`}>
                <button
                  onClick={() => setDriveCollapsed(!driveCollapsed)}
                  className={`w-full p-6 flex items-center justify-between transition-all ${isDarkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-50'}`}
                >
                  <div className="flex items-center gap-3">
                    <div className="bg-yellow-500 p-3 rounded-xl">
                      <svg className="w-8 h-8 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        <path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-4-1a1 1 0 001 1h3"></path>
                      </svg>
                    </div>
                    <h2 className={`text-2xl font-bold ${textColor}`}>Drive Times</h2>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={`text-sm ${textMuted}`}>Total: {Math.round(totalMorningMinutes)} min</span>
                    <svg className={`w-6 h-6 ${textColor} transition-transform ${!driveCollapsed ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </button>

                {!driveCollapsed && (
                  <div className="px-6 pb-6 space-y-4">
                    <div className="flex items-center justify-between flex-wrap gap-3">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <span className={`text-sm font-medium ${textColor}`}>Avoid Highways</span>
                        <div className="relative">
                          <input type="checkbox" checked={avoidHighways} onChange={(e) => setAvoidHighways(e.target.checked)} className="sr-only" />
                          <div className={`w-14 h-8 rounded-full transition-colors ${avoidHighways ? 'bg-green-500' : 'bg-gray-300'}`}>
                            <div className={`absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform ${avoidHighways ? 'translate-x-6' : ''}`} />
                          </div>
                        </div>
                      </label>
                      
                      <a
                        href={`https://www.google.com/maps/dir/${config.locations.home.lat},${config.locations.home.lng}/${config.locations.work.lat},${config.locations.work.lng}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-all"
                      >
                        üó∫Ô∏è Open Map (Work ‚Üí Home)
                      </a>
                    </div>

                    <div className="grid md:grid-cols-3 gap-4">
                      <div className={`p-5 rounded-xl border-2 ${timeMode === 'morning' ? 'bg-orange-100 border-orange-300 shadow-lg' : isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-orange-50 border-orange-200'}`}>
                        <p className={`text-sm font-semibold mb-3 ${isDarkMode && timeMode !== 'morning' ? 'text-orange-400' : 'text-orange-800'}`}>üöó Home ‚Üí Garage</p>
                        <p className={`text-3xl font-bold mb-1 ${isDarkMode && timeMode !== 'morning' ? 'text-orange-300' : 'text-orange-900'}`}>{driveData.morning.duration.text}</p>
                        <p className={`text-sm ${isDarkMode && timeMode !== 'morning' ? 'text-orange-400' : 'text-orange-700'}`}>{driveData.morning.distance.text}</p>
                        {timeMode === 'morning' && (<div className="mt-3 pt-3 border-t border-orange-300"><p className="text-xs text-orange-700 font-medium">üî¥ Live traffic</p></div>)}
                      </div>

                      <div className={`p-5 rounded-xl border-2 ${isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-blue-50 border-blue-200'}`}>
                        <p className={`text-sm font-semibold mb-3 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>üö∂ Garage ‚Üí Work</p>
                        <p className={`text-3xl font-bold mb-1 ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>{driveData.walk.duration.text}</p>
                        <p className={`text-sm ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{driveData.walk.distance.text}</p>
                        <div className={`mt-3 pt-3 border-t ${isDarkMode ? 'border-gray-600' : 'border-blue-200'}`}><p className={`text-xs font-medium ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`}>Walking time</p></div>
                      </div>

                      <div className={`p-5 rounded-xl border-2 ${timeMode === 'evening' ? 'bg-purple-100 border-purple-300 shadow-lg' : isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-purple-50 border-purple-200'}`}>
                        <p className={`text-sm font-semibold mb-3 ${isDarkMode && timeMode !== 'evening' ? 'text-purple-400' : 'text-purple-800'}`}>üè† Garage ‚Üí Home</p>
                        <p className={`text-3xl font-bold mb-1 ${isDarkMode && timeMode !== 'evening' ? 'text-purple-300' : 'text-purple-900'}`}>{driveData.evening.duration.text}</p>
                        <p className={`text-sm ${isDarkMode && timeMode !== 'evening' ? 'text-purple-400' : 'text-purple-700'}`}>{driveData.evening.distance.text}</p>
                        {timeMode === 'evening' && (<div className="mt-3 pt-3 border-t border-purple-300"><p className="text-xs text-purple-700 font-medium">üî¥ Live traffic</p></div>)}
                      </div>
                    </div>

                    <div className={`p-4 rounded-lg flex items-start gap-3 ${isDarkMode ? 'bg-yellow-900 bg-opacity-30' : 'bg-yellow-50'}`}>
                      <svg className="w-5 h-5 text-yellow-700 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4m0 4h.01"></path></svg>
                      <p className={`text-sm ${isDarkMode ? 'text-yellow-300' : 'text-yellow-800'}`}>
                        <span className="font-semibold">Total: </span>{Math.round(totalMorningMinutes)} min (drive + walk) ‚Ä¢ Leave by {leaveByTime}
                      </p>
                    </div>

                    <a
                      href={`https://www.google.com/maps/dir/${config.locations.garage.lat},${config.locations.garage.lng}/${config.locations.home.lat},${config.locations.home.lng}/@${config.locations.home.lat},${config.locations.home.lng},12z/data=!4m2!4m1!3e0!5m1!1e1`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="block w-full py-3 bg-yellow-500 text-gray-900 rounded-lg text-center font-semibold hover:bg-yellow-400 transition-all"
                    >
                      üö¶ View Live Traffic (Work ‚Üí Home)
                    </a>
                  </div>
                )}
              </div>
            )}
            {shouldShowCommute && (
              <div className={`${cardBg} rounded-2xl shadow-xl overflow-hidden mb-6 ${isDarkMode ? 'border border-gray-700' : ''}`}>
                <button
                  onClick={() => setTransitCollapsed(!transitCollapsed)}
                  className={`w-full p-6 flex items-center justify-between transition-all ${isDarkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-50'}`}
                >
                  <div className="flex items-center gap-3">
                    <div className="bg-indigo-500 p-3 rounded-xl">
                      <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                      </svg>
                    </div>
                    <div>
                      <h2 className={`text-2xl font-bold ${textColor}`}>RTD N Line</h2>
                      <p className={`text-sm ${textMuted}`}>{timeMode === 'morning' || timeMode === 'workday' ? 'Southbound' : 'Northbound'}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {transitStatus.status === 'live' && (<div className="flex items-center gap-2 bg-green-100 px-3 py-1.5 rounded-full"><div className="w-2 h-2 bg-green-500 rounded-full"></div><span className="text-xs font-medium text-green-700">Live</span></div>)}
                    {transitStatus.status === 'error' && (<div className="flex items-center gap-2 bg-red-100 px-3 py-1.5 rounded-full"><div className="w-2 h-2 bg-red-500 rounded-full"></div><span className="text-xs font-medium text-red-700">Offline</span></div>)}
                    <svg className={`w-6 h-6 ${textColor} transition-transform ${!transitCollapsed ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </button>

                {!transitCollapsed && (
                  <div className="px-6 pb-6">
                    <div className={`mb-4 p-3 rounded-lg ${transitStatus.status === 'live' ? isDarkMode ? 'bg-green-900 bg-opacity-30' : 'bg-green-50' : isDarkMode ? 'bg-red-900 bg-opacity-30' : 'bg-red-50'}`}>
                      <div className="flex items-center justify-between">
                        <p className={`text-sm font-medium ${transitStatus.status === 'live' ? isDarkMode ? 'text-green-300' : 'text-green-900' : isDarkMode ? 'text-red-300' : 'text-red-900'}`}>
                          {transitStatus.status === 'live' && 'üöÜ '}{transitStatus.status === 'error' && '‚ö†Ô∏è '}
                          {timeMode === 'morning' || timeMode === 'workday' ? 'To Downtown / Union Station' : 'To Northglenn/112th'}
                        </p>
                        {transitStatus.lastUpdate && (<span className={`text-xs ${textMuted}`}>Updated {transitStatus.lastUpdate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>)}
                      </div>
                      <p className={`text-xs mt-1 ${transitStatus.status === 'live' ? isDarkMode ? 'text-green-400' : 'text-green-700' : isDarkMode ? 'text-red-400' : 'text-red-700'}`}>{transitStatus.message}</p>
                    </div>

                    <div className="space-y-3">
                      {transitData && transitData.map((train, idx) => {
                        let countdown = 0;
                        let countdownSeconds = 0;
                        if (train.arrivalTimestamp) {
                          const totalSeconds = (train.arrivalTimestamp - currentTime.getTime()) / 1000;
                          countdown = totalSeconds / 60;
                          countdownSeconds = Math.floor(Math.abs(totalSeconds % 60));
                        }

                        const isPast = countdown < -0.12;
                        const isNext = !isPast && idx === 0;
                        const isDeparting = countdown <= 0.25 && countdown > -0.12;
                        const isUrgent = countdown <= 2 && countdown > 0.25;
                        const isArriving = countdown <= 15 && countdown > 2;
                        const showArrivingMessage = isArriving && Math.floor(currentTime.getSeconds() / 10) % 2 === 0;
                        
                        return (
                          <div 
                            key={idx}
                            className={`p-4 rounded-xl border-2 transition-all ${
                              isPast 
                                ? isDarkMode ? 'bg-gray-900 border-gray-700 opacity-50' : 'bg-gray-50 border-gray-200 opacity-50'
                                : isDeparting
                                ? 'bg-red-100 border-red-500 shadow-lg animate-pulse'
                                : isUrgent 
                                ? isDarkMode ? 'bg-red-900 bg-opacity-50 border-red-600 shadow-lg animate-pulse' : 'bg-red-50 border-red-400 shadow-lg animate-pulse'
                                : isNext 
                                ? isDarkMode ? 'bg-indigo-900 bg-opacity-50 border-indigo-500 shadow-md' : 'bg-gradient-to-r from-indigo-100 to-purple-100 border-indigo-400 shadow-md'
                                : isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-slate-50 border-slate-200'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div>
                                <p className={`text-2xl font-bold ${
                                  isPast ? 'text-gray-400' 
                                  : isDeparting ? 'text-red-900' 
                                  : isUrgent ? isDarkMode ? 'text-red-300' : 'text-red-800'
                                  : isNext ? isDarkMode ? 'text-indigo-300' : 'text-indigo-900'
                                  : isDarkMode ? 'text-gray-200' : 'text-slate-800'
                                }`}>
                                  {train.time}
                                </p>
                                <div className="flex items-center gap-2">
                                  <p className={`text-sm font-medium ${
                                    isPast ? 'text-gray-400' 
                                    : isDeparting ? 'text-red-700' 
                                    : isUrgent ? isDarkMode ? 'text-red-400' : 'text-red-700'
                                    : isArriving ? isDarkMode ? 'text-yellow-400' : 'text-yellow-700'
                                    : isNext ? isDarkMode ? 'text-indigo-400' : 'text-indigo-700'
                                    : isDarkMode ? 'text-gray-400' : 'text-slate-600'
                                  }`}>
                                    {isPast ? 'Departed' 
                                    : isDeparting ? 'üö® DEPARTING NOW' 
                                    : showArrivingMessage ? '‚ö†Ô∏è TRAIN ARRIVING SOON'
                                    : isNext ? 'üöÜ Next train' 
                                    : `Train ${idx + 1}`}
                                  </p>
                                  {train.status && train.status !== 'On Time' && !isPast && (
                                    <span className={`text-xs px-2 py-0.5 rounded ${isDarkMode ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-700'}`}>
                                      {train.status}
                                    </span>
                                  )}
                                </div>
                              </div>
                              <div className="text-right">
                                {!isPast && !isDeparting && (
                                  <div className="flex flex-col items-end">
                                    <div className="flex items-baseline justify-end gap-1">
                                      <p className={`text-3xl font-bold ${
                                        isUrgent ? isDarkMode ? 'text-red-300' : 'text-red-800'
                                        : isArriving ? isDarkMode ? 'text-yellow-400' : 'text-yellow-700'
                                        : isNext ? isDarkMode ? 'text-indigo-300' : 'text-indigo-900'
                                        : isDarkMode ? 'text-gray-300' : 'text-slate-700'
                                      }`}>
                                        {Math.floor(Math.abs(countdown))}
                                      </p>
                                      <p className={`text-lg font-medium ${
                                        isUrgent ? isDarkMode ? 'text-red-400' : 'text-red-700'
                                        : isArriving ? isDarkMode ? 'text-yellow-500' : 'text-yellow-600'
                                        : isNext ? isDarkMode ? 'text-indigo-400' : 'text-indigo-700'
                                        : isDarkMode ? 'text-gray-400' : 'text-slate-600'
                                      }`}>
                                        :{countdownSeconds.toString().padStart(2, '0')}
                                      </p>
                                    </div>
                                    <p className={`text-sm ${
                                      isUrgent ? isDarkMode ? 'text-red-400' : 'text-red-700'
                                      : isArriving ? isDarkMode ? 'text-yellow-500' : 'text-yellow-600'
                                      : isNext ? isDarkMode ? 'text-indigo-400' : 'text-indigo-700'
                                      : isDarkMode ? 'text-gray-400' : 'text-slate-600'
                                    }`}>
                                      minutes
                                    </p>
                                  </div>
                                )}
                                {isDeparting && (
                                  <div className="flex flex-col items-center">
                                    <svg className="w-10 h-10 text-red-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <p className="text-xs text-red-700 font-bold mt-1">GO NOW!</p>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                      
                      {(!transitData || transitData.length === 0) && (
                        <div className={`p-6 text-center rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                          <p className={textMuted}>No upcoming trains at this time</p>
                        </div>
                      )}
                    </div>

                    <div className={`mt-4 p-4 rounded-lg ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                      <div className="flex items-center justify-between">
                        <p className={`text-sm ${isDarkMode ? 'text-blue-300' : 'text-blue-800'}`}>
                          {transitStatus.status === 'live' ? (<><span className="font-semibold">üî¥ Live RTD data</span> ‚Ä¢ Updates every minute</>) : transitStatus.status === 'error' ? (<><span className="font-semibold">‚ö†Ô∏è Using estimates</span> ‚Ä¢ Will retry in 1 min</>) : (<><span className="font-semibold">üîÑ Connecting</span> ‚Ä¢ Fetching data...</>)}
                        </p>
                        {transitStatus.status === 'error' && (<button onClick={() => window.location.reload()} className="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Retry</button>)}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            <div className={`mt-8 text-center text-sm ${textMuted}`}>
              <p>üîÑ Auto-refresh: Weather (10 min) ‚Ä¢ Traffic (5 min) ‚Ä¢ Transit (1 min)</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<CommuteDashboard />, document.getElementById('root'));
  </script>
</body>
</html>