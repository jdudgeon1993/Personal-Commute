<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commute Dashboard ‚Äî Drive & N Line</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f3f6fb;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#4f46e5;
    --success:#10b981;
    --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0f1724;
      --card:#111827;
      --muted:#9ca3af;
      --accent:#7c89ff;
      --success:#34d399;
      --shadow: 0 12px 28px rgba(2,6,23,0.6);
    }
  }

  html,body{height:100%;}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;
    background:var(--bg);
    color: #0f1724;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    justify-content:center;
    padding:20px;
  }

  .app {
    width:100%;
    max-width:880px;
  }

  header{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:18px;
  }
  h1{
    margin:0;
    font-size:20px;
    font-weight:800;
    letter-spacing:-0.4px;
  }
  .controls{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .btn{
    padding:8px 12px;
    border-radius:10px;
    border: none;
    font-weight:600;
    cursor:pointer;
    background:var(--accent);
    color:white;
    box-shadow: var(--shadow);
  }
  .btn.ghost{
    background:transparent;
    color:var(--muted);
    border:1px solid rgba(0,0,0,0.06);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
  }
  @media(min-width:900px){
    .grid{ grid-template-columns: 1fr 1fr; }
  }

  .card{
    background:var(--card);
    border-radius:14px;
    padding:16px;
    box-shadow: var(--shadow);
    display:flex;
    gap:12px;
    align-items:flex-start;
  }

  .card .left{
    width:56px;
    height:56px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:white;
    flex-shrink:0;
  }
  .card h3{ margin:0; font-size:16px; }
  .muted{ color:var(--muted); font-size:13px; margin-top:6px; }
  .big{ font-weight:700; font-size:18px; margin-top:6px; }

  .icon-weather{ background:linear-gradient(135deg,#ffd166,#ff9a66); color:#1f2937; }
  .icon-drive{ background:linear-gradient(135deg,#60a5fa,#4f46e5); }
  .icon-transit{ background:linear-gradient(135deg,#34d399,#10b981); color:#052e16; }

  .small-note{ font-size:12px; color:var(--muted); margin-top:8px; }

  .status-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .pill{ padding:6px 10px; border-radius:999px; font-weight:600; background:rgba(0,0,0,0.04); color:var(--muted); font-size:13px; }

  footer{ margin-top:12px; color:var(--muted); font-size:13px; text-align:center; }

</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Commute Dashboard</h1>
        <div class="small-note">Drive & N Line (preset routes for your commute)</div>
      </div>

      <div class="controls">
        <button class="btn" id="refreshBtn" title="Refresh now">‚ü≥ Refresh</button>
        <button class="btn ghost" id="themeToggle" title="Toggle theme">Toggle Theme</button>
      </div>
    </header>

    <main class="grid">
      <!-- WEATHER -->
      <section class="card" id="weatherCard">
        <div class="left icon-weather" id="weatherIcon">‚òÄÔ∏è</div>
        <div style="flex:1">
          <h3>Current Weather ‚Äî Denver</h3>
          <div class="big" id="weatherTemp">Loading‚Ä¶</div>
          <div class="muted" id="weatherDesc"></div>
          <div class="status-row">
            <div class="pill" id="weatherFeels">‚Äî</div>
            <div class="pill" id="weatherWind">‚Äî</div>
            <div class="pill" id="weatherHumidity">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- DRIVE TO WORK -->
      <section class="card">
        <div class="left icon-drive">üöó</div>
        <div style="flex:1">
          <h3>Drive ‚Üí Work</h3>
          <div class="muted">Home ‚Üí Work</div>
          <div class="big" id="driveToWork">Loading‚Ä¶</div>
          <div class="muted small-note" id="driveToNote">ETA & traffic</div>
        </div>
      </section>

      <!-- DRIVE HOME -->
      <section class="card">
        <div class="left icon-drive">üè†</div>
        <div style="flex:1">
          <h3>Drive ‚Üí Home</h3>
          <div class="muted">Work ‚Üí Home</div>
          <div class="big" id="driveToHome">Loading‚Ä¶</div>
          <div class="muted small-note" id="driveHomeNote">ETA & traffic</div>
        </div>
      </section>

      <!-- TRANSIT TO WORK -->
      <section class="card">
        <div class="left icon-transit">üöÜ</div>
        <div style="flex:1">
          <h3>N Line ‚Üí Union Station</h3>
          <div class="muted">Northglenn & 112th ‚Üí Union Station</div>
          <div class="big" id="trainToWork">Loading‚Ä¶</div>
          <div class="muted small-note" id="trainToNote"></div>
        </div>
      </section>

      <!-- TRANSIT HOME -->
      <section class="card">
        <div class="left icon-transit">‚Ü©Ô∏è</div>
        <div style="flex:1">
          <h3>N Line ‚Üí Northglenn</h3>
          <div class="muted">Union Station ‚Üí Northglenn & 112th</div>
          <div class="big" id="trainToHome">Loading‚Ä¶</div>
          <div class="muted small-note" id="trainHomeNote"></div>
        </div>
      </section>
    </main>

    <footer>
      Auto-refresh every 3 minutes ‚Ä¢ You can click Refresh anytime
    </footer>
  </div>

<script>
/*
  CLIENT-SIDE MAPS SERVICES (no REST fetch to Google)
  - uses DistanceMatrixService for driving
  - uses DirectionsService for transit (train-only), filters for N Line
  - OpenWeather used for weather (public fetch)
*/

// ========== CONFIG (presets) ==========
const OPENWEATHER_API_KEY = '1c91f81f2adfd1b633d19842869a1a11';
const GOOGLE_MAPS_API_KEY = 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY';

// Preset locations (as you provided)
const HOME = '11625 Community Center Drive, Northglenn, CO 80233';
const WORK = '707 17th Street, Denver, CO 80202';
const N_ORIGIN = 'Northglenn & 112th Station, Northglenn, CO';
const N_DEST = 'Denver Union Station, Denver, CO';

// DOM refs
const weatherTempEl = document.getElementById('weatherTemp');
const weatherDescEl = document.getElementById('weatherDesc');
const weatherIconEl = document.getElementById('weatherIcon');
const weatherFeelsEl = document.getElementById('weatherFeels');
const weatherWindEl = document.getElementById('weatherWind');
const weatherHumidityEl = document.getElementById('weatherHumidity');

const driveToWorkEl = document.getElementById('driveToWork');
const driveToHomeEl = document.getElementById('driveToHome');

const trainToWorkEl = document.getElementById('trainToWork');
const trainToHomeEl = document.getElementById('trainToHome');

const trainToNoteEl = document.getElementById('trainToNote');
const trainHomeNoteEl = document.getElementById('trainHomeNote');

// Map services (initialized in initMap)
let directionsService = null;
let distanceMatrixService = null;

// ========== Weather (OpenWeather) ==========
async function fetchWeather() {
  try {
    const res = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?q=Denver,US&units=imperial&appid=${OPENWEATHER_API_KEY}`
    );
    const data = await res.json();
    if (!data || data.cod && data.cod !== 200) throw new Error('Weather error');

    const temp = Math.round(data.main.temp) + '¬∞F';
    const desc = data.weather?.[0]?.description ?? '‚Äî';
    const icon = data.weather?.[0]?.icon;
    const feels = Math.round(data.main.feels_like) + '¬∞F';
    const wind = `${Math.round(data.wind.speed)} mph`;
    const humidity = `${data.main.humidity}%`;

    weatherTempEl.textContent = temp;
    weatherDescEl.textContent = desc[0]?.toUpperCase() + desc.slice(1);
    weatherFeelsEl.textContent = `Feels: ${feels}`;
    weatherWindEl.textContent = `Wind: ${wind}`;
    weatherHumidityEl.textContent = `Humidity: ${humidity}`;

    if (icon) {
      weatherIconEl.textContent = '';
      const img = document.createElement('img');
      img.src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
      img.alt = desc;
      img.style.width = '48px';
      img.style.height = '48px';
      img.style.borderRadius = '8px';
      weatherIconEl.appendChild(img);
    }
  } catch (err) {
    console.error('Weather error', err);
    weatherTempEl.textContent = 'Error loading weather';
    weatherDescEl.textContent = '';
    weatherFeelsEl.textContent = '';
    weatherWindEl.textContent = '';
    weatherHumidityEl.textContent = '';
    weatherIconEl.textContent = '‚ö†Ô∏è';
  }
}

// ========== Driving (DistanceMatrixService) ==========
function getDriveTime(origin, destination, el) {
  if (!distanceMatrixService) {
    el.textContent = 'Maps service not ready';
    return;
  }

  el.textContent = 'Loading‚Ä¶';

  distanceMatrixService.getDistanceMatrix({
    origins: [origin],
    destinations: [destination],
    travelMode: google.maps.TravelMode.DRIVING,
    drivingOptions: {
      departureTime: new Date(),
      trafficModel: 'bestguess'
    },
    unitSystem: google.maps.UnitSystem.IMPERIAL
  }, (response, status) => {
    try {
      if (status !== 'OK') throw new Error('DistanceMatrix status ' + status);
      const info = response.rows?.[0]?.elements?.[0];
      if (!info) throw new Error('No element');

      // Prefer duration_in_traffic if available
      const text = info.duration_in_traffic?.text ?? info.duration?.text ?? 'N/A';
      el.textContent = text;
    } catch (e) {
      console.error('DistanceMatrix error', e);
      el.textContent = 'Error loading drive';
    }
  });
}

// ========== Transit (DirectionsService) ‚Äî filter for N Line ==========
function getNLine(origin, destination, el, noteEl) {
  if (!directionsService) {
    el.textContent = 'Maps service not ready';
    return;
  }

  el.textContent = 'Searching N Line‚Ä¶';
  if (noteEl) noteEl.textContent = '';

  directionsService.route({
    origin,
    destination,
    travelMode: google.maps.TravelMode.TRANSIT,
    transitOptions: { modes: ['RAIL'] },
    unitSystem: google.maps.UnitSystem.IMPERIAL
  }, (result, status) => {
    try {
      if (status !== 'OK') throw new Error('Directions status ' + status);
      const route = result.routes?.[0];
      if (!route) throw new Error('No route');

      const leg = route.legs?.[0];
      if (!leg) throw new Error('No leg');

      // Find a step that is a transit step for the N Line
      const steps = leg.steps || [];
      const nStep = steps.find(s =>
        s.transit && s.transit.line && (
          String(s.transit.line.short_name) === 'N' ||
          (s.transit.line && s.transit.line.name && s.transit.line.name.includes('N Line')) ||
          (s.transit.line && s.transit.line.name && /\bN\b/.test(s.transit.line.name))
        )
      );

      if (!nStep) {
        // If none found ‚Äî show a helpful fallback: show next transit leg if any
        el.textContent = 'No N Line train found for this route right now.';
        if (noteEl) noteEl.textContent = 'Google returned other transit options.';
        return;
      }

      // Display times
      const dep = nStep.transit.departure_time?.text ?? '‚Äî';
      const arr = nStep.transit.arrival_time?.text ?? '‚Äî';
      const total = leg.duration?.text ?? '‚Äî';
      el.textContent = `Departs ${dep} ‚Üí Arrives ${arr} (${total})`;

      // optionally show platform or headsign if available
      const headsign = nStep.transit.headsign || nStep.transit.line?.short_name || '';
      if (noteEl && headsign) noteEl.textContent = `Heads to ${headsign}`;
    } catch (err) {
      console.error('Transit error', err);
      el.textContent = 'Error loading transit';
      if (noteEl) noteEl.textContent = '';
    }
  });
}

// ========== Initialization & refresh ==========
function refreshAll() {
  fetchWeather();

  // Drive
  getDriveTime(HOME, WORK, driveToWorkEl);
  getDriveTime(WORK, HOME, driveToHomeEl);

  // Transit (N Line)
  getNLine(N_ORIGIN, N_DEST, trainToWorkEl, trainToNoteEl);
  getNLine(N_DEST, N_ORIGIN, trainToHomeEl, trainHomeNoteEl);
}

// Hook up manual refresh
document.getElementById('refreshBtn').addEventListener('click', refreshAll);

// theme toggle (simple)
document.getElementById('themeToggle').addEventListener('click', () => {
  // toggle a dark class on body for quick override
  document.documentElement.classList.toggle('force-dark');
  // small visual feedback: invert root colors (quick hack)
  if (document.documentElement.classList.contains('force-dark')) {
    document.body.style.background = '#071126';
  } else {
    document.body.style.background = '';
  }
});

// ========== Google Maps loader + init ==========
function initMap() {
  // create services
  directionsService = new google.maps.DirectionsService();
  distanceMatrixService = new google.maps.DistanceMatrixService();

  // initial refresh
  refreshAll();

  // auto-refresh every 3 minutes
  setInterval(refreshAll, 180000);
}

// Load Google Maps JS API
(function loadGoogleMaps(){
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
  script.async = true;
  script.defer = true;
  script.onerror = () => {
    // If the script fails to load, show errors in cards
    driveToWorkEl.textContent = 'Maps failed to load';
    driveToHomeEl.textContent = 'Maps failed to load';
    trainToWorkEl.textContent = 'Maps failed to load';
    trainToHomeEl.textContent = 'Maps failed to load';
    console.error('Failed to load Google Maps API script ‚Äî check API key or network.');
  };
  document.head.appendChild(script);
})();
</script>
</body>
</html>