<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Taskify Commute Dashboard - Real-time commute information">
  <meta name="theme-color" content="#1e293b">
  <title>Taskify || Commute Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    *:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    /* Fixed bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      padding-bottom: env(safe-area-inset-bottom);
    }
    /* Content area with bottom padding for nav */
    .content-area {
      padding-bottom: 100px;
    }
    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }
    /* Loading skeleton */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .skeleton {
      animation: shimmer 2s infinite;
      background: linear-gradient(to right, #f0f0f0 4%, #f8f8f8 25%, #f0f0f0 36%);
      background-size: 1000px 100%;
    }
    .skeleton-dark {
      animation: shimmer 2s infinite;
      background: linear-gradient(to right, #374151 4%, #4b5563 25%, #374151 36%);
      background-size: 1000px 100%;
    }

    /* Glowing station animations for train arrivals/departures */
    @keyframes glow-arriving {
      0%, 100% {
        box-shadow: 0 0 5px currentColor,
                    0 0 10px currentColor,
                    0 0 15px currentColor;
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 10px currentColor,
                    0 0 20px currentColor,
                    0 0 30px currentColor;
        transform: scale(1.1);
      }
    }

    @keyframes glow-departing {
      0%, 100% {
        box-shadow: 0 0 3px currentColor,
                    0 0 6px currentColor,
                    0 0 9px currentColor;
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 6px currentColor,
                    0 0 12px currentColor,
                    0 0 18px currentColor;
        transform: scale(1.05);
      }
    }

    .station-glow-arriving {
      animation: glow-arriving 1.5s ease-in-out infinite;
    }

    .station-glow-departing {
      animation: glow-departing 2s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    /**
     * Taskify Commute Dashboard - Redesigned with Bottom Navigation
     *
     * FEATURES:
     * - Bottom navigation bar (like Personal Calendar app)
     * - Content hidden until section is clicked
     * - Address-based search (not lat/lng)
     * - 15-minute unified refresh interval
     * - Weather integration in header
     * - Clean, mobile-first layout
     */

    const { useState, useEffect, useCallback } = React;

    // Constants
    const CONSTANTS = {
      REFRESH_INTERVAL: 900000, // 15 minutes
      CLOCK_INTERVAL: 1000, // 1 second for clock
      TRANSIT_INTERVAL: 60000, // 1 minute for transit (needs more frequent updates)
      API_BASE_URL: window.location.origin // Use same origin for API calls
    };

    const config = {
      locations: {
        home: { lat: 39.9066611, lng: -104.987454 },
        garage: { lat: 39.747676849365234, lng: -104.9898452758789 },
        work: { lat: 39.74645233154297, lng: -104.99141693115234 }
      },
      weather: {
        lat: 39.8858,
        lon: -104.9872
      },
      // N Line: All stations from south to north
      nLineStops: {
        unionStation: ['34667', '34668'],  // Terminal - Tracks 1 & 2 (dual-platform for all trains)
        station48thBrighton: ['35246', '35247'],  // Middle - 48th & Brighton/National Western Center Track 1 & 2 (dual-platform)
        station112th: ['35254', '35255'],  // Middle - 112th Ave & Northgenn (dual-platform: Track 1 SB, Track 2 NB)
        terminal124th: ['35367', '35368']  // Terminal - Eastlake/124th Ave (dual-platform for all trains)
      },
      // Legacy N Line stops (keep for backwards compatibility during migration)
      rtdStops: {
        southbound: '35254',
        northbound: '35255'
      },
      // G Line: All stations from west to east
      gLineStops: {
        wardStation: ['34504', '34505'],   // Terminal - Wheat Ridge/Ward Road (dual-platform: EB, WB)
        oldeTown: ['34541', '34542'],      // Middle - Olde Town Arvada (dual-platform: EB, WB)
        goldStrike: ['34525', '34526'],    // Middle - 60th/Sheridan Gold Strike (dual-platform: Track 1 & 2)
        pecosJunction: ['34544', '34543'], // Middle - Transfer point (dual-platform: Track 1 NB, Track 2 SB)
        unionStation: '34781'      // Terminal - Track 7 (eastbound endpoint)
      },
      // B Line: All stations from south to north
      bLineStops: {
        unionStation: '34782',     // Terminal - Track 8 (southbound endpoint)
        pecosJunction: ['34544', '34543'], // Middle - Transfer point (dual-platform: Track 1 NB, Track 2 SB)
        westminster: ['34560', '34561']    // Terminal - Westminster (dual-platform: SB, NB)
      }
    };

    const CommuteDashboard = () => {
      // State
      const [currentTime, setCurrentTime] = useState(new Date());
      const [activeSection, setActiveSection] = useState('drive'); // drive, nline, bus, search
      const [weather, setWeather] = useState(null);
      const [driveData, setDriveData] = useState(null);
      const [transitDataSB, setTransitDataSB] = useState(null);
      const [transitDataNB, setTransitDataNB] = useState(null);
      const [gLineEastbound, setGLineEastbound] = useState(null); // Trains going to Union Station
      const [gLineWestbound, setGLineWestbound] = useState(null); // Trains going to Olde Town
      const [bLineSouthbound, setBLineSouthbound] = useState(null); // Trains going to Union Station
      const [bLineNorthbound, setBLineNorthbound] = useState(null); // Trains going to Westminster
      const [searchFromAddress, setSearchFromAddress] = useState('');
      const [searchToAddress, setSearchToAddress] = useState('');
      const [searchResults, setSearchResults] = useState(null);
      const [avoidHighways, setAvoidHighways] = useState(false);
      const [isDarkMode, setIsDarkMode] = useState(() => {
        try {
          const saved = localStorage.getItem('darkMode');
          return saved !== null ? JSON.parse(saved) : true;
        } catch (e) {
          return true;
        }
      });
      const [loading, setLoading] = useState({
        weather: true,
        drive: true,
        transit: true,
        gLine: true,
        bLine: true,
        search: false
      });
      const [visibleLines, setVisibleLines] = useState({
        nLine: true,
        gLine: true,
        bLine: true
      });

      // Station-based state for multi-station app
      const [nLineData, setNLineData] = useState({
        terminal124th: { arriving: [], departing: [] },
        station112th: { northbound: [], southbound: [] },
        station48thBrighton: { northbound: [], southbound: [] },
        unionStation: { arriving: [], departing: [] }
      });

      const [gLineData, setGLineData] = useState({
        wardStation: { arriving: [], departing: [] },
        oldeTown: { eastbound: [], westbound: [] },
        goldStrike: { eastbound: [], westbound: [] },
        pecosJunction: { eastbound: [], westbound: [] },
        unionStation: { arriving: [], departing: [] }
      });

      const [bLineData, setBLineData] = useState({
        westminster: { arriving: [], departing: [] },
        pecosJunction: { northbound: [], southbound: [] },
        unionStation: { arriving: [], departing: [] }
      });

      const [expandedStations, setExpandedStations] = useState({
        nLine: { terminal124th: false, station112th: true, unionStation: false },
        gLine: { oldeTown: false, goldStrike: true, pecosJunction: false, unionStation: false },
        bLine: { westminster: false, pecosJunction: true, unionStation: false }
      });

      const [transitViewMode, setTransitViewMode] = useState('board'); // 'board' or 'station'
      const [isInitialLoad, setIsInitialLoad] = useState(true);
      const [lastRefresh, setLastRefresh] = useState(new Date());
      const [refreshSuccess, setRefreshSuccess] = useState(false);

      // Check if initial load is complete
      useEffect(() => {
        if (!loading.weather && !loading.drive && !loading.transit && isInitialLoad) {
          // Small delay for smooth transition
          setTimeout(() => setIsInitialLoad(false), 500);
        }
      }, [loading.weather, loading.drive, loading.transit, isInitialLoad]);

      // Save dark mode preference
      useEffect(() => {
        try {
          localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
        } catch (e) {
          console.error('Error saving darkMode:', e);
        }
      }, [isDarkMode]);

      // Greeting logic - simple time-based greeting
      const getGreeting = () => {
        const hour = currentTime.getHours();
        const day = currentTime.getDay();
        const isWeekend = day === 0 || day === 6;

        let timeGreeting = hour < 12 ? 'Good Morning' : 'Good Evening';
        let contextGreeting = isWeekend ? 'Enjoy your Weekend' : 'Have a great Workday';

        return { timeGreeting, contextGreeting, isWeekend };
      };

      const greeting = getGreeting();

      // Clock update (every second)
      useEffect(() => {
        const interval = setInterval(() => {
          setCurrentTime(new Date());
        }, CONSTANTS.CLOCK_INTERVAL);
        return () => clearInterval(interval);
      }, []);

      // Fetch weather
      const fetchWeather = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, weather: true }));
          const response = await fetch(
            `${CONSTANTS.API_BASE_URL}/api/weather?lat=${config.weather.lat}&lon=${config.weather.lon}`
          );
          const data = await response.json();
          setWeather(data);
        } catch (error) {
          console.error('Weather error:', error);
          setWeather({
            main: { temp: 72, feels_like: 70, humidity: 50 },
            weather: [{ description: 'clear sky', icon: '01d' }],
            wind: { speed: 5 },
            _isFallback: true
          });
        } finally {
          setLoading(prev => ({ ...prev, weather: false }));
        }
      }, []);

      // Fetch drive times
      const fetchDriveTimes = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, drive: true }));
          const routingPreference = avoidHighways ? 'TRAFFIC_AWARE_OPTIMAL' : 'TRAFFIC_AWARE';

          const morningRoute = {
            origin: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
            destination: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            travelMode: 'DRIVE',
            routingPreference: routingPreference,
            ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const eveningRoute = {
            origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            destination: { location: { latLng: { latitude: config.locations.home.lat, longitude: config.locations.home.lng }}},
            travelMode: 'DRIVE',
            routingPreference: routingPreference,
            ...(avoidHighways && { routeModifiers: { avoidHighways: true }}),
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const walkRoute = {
            origin: { location: { latLng: { latitude: config.locations.garage.lat, longitude: config.locations.garage.lng }}},
            destination: { location: { latLng: { latitude: config.locations.work.lat, longitude: config.locations.work.lng }}},
            travelMode: 'WALK',
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const [morningRes, eveningRes, walkRes] = await Promise.all([
            fetch(`${CONSTANTS.API_BASE_URL}/api/routes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(morningRoute)
            }),
            fetch(`${CONSTANTS.API_BASE_URL}/api/routes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(eveningRoute)
            }),
            fetch(`${CONSTANTS.API_BASE_URL}/api/routes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.staticDuration' },
              body: JSON.stringify(walkRoute)
            })
          ]);

          const morningData = await morningRes.json();
          const eveningData = await eveningRes.json();
          const walkData = await walkRes.json();

          if (morningData.routes && morningData.routes.length > 0) {
            const morningDuration = parseInt(morningData.routes[0].duration.replace('s', ''));
            const morningDistance = morningData.routes[0].distanceMeters;
            const eveningDuration = parseInt(eveningData.routes[0].duration.replace('s', ''));
            const eveningDistance = eveningData.routes[0].distanceMeters;
            const walkDuration = parseInt(walkData.routes[0].duration.replace('s', ''));
            const walkDistance = walkData.routes[0].distanceMeters;

            setDriveData({
              morning: {
                duration: { text: `${Math.round(morningDuration / 60)} mins`, value: morningDuration },
                distance: { text: `${(morningDistance * 0.000621371).toFixed(1)} mi` }
              },
              evening: {
                duration: { text: `${Math.round(eveningDuration / 60)} mins`, value: eveningDuration },
                distance: { text: `${(eveningDistance * 0.000621371).toFixed(1)} mi` }
              },
              walk: {
                duration: { text: `${Math.round(walkDuration / 60)} mins`, value: walkDuration },
                distance: { text: `${(walkDistance * 0.000621371).toFixed(1)} mi` }
              }
            });
          } else {
            throw new Error('No routes returned');
          }
        } catch (error) {
          console.error('Drive time error:', error);
          setDriveData({
            morning: { duration: { text: '30 mins', value: 1800 }, distance: { text: '14.2 mi' }},
            evening: { duration: { text: '30 mins', value: 1800 }, distance: { text: '14.2 mi' }},
            walk: { duration: { text: '8 mins', value: 480 }, distance: { text: '0.4 mi' }},
            _isFallback: true
          });
        } finally {
          setLoading(prev => ({ ...prev, drive: false }));
        }
      }, [avoidHighways]);

      // Helper: Process train data from API response
      const processTrainData = (arrivals, routeId, directionId, useArrival = true) => {
        if (!arrivals || !Array.isArray(arrivals) || arrivals.length === 0) {
          console.log(`âš ï¸ processTrainData: No arrivals data for route ${routeId} dir ${directionId}`);
          return [];
        }

        // const now = Date.now();
        const filtered = arrivals.filter(arrival => {
          const matchesRoute = arrival.routeId === routeId;
          const matchesDirection = directionId === null || arrival.directionId === directionId;

          // TEMPORARILY DISABLED: Filter out trains that have already departed
          // const departureTime = arrival.departureTime || arrival.arrivalTime;
          // if (departureTime && typeof departureTime === 'number') {
          //   const departureTimestamp = departureTime * 1000;
          //   const hasNotDeparted = departureTimestamp > (now - 30000);
          //   return matchesRoute && matchesDirection && hasNotDeparted;
          // }

          return matchesRoute && matchesDirection;
        });

        console.log(`ðŸ” processTrainData: Route ${routeId} dir ${directionId} - Found ${filtered.length}/${arrivals.length} trains (filtering DISABLED for debug)`);

        // Log first arrival to see data structure
        if (filtered.length > 0 && routeId === '117N') {
          console.log('ðŸ” N Line sample arrival:', JSON.stringify(filtered[0], null, 2));
        }

        return filtered.slice(0, 3).map(arrival => {
          let arrivalTimestamp = null;
          let departureTimestamp = null;
          let arrivalTimeDisplay = null;
          let departureTimeDisplay = null;
          let delayMinutes = 0;

          // Get ACTUAL arrival time from GTFS feed (NO fallbacks - show actual data only!)
          if (arrival.arrivalTime && typeof arrival.arrivalTime === 'number') {
            arrivalTimestamp = arrival.arrivalTime * 1000;
            const arrivalDate = new Date(arrivalTimestamp);
            arrivalTimeDisplay = arrivalDate.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
          }

          // Get ACTUAL departure time from GTFS feed (NO fallbacks - show actual data only!)
          if (arrival.departureTime && typeof arrival.departureTime === 'number') {
            departureTimestamp = arrival.departureTime * 1000;
            const departureDate = new Date(departureTimestamp);
            departureTimeDisplay = departureDate.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
          }

          // Calculate delay based on scheduled vs actual arrival
          if (arrival.scheduledArrivalTime && typeof arrival.scheduledArrivalTime === 'number' && arrivalTimestamp) {
            const scheduledTimestamp = arrival.scheduledArrivalTime * 1000;
            delayMinutes = Math.round((arrivalTimestamp - scheduledTimestamp) / 60000);
          }

          // Use arrival timestamp for status calculations (or departure if no arrival exists)
          const primaryTimestamp = arrivalTimestamp || departureTimestamp;

          return {
            arrivalTime: arrivalTimeDisplay,
            departureTime: departureTimeDisplay,
            arrivalTimestamp: arrivalTimestamp,
            departureTimestamp: departureTimestamp,
            primaryTimestamp: primaryTimestamp, // For Arriving/Departing status
            delay: delayMinutes,
            status: arrival.status || 'On Time',
            tripId: arrival.tripId
          };
        });
      };

      // Helper: Process terminal station (shows both arriving and departing trains)
      const processTerminalStation = (arrivals, routeId, inboundDir, outboundDir) => {
        const arriving = processTrainData(arrivals, routeId, inboundDir, true);
        const departing = processTrainData(arrivals, routeId, outboundDir, false);

        console.log(`ðŸš‰ Terminal station - Route ${routeId}: ${arriving.length} arriving (dir ${inboundDir}), ${departing.length} departing (dir ${outboundDir})`);
        console.log(`   Total arrivals in API response: ${arrivals?.length || 0}`);

        return {
          arriving: arriving,
          departing: departing
        };
      };

      // Helper: Process middle station (shows trains passing through in both directions)
      const processMiddleStation = (arrivals, routeId, dir1, dir2, dir1Name, dir2Name) => {
        const dir1Trains = processTrainData(arrivals, routeId, dir1, true);
        const dir2Trains = processTrainData(arrivals, routeId, dir2, true);

        console.log(`ðŸ“ Middle station - ${dir1Name}: ${dir1Trains.length} trains, ${dir2Name}: ${dir2Trains.length} trains`);

        return {
          [dir1Name]: dir1Trains,
          [dir2Name]: dir2Trains
        };
      };

      // Helper: Determine if a station should glow based on train arrivals/departures
      // Returns: { glow: boolean, type: 'arriving' | 'departing' | null }
      const getStationGlow = (stationData, isTerminal = false) => {
        const now = currentTime.getTime();
        const ARRIVAL_GLOW_WINDOW = 15 * 1000; // 15 seconds before arrival
        const DEPARTURE_GLOW_WINDOW = 7 * 1000; // 7 seconds after departure

        // For terminal stations: check both arriving and departing trains
        if (isTerminal) {
          // Check arriving trains (glow 15 seconds before arrival)
          const arrivingTrains = stationData.arriving || [];
          for (const train of arrivingTrains) {
            if (train.arrivalTimestamp) {
              const timeUntilArrival = train.arrivalTimestamp - now;
              if (timeUntilArrival > 0 && timeUntilArrival <= ARRIVAL_GLOW_WINDOW) {
                return { glow: true, type: 'arriving' };
              }
            }
          }

          // Check departing trains (glow 7 seconds after departure)
          const departingTrains = stationData.departing || [];
          for (const train of departingTrains) {
            if (train.arrivalTimestamp) {
              const timeSinceDeparture = now - train.arrivalTimestamp;
              if (timeSinceDeparture > 0 && timeSinceDeparture <= DEPARTURE_GLOW_WINDOW) {
                return { glow: true, type: 'departing' };
              }
            }
          }
        } else {
          // For middle stations: check all directional trains for arrivals
          const allTrains = Object.values(stationData).flat();
          for (const train of allTrains) {
            if (train.arrivalTimestamp) {
              const timeUntilArrival = train.arrivalTimestamp - now;
              if (timeUntilArrival > 0 && timeUntilArrival <= ARRIVAL_GLOW_WINDOW) {
                return { glow: true, type: 'arriving' };
              }
            }
          }
        }

        return { glow: false, type: null };
      };

      // Helper: Organize trains for simplified line-based departures board
      const getTrainsForSimplifiedBoard = () => {
        const lines = [];

        // Helper to get next 2 trains from array
        const getNextTwoTrains = (trainsArray) => {
          if (!trainsArray || !Array.isArray(trainsArray)) return [];
          return trainsArray.slice(0, 2); // Only next 2 trains
        };

        // Helper to determine status with Arriving/Departing indicators
        const getTrainStatus = (train) => {
          const now = currentTime.getTime();
          if (train.delay > 2) return { text: 'Delayed', color: isDarkMode ? 'text-red-400' : 'text-red-600' };

          // Use primaryTimestamp (arrival or departure, whichever exists)
          const timestamp = train.primaryTimestamp || train.arrivalTimestamp || train.departureTimestamp;
          if (timestamp) {
            const timeUntil = timestamp - now;
            // If arriving in next 2 minutes
            if (timeUntil > 0 && timeUntil <= 120000) {
              return { text: 'Arriving', color: isDarkMode ? 'text-yellow-400' : 'text-yellow-600' };
            }
            // If departed in last minute
            if (timeUntil < 0 && timeUntil >= -60000) {
              return { text: 'Departing', color: isDarkMode ? 'text-blue-400' : 'text-blue-600' };
            }
          }

          return { text: 'On Time', color: isDarkMode ? 'text-green-400' : 'text-green-600' };
        };

        // N LINE - Organized by direction with all stops in geographic order
        if (visibleLines.nLine && nLineData) {
          const nLineSections = [];

          // Northbound section (going north from Union to 112th)
          const northboundRows = [];
          northboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(nLineData.unionStation?.departing || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: '48th & Brighton at NWC',
            trains: getNextTwoTrains(nLineData.station48thBrighton?.northbound || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: 'Northgenn & 112th',
            trains: getNextTwoTrains(nLineData.station112th?.northbound || []),
            getStatus: getTrainStatus
          });
          nLineSections.push({ title: 'Northbound', rows: northboundRows });

          // Southbound section (going south from 112th to Union)
          const southboundRows = [];
          southboundRows.push({
            station: 'Northgenn & 112th',
            trains: getNextTwoTrains(nLineData.station112th?.southbound || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: '48th & Brighton at NWC',
            trains: getNextTwoTrains(nLineData.station48thBrighton?.southbound || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(nLineData.unionStation?.arriving || []),
            getStatus: getTrainStatus
          });
          nLineSections.push({ title: 'Southbound', rows: southboundRows });

          lines.push({
            name: 'N Line (Schedule, leaves every 30 minutes)',
            color: isDarkMode ? 'bg-purple-600' : 'bg-purple-500',
            sections: nLineSections
          });
        }

        // B LINE - Organized by direction with all stops in geographic order
        if (visibleLines.bLine && bLineData) {
          const bLineSections = [];

          // Westbound section (going west/north from Union to Westminster)
          const westboundRows = [];
          westboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(bLineData.unionStation?.departing || []),
            getStatus: getTrainStatus
          });
          westboundRows.push({
            station: 'Pecos Junction',
            trains: getNextTwoTrains(bLineData.pecosJunction?.northbound || []),
            getStatus: getTrainStatus
          });
          westboundRows.push({
            station: 'Westminster Station',
            trains: getNextTwoTrains(bLineData.westminster?.arriving || []),
            getStatus: getTrainStatus
          });
          bLineSections.push({ title: 'Westbound', rows: westboundRows });

          // Eastbound section (going east/south from Westminster to Union)
          const eastboundRows = [];
          eastboundRows.push({
            station: 'Westminster Station',
            trains: getNextTwoTrains(bLineData.westminster?.departing || []),
            getStatus: getTrainStatus
          });
          eastboundRows.push({
            station: 'Pecos Junction',
            trains: getNextTwoTrains(bLineData.pecosJunction?.southbound || []),
            getStatus: getTrainStatus
          });
          eastboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(bLineData.unionStation?.arriving || []),
            getStatus: getTrainStatus
          });
          bLineSections.push({ title: 'Eastbound', rows: eastboundRows });

          lines.push({
            name: 'B Line (Schedule, leaves every hour)',
            color: isDarkMode ? 'bg-blue-600' : 'bg-blue-500',
            sections: bLineSections
          });
        }

        // G LINE - Organized by direction with all stops in geographic order
        if (visibleLines.gLine && gLineData) {
          const gLineSections = [];

          // Northbound section (going from Union to Ward)
          const northboundRows = [];
          northboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(gLineData.unionStation?.departing || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: 'Pecos Junction',
            trains: getNextTwoTrains(gLineData.pecosJunction?.eastbound || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: 'Gold Strike',
            trains: getNextTwoTrains(gLineData.goldStrike?.eastbound || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: 'Old Town Arvada',
            trains: getNextTwoTrains(gLineData.oldeTown?.eastbound || []),
            getStatus: getTrainStatus
          });
          northboundRows.push({
            station: 'Ward Station',
            trains: getNextTwoTrains(gLineData.wardStation?.arriving || []),
            getStatus: getTrainStatus
          });
          gLineSections.push({ title: 'Northbound', rows: northboundRows });

          // Southbound section (going from Ward to Union)
          const southboundRows = [];
          southboundRows.push({
            station: 'Ward Station',
            trains: getNextTwoTrains(gLineData.wardStation?.departing || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: 'Old Town Arvada',
            trains: getNextTwoTrains(gLineData.oldeTown?.westbound || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: 'Gold Strike',
            trains: getNextTwoTrains(gLineData.goldStrike?.westbound || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: 'Pecos Junction',
            trains: getNextTwoTrains(gLineData.pecosJunction?.westbound || []),
            getStatus: getTrainStatus
          });
          southboundRows.push({
            station: 'Union Station',
            trains: getNextTwoTrains(gLineData.unionStation?.arriving || []),
            getStatus: getTrainStatus
          });
          gLineSections.push({ title: 'Southbound', rows: southboundRows });

          lines.push({
            name: 'G Line (Schedule, leaves every 30 minutes)',
            color: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
            sections: gLineSections
          });
        }

        return lines;
      };

      // Helper: Collect all trains from all lines for departures board view
      const getAllTrainsForBoard = () => {
        const trains = [];

        // N Line trains
        if (visibleLines.nLine && nLineData) {
          // 124th Station
          if (nLineData.terminal124th?.departing) {
            nLineData.terminal124th.departing.forEach(train => {
              trains.push({
                line: 'N',
                lineColor: isDarkMode ? 'bg-purple-600' : 'bg-purple-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: '124th Ave',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // 112th Station
          if (nLineData.station112th?.northbound) {
            nLineData.station112th.northbound.forEach(train => {
              trains.push({
                line: 'N',
                lineColor: isDarkMode ? 'bg-purple-600' : 'bg-purple-500',
                textColor: 'text-white',
                destination: '124th Ave',
                track: '112th Stn',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
          if (nLineData.station112th?.southbound) {
            nLineData.station112th.southbound.forEach(train => {
              trains.push({
                line: 'N',
                lineColor: isDarkMode ? 'bg-purple-600' : 'bg-purple-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: '112th Stn',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Union Station
          if (nLineData.unionStation?.departing) {
            nLineData.unionStation.departing.forEach(train => {
              trains.push({
                line: 'N',
                lineColor: isDarkMode ? 'bg-purple-600' : 'bg-purple-500',
                textColor: 'text-white',
                destination: '124th Ave',
                track: 'Union Stn',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
        }

        // G Line trains
        if (visibleLines.gLine && gLineData) {
          // Olde Town
          if (gLineData.oldeTown?.departing) {
            gLineData.oldeTown.departing.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: 'Olde Town',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Gold Strike
          if (gLineData.goldStrike?.eastbound) {
            gLineData.goldStrike.eastbound.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: 'Gold Strike',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
          if (gLineData.goldStrike?.westbound) {
            gLineData.goldStrike.westbound.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Olde Town',
                track: 'Gold Strike',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Pecos Junction (G Line)
          if (gLineData.pecosJunction?.eastbound) {
            gLineData.pecosJunction.eastbound.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: 'Pecos Jct',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
          if (gLineData.pecosJunction?.westbound) {
            gLineData.pecosJunction.westbound.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Olde Town',
                track: 'Pecos Jct',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Union Station (G Line)
          if (gLineData.unionStation?.departing) {
            gLineData.unionStation.departing.forEach(train => {
              trains.push({
                line: 'G',
                lineColor: isDarkMode ? 'bg-orange-600' : 'bg-orange-500',
                textColor: 'text-white',
                destination: 'Olde Town',
                track: 'Union Stn',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
        }

        // B Line trains
        if (visibleLines.bLine && bLineData) {
          // Westminster
          if (bLineData.westminster?.departing) {
            bLineData.westminster.departing.forEach(train => {
              trains.push({
                line: 'B',
                lineColor: isDarkMode ? 'bg-blue-600' : 'bg-blue-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: 'Westminster',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Pecos Junction (B Line)
          if (bLineData.pecosJunction?.northbound) {
            bLineData.pecosJunction.northbound.forEach(train => {
              trains.push({
                line: 'B',
                lineColor: isDarkMode ? 'bg-blue-600' : 'bg-blue-500',
                textColor: 'text-white',
                destination: 'Westminster',
                track: 'Pecos Jct',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
          if (bLineData.pecosJunction?.southbound) {
            bLineData.pecosJunction.southbound.forEach(train => {
              trains.push({
                line: 'B',
                lineColor: isDarkMode ? 'bg-blue-600' : 'bg-blue-500',
                textColor: 'text-white',
                destination: 'Union Station',
                track: 'Pecos Jct',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }

          // Union Station (B Line)
          if (bLineData.unionStation?.departing) {
            bLineData.unionStation.departing.forEach(train => {
              trains.push({
                line: 'B',
                lineColor: isDarkMode ? 'bg-blue-600' : 'bg-blue-500',
                textColor: 'text-white',
                destination: 'Westminster',
                track: 'Union Stn',
                time: train.time,
                timestamp: train.arrivalTimestamp,
                status: train.delay > 2 ? `${train.delay} min delay` : 'On Time',
                statusColor: train.delay > 2 ? (isDarkMode ? 'text-red-400' : 'text-red-600') : (isDarkMode ? 'text-green-400' : 'text-green-600')
              });
            });
          }
        }

        // Sort by timestamp (soonest first)
        return trains.sort((a, b) => {
          if (!a.timestamp && !b.timestamp) return 0;
          if (!a.timestamp) return 1;
          if (!b.timestamp) return -1;
          return a.timestamp - b.timestamp;
        });
      };

      // Helper: Fetch from single or multiple platforms and merge results
      // Supports both string (single stop ID) and array (multiple platform stop IDs)
      const fetchStopData = async (apiEndpoint, stopIdOrArray) => {
        // If single stop ID (string), fetch normally
        if (typeof stopIdOrArray === 'string') {
          console.log(`ðŸ“¡ Fetching single platform: ${stopIdOrArray}`);
          return await fetch(`${apiEndpoint}/${stopIdOrArray}?t=${Date.now()}`).then(r => r.json());
        }

        // If array of stop IDs (multi-platform), fetch all and merge
        if (Array.isArray(stopIdOrArray)) {
          console.log(`ðŸ“¡ Fetching multi-platform: ${stopIdOrArray.join(', ')}`);
          const responses = await Promise.all(
            stopIdOrArray.map(stopId =>
              fetch(`${apiEndpoint}/${stopId}?t=${Date.now()}`).then(r => r.json())
            )
          );

          // Merge all arrivals from all platforms
          const mergedArrivals = responses.reduce((acc, response) => {
            if (response.arrivals && Array.isArray(response.arrivals)) {
              return [...acc, ...response.arrivals];
            }
            return acc;
          }, []);

          console.log(`âœ… Merged ${mergedArrivals.length} arrivals from ${stopIdOrArray.length} platforms`);

          return {
            arrivals: mergedArrivals,
            stopId: stopIdOrArray.join('+') // Combined stop ID for logging
          };
        }

        throw new Error(`Invalid stop ID format: ${stopIdOrArray}`);
      };

      // Fetch N Line data from all stations (multi-stop parallel fetch)
      const fetchTransitData = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, transit: true }));
          const apiEndpoint = 'https://rtd-n-line-api.onrender.com/api/rtd/arrivals';

          console.log('ðŸš† Fetching N Line data from all 4 stations...');

          // Fetch all 4 N Line stations in parallel (using new multi-platform helper)
          const [terminal124thRes, station112thRes, station48thBrightonRes, unionRes] = await Promise.all([
            fetchStopData(apiEndpoint, config.nLineStops.terminal124th),
            fetchStopData(apiEndpoint, config.nLineStops.station112th),
            fetchStopData(apiEndpoint, config.nLineStops.station48thBrighton),
            fetchStopData(apiEndpoint, config.nLineStops.unionStation)
          ]);

          console.log('âœ… All N Line stations fetched');

          // Process 124th Station (Terminal - northbound endpoint)
          // Shows trains arriving from south (dir 1 southbound) and departing to south (dir 0 northbound)
          const terminal124thData = processTerminalStation(
            terminal124thRes.arrivals,
            '117N',
            0,  // arriving from south (northbound trains ending at 124th)
            1   // departing to south (southbound trains starting from 124th to Union)
          );

          // Process 112th Station (Middle - Northgenn & 112th)
          // Shows trains in both directions
          const station112thData = processMiddleStation(
            station112thRes.arrivals,
            '117N',
            0,  // northbound (to 124th)
            1,  // southbound (to Union)
            'northbound',
            'southbound'
          );

          // Process 48th & Brighton Station (Middle - National Western Center)
          // Shows trains in both directions
          const station48thBrightonData = processMiddleStation(
            station48thBrightonRes.arrivals,
            '117N',
            0,  // northbound (to 124th)
            1,  // southbound (to Union)
            'northbound',
            'southbound'
          );

          // Process Union Station (Terminal - southbound endpoint)
          // Shows trains arriving from north (dir 0 northbound) and departing to north (dir 1 southbound)
          const unionData = processTerminalStation(
            unionRes.arrivals,
            '117N',
            1,  // arriving from north (southbound trains ending at Union)
            0   // departing to north (northbound trains starting from Union to 124th)
          );

          // Update station-based state
          setNLineData({
            terminal124th: terminal124thData,
            station112th: station112thData,
            station48thBrighton: station48thBrightonData,
            unionStation: unionData
          });

          // Maintain backwards compatibility with old state (for now)
          setTransitDataSB(terminal124thData.departing);  // Departures from 124th to Union (southbound)
          setTransitDataNB(unionData.departing);  // Departures from Union to 124th (northbound)

          console.log('ðŸŽ¯ N Line station data processed:', {
            terminal124th: terminal124thData,
            station112th: station112thData,
            station48thBrighton: station48thBrightonData,
            unionStation: unionData
          });

        } catch (error) {
          console.error('âŒ N Line error:', error);
          setTransitDataSB([]);
          setTransitDataNB([]);
          setNLineData({
            terminal124th: { arriving: [], departing: [] },
            station112th: { northbound: [], southbound: [] },
            station48thBrighton: { northbound: [], southbound: [] },
            unionStation: { arriving: [], departing: [] }
          });
        } finally {
          setLoading(prev => ({ ...prev, transit: false }));
        }
      }, []);

      // Fetch G Line data from all stations (multi-stop parallel fetch)
      const fetchGLineData = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, gLine: true }));
          const apiEndpoint = `${CONSTANTS.API_BASE_URL}/api/rtd/gline`;

          console.log('ðŸš† Fetching G Line data from all 5 stations...');

          // Fetch all 5 G Line stations in parallel (using new multi-platform helper)
          const [wardRes, oldeTownRes, goldStrikeRes, pecosRes, unionRes] = await Promise.all([
            fetchStopData(apiEndpoint, config.gLineStops.wardStation),
            fetchStopData(apiEndpoint, config.gLineStops.oldeTown),
            fetchStopData(apiEndpoint, config.gLineStops.goldStrike),
            fetchStopData(apiEndpoint, config.gLineStops.pecosJunction),
            fetchStopData(apiEndpoint, config.gLineStops.unionStation)
          ]);

          console.log('âœ… All G Line stations fetched');

          // Process Ward Station (Terminal - westbound endpoint)
          // Shows trains arriving from east and departing to east
          const wardData = processTerminalStation(
            wardRes.arrivals,
            '113G',
            1,  // arriving from east (eastbound trains ending here)
            0   // departing to east (westbound trains starting here)
          );

          // Process Olde Town Arvada (Middle - pass-through)
          // Shows trains in both directions
          const oldeTownData = processMiddleStation(
            oldeTownRes.arrivals,
            '113G',
            0,  // westbound (to Ward)
            1,  // eastbound (to Union)
            'westbound',
            'eastbound'
          );

          // Process Gold Strike Station (Middle - pass-through)
          // Shows trains in both directions
          const goldStrikeData = processMiddleStation(
            goldStrikeRes.arrivals,
            '113G',
            0,  // westbound (to Ward/Olde Town)
            1,  // eastbound (to Union Station)
            'westbound',
            'eastbound'
          );

          // Process Pecos Junction (Middle - transfer point)
          // Shows trains in both directions
          const pecosData = processMiddleStation(
            pecosRes.arrivals,
            '113G',
            0,  // westbound (to Ward/Olde Town)
            1,  // eastbound (to Union Station)
            'westbound',
            'eastbound'
          );

          // Process Union Station (Terminal - eastbound endpoint)
          // Shows trains arriving from west (dir 1 eastbound) and departing to west (dir 0 westbound)
          const unionData = processTerminalStation(
            unionRes.arrivals,
            '113G',
            1,  // arriving from west (eastbound trains ending at Union)
            0   // departing to west (westbound trains starting from Union to Ward)
          );

          // Update station-based state
          setGLineData({
            wardStation: wardData,
            oldeTown: oldeTownData,
            goldStrike: goldStrikeData,
            pecosJunction: pecosData,
            unionStation: unionData
          });

          // Maintain backwards compatibility with old state (for now)
          setGLineWestbound(unionData.departing);  // Departures from Union to Ward
          setGLineEastbound(wardData.departing);  // Departures from Ward to Union

          console.log('ðŸŽ¯ G Line station data processed:', {
            wardStation: wardData,
            oldeTown: oldeTownData,
            goldStrike: goldStrikeData,
            pecosJunction: pecosData,
            unionStation: unionData
          });

        } catch (error) {
          console.error('âŒ G Line error:', error);
          setGLineEastbound([]);
          setGLineWestbound([]);
          setGLineData({
            wardStation: { arriving: [], departing: [] },
            oldeTown: { eastbound: [], westbound: [] },
            goldStrike: { eastbound: [], westbound: [] },
            pecosJunction: { eastbound: [], westbound: [] },
            unionStation: { arriving: [], departing: [] }
          });
        } finally {
          setLoading(prev => ({ ...prev, gLine: false }));
        }
      }, []);

      // Fetch B Line data from all stations (multi-stop parallel fetch)
      const fetchBLineData = useCallback(async () => {
        try {
          setLoading(prev => ({ ...prev, bLine: true }));
          const apiEndpoint = `${CONSTANTS.API_BASE_URL}/api/rtd/gline`;

          console.log('ðŸš† Fetching B Line data from all 3 stations...');

          // Fetch all 3 B Line stations in parallel (using new multi-platform helper)
          const [westminsterRes, pecosRes, unionRes] = await Promise.all([
            fetchStopData(apiEndpoint, config.bLineStops.westminster),
            fetchStopData(apiEndpoint, config.bLineStops.pecosJunction),
            fetchStopData(apiEndpoint, config.bLineStops.unionStation)
          ]);

          console.log('âœ… All B Line stations fetched');

          // Process Westminster Station (Terminal - northbound endpoint)
          // Shows trains arriving from south (dir 1 southbound) and departing to south (dir 0 northbound)
          const westminsterData = processTerminalStation(
            westminsterRes.arrivals,
            '113B',
            0,  // arriving from south (northbound trains ending at Westminster)
            1   // departing to south (southbound trains starting from Westminster to Union)
          );

          // Process Pecos Junction (Middle - transfer point)
          // Shows trains in both directions
          const pecosData = processMiddleStation(
            pecosRes.arrivals,
            '113B',
            0,  // northbound (to Westminster)
            1,  // southbound (to Union Station)
            'northbound',
            'southbound'
          );

          // Process Union Station (Terminal - southbound endpoint)
          // Shows trains arriving from north (dir 0 northbound) and departing to north (dir 1 southbound)
          const unionData = processTerminalStation(
            unionRes.arrivals,
            '113B',
            1,  // arriving from north (southbound trains ending at Union)
            0   // departing to north (northbound trains starting from Union to Westminster)
          );

          // Update station-based state
          setBLineData({
            westminster: westminsterData,
            pecosJunction: pecosData,
            unionStation: unionData
          });

          // Maintain backwards compatibility with old state (for now)
          setBLineNorthbound(unionData.departing);  // Departures from Union to Westminster
          setBLineSouthbound(westminsterData.departing);  // Departures from Westminster to Union

          console.log('ðŸŽ¯ B Line station data processed:', {
            westminster: westminsterData,
            pecosJunction: pecosData,
            unionStation: unionData
          });

        } catch (error) {
          console.error('âŒ B Line error:', error);
          setBLineSouthbound([]);
          setBLineNorthbound([]);
          setBLineData({
            westminster: { arriving: [], departing: [] },
            pecosJunction: { northbound: [], southbound: [] },
            unionStation: { arriving: [], departing: [] }
          });
        } finally {
          setLoading(prev => ({ ...prev, bLine: false }));
        }
      }, []);

      // Geocode address to coordinates
      const geocodeAddress = async (address) => {
        const response = await fetch(
          `${CONSTANTS.API_BASE_URL}/api/geocode?address=${encodeURIComponent(address)}`
        );
        const data = await response.json();

        if (data.results && data.results.length > 0) {
          const location = data.results[0].geometry.location;
          return { lat: location.lat, lng: location.lng };
        }
        throw new Error('Address not found');
      };

      // Search location drive times with addresses
      const searchDriveTimes = useCallback(async () => {
        if (!searchFromAddress || !searchToAddress) return;

        try {
          setLoading(prev => ({ ...prev, search: true }));
          setSearchResults(null);

          // Geocode both addresses
          const fromCoords = await geocodeAddress(searchFromAddress);
          const toCoords = await geocodeAddress(searchToAddress);

          const routeWithHighway = {
            origin: { location: { latLng: { latitude: fromCoords.lat, longitude: fromCoords.lng }}},
            destination: { location: { latLng: { latitude: toCoords.lat, longitude: toCoords.lng }}},
            travelMode: 'DRIVE',
            routingPreference: 'TRAFFIC_AWARE',
            computeAlternativeRoutes: false,
            languageCode: 'en-US',
            units: 'IMPERIAL'
          };

          const routeNoHighway = {
            ...routeWithHighway,
            routeModifiers: { avoidHighways: true }
          };

          const [withHighwayRes, noHighwayRes] = await Promise.all([
            fetch(`${CONSTANTS.API_BASE_URL}/api/routes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters' },
              body: JSON.stringify(routeWithHighway)
            }),
            fetch(`${CONSTANTS.API_BASE_URL}/api/routes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters' },
              body: JSON.stringify(routeNoHighway)
            })
          ]);

          const withHighwayData = await withHighwayRes.json();
          const noHighwayData = await noHighwayRes.json();

          if (withHighwayData.routes && withHighwayData.routes.length > 0) {
            const withHighwayDuration = parseInt(withHighwayData.routes[0].duration.replace('s', ''));
            const withHighwayDistance = withHighwayData.routes[0].distanceMeters;
            const noHighwayDuration = parseInt(noHighwayData.routes[0].duration.replace('s', ''));
            const noHighwayDistance = noHighwayData.routes[0].distanceMeters;

            setSearchResults({
              withHighway: {
                durationMinutes: Math.round(withHighwayDuration / 60),
                distance: `${(withHighwayDistance * 0.000621371).toFixed(1)} mi`
              },
              noHighway: {
                durationMinutes: Math.round(noHighwayDuration / 60),
                distance: `${(noHighwayDistance * 0.000621371).toFixed(1)} mi`
              }
            });
          }
        } catch (error) {
          console.error('Search error:', error);
          setSearchResults({ error: error.message || 'Unable to calculate route' });
        } finally {
          setLoading(prev => ({ ...prev, search: false }));
        }
      }, [searchFromAddress, searchToAddress]);

      // Initial data fetch
      useEffect(() => {
        fetchWeather();
        fetchDriveTimes();
        fetchTransitData();
        fetchGLineData();
        fetchBLineData();
      }, [fetchWeather, fetchDriveTimes, fetchTransitData, fetchGLineData, fetchBLineData]);

      // 15-minute refresh for weather and drive times
      useEffect(() => {
        const interval = setInterval(() => {
          fetchWeather();
          fetchDriveTimes();
          setLastRefresh(new Date());
        }, CONSTANTS.REFRESH_INTERVAL);
        return () => clearInterval(interval);
      }, [fetchWeather, fetchDriveTimes]);

      // 1-minute refresh for transit (needs more frequent updates)
      useEffect(() => {
        const interval = setInterval(() => {
          fetchTransitData();
          fetchGLineData();
          fetchBLineData();
        }, CONSTANTS.TRANSIT_INTERVAL);
        return () => clearInterval(interval);
      }, [fetchTransitData, fetchGLineData, fetchBLineData]);

      // Manual refresh all with success feedback
      const handleManualRefresh = () => {
        fetchWeather();
        fetchDriveTimes();
        fetchTransitData();
        fetchGLineData();
        fetchBLineData();
        setLastRefresh(new Date());
        setRefreshSuccess(true);
        setTimeout(() => setRefreshSuccess(false), 2000);
      };

      // Scroll to top when changing sections
      useEffect(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, [activeSection]);

      // Helper function to format duration
      const formatDuration = (minutes) => {
        if (minutes >= 60) {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          if (mins === 0) return `${hours} hr`;
          return `${hours} hr ${mins} min`;
        }
        return `${minutes} mins`;
      };

      // Theme colors
      const theme = isDarkMode
        ? 'from-gray-900 to-gray-800 text-white'
        : 'from-gray-50 to-gray-100 text-gray-900';
      const cardBg = isDarkMode ? 'bg-gray-800' : 'bg-white';
      const textColor = isDarkMode ? 'text-white' : 'text-gray-900';
      const textMuted = isDarkMode ? 'text-gray-400' : 'text-gray-600';
      const borderColor = isDarkMode ? 'border-gray-700' : 'border-gray-200';

      // Render train card with real-time countdown
      const renderTrainCard = (train, idx, type = 'arrival') => {
        if (!train.arrivalTimestamp) return null;

        // Use currentTime for real-time countdown (updates every second)
        const now = currentTime.getTime();
        const totalSecondsUntil = Math.floor((train.arrivalTimestamp - now) / 1000);
        const minutesUntil = Math.floor(totalSecondsUntil / 60);
        const secondsUntil = totalSecondsUntil % 60;

        let urgencyColor = isDarkMode ? 'bg-gray-700' : 'bg-gray-100';
        if (minutesUntil <= 5) urgencyColor = isDarkMode ? 'bg-red-900 bg-opacity-30' : 'bg-red-50';
        else if (minutesUntil <= 10) urgencyColor = isDarkMode ? 'bg-orange-900 bg-opacity-30' : 'bg-orange-50';
        else if (minutesUntil <= 15) urgencyColor = isDarkMode ? 'bg-yellow-900 bg-opacity-30' : 'bg-yellow-50';

        let delayColor = 'bg-green-100 text-green-700';
        if (train.delay > 3) delayColor = 'bg-red-100 text-red-700';
        else if (train.delay > 0) delayColor = 'bg-yellow-100 text-yellow-700';

        // Format countdown display with minutes and seconds
        let countdownDisplay;
        if (totalSecondsUntil < 0) {
          countdownDisplay = type === 'departure' ? 'Departed' : 'Arrived';
        } else if (totalSecondsUntil < 60) {
          countdownDisplay = `${totalSecondsUntil} sec`;
        } else {
          countdownDisplay = `${minutesUntil} min ${secondsUntil} sec`;
        }

        // Arrival vs Departure indicator
        const typeIndicator = type === 'departure' ? 'ðŸš€' : 'ðŸš†';
        const typeLabel = type === 'departure' ? 'Departs' : 'Arrives';

        return (
          <div key={idx} className={`p-4 rounded-xl ${urgencyColor} border ${borderColor}`}>
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-1">
                  <span>{typeIndicator}</span>
                  <span className={`text-xs font-semibold ${textMuted}`}>{typeLabel}</span>
                </div>
                <p className={`text-2xl font-bold ${textColor}`}>
                  {countdownDisplay}
                </p>
                <p className={`text-sm ${textMuted}`}>{train.time}</p>
              </div>
              <div className="text-right">
                <span className={`px-2 py-1 rounded text-xs font-semibold ${delayColor}`}>
                  {train.delay > 0 ? `+${train.delay} min` : 'On Time'}
                </span>
              </div>
            </div>
          </div>
        );
      };

      // StationCard Component: Renders a station with expand/collapse and trains
      const renderStationCard = (stationName, stationData, line, stationKey, isTerminal = false) => {
        const isExpanded = expandedStations[line][stationKey];

        const toggleExpand = () => {
          setExpandedStations(prev => ({
            ...prev,
            [line]: {
              ...prev[line],
              [stationKey]: !prev[line][stationKey]
            }
          }));
        };

        // Terminal station: has "arriving" and "departing" arrays
        // Middle station: has directional arrays (northbound/southbound or eastbound/westbound)
        const hasTrains = isTerminal
          ? (stationData.arriving?.length > 0 || stationData.departing?.length > 0)
          : Object.values(stationData).some(arr => arr?.length > 0);

        return (
          <div className={`mb-4 ${cardBg} rounded-xl border ${borderColor} overflow-hidden`}>
            {/* Station Header (Clickable) */}
            <button
              onClick={toggleExpand}
              className={`w-full px-4 py-3 flex items-center justify-between hover:opacity-80 transition-opacity ${isDarkMode ? 'bg-gray-800' : 'bg-gray-50'}`}
            >
              <div className="flex items-center gap-3">
                <span className="text-lg">{isExpanded ? 'â–¼' : 'â–¶'}</span>
                <h3 className={`text-lg font-bold ${textColor}`}>{stationName}</h3>
                {isTerminal && (
                  <span className={`text-xs px-2 py-1 rounded ${isDarkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-800'}`}>
                    Terminal
                  </span>
                )}
              </div>
              {hasTrains && (
                <span className={`text-xs ${textMuted}`}>
                  {isTerminal
                    ? `${(stationData.arriving?.length || 0) + (stationData.departing?.length || 0)} trains`
                    : `${Object.values(stationData).flat().length} trains`}
                </span>
              )}
            </button>

            {/* Station Content (Expandable) */}
            {isExpanded && (
              <div className="p-4 space-y-4">
                {isTerminal ? (
                  <>
                    {/* Arriving Trains */}
                    {stationData.arriving && stationData.arriving.length > 0 && (
                      <div>
                        <div className={`flex items-center gap-2 mb-3 pb-2 border-b-2 ${isDarkMode ? 'border-green-700' : 'border-green-300'}`}>
                          <span className="text-xl">ðŸš†</span>
                          <h4 className={`text-md font-bold ${isDarkMode ? 'text-green-300' : 'text-green-900'}`}>Arriving</h4>
                          <span className={`text-xs ${textMuted}`}>Train is arriving:</span>
                        </div>
                        <div className="space-y-3">
                          {stationData.arriving.map((train, idx) => renderTrainCard(train, idx, 'arrival'))}
                        </div>
                      </div>
                    )}

                    {/* Departing Trains */}
                    {stationData.departing && stationData.departing.length > 0 && (
                      <div>
                        <div className={`flex items-center gap-2 mb-3 pb-2 border-b-2 ${isDarkMode ? 'border-purple-700' : 'border-purple-300'}`}>
                          <span className="text-xl">ðŸš€</span>
                          <h4 className={`text-md font-bold ${isDarkMode ? 'text-purple-300' : 'text-purple-900'}`}>Departing</h4>
                          <span className={`text-xs ${textMuted}`}>Departs for:</span>
                        </div>
                        <div className="space-y-3">
                          {stationData.departing.map((train, idx) => renderTrainCard(train, idx, 'departure'))}
                        </div>
                      </div>
                    )}

                    {!hasTrains && (
                      <div className={`p-6 text-center rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="text-4xl mb-2">ðŸš‰</div>
                        <p className={`font-semibold mb-1 ${textColor}`}>No upcoming trains</p>
                        <p className={`text-xs ${textMuted}`}>
                          Service may be limited at this time. Check back during peak hours.
                        </p>
                      </div>
                    )}
                  </>
                ) : (
                  <>
                    {/* Middle Station: Show directional trains */}
                    {Object.entries(stationData).map(([direction, trains]) => {
                      if (!trains || trains.length === 0) return null;

                      const directionColors = {
                        northbound: { border: 'border-purple-700', dark: 'border-purple-300', text: 'text-purple-300', textLight: 'text-purple-900' },
                        southbound: { border: 'border-orange-700', dark: 'border-orange-300', text: 'text-orange-300', textLight: 'text-orange-900' },
                        eastbound: { border: 'border-blue-700', dark: 'border-blue-300', text: 'text-blue-300', textLight: 'text-blue-900' },
                        westbound: { border: 'border-orange-700', dark: 'border-orange-300', text: 'text-orange-300', textLight: 'text-orange-900' }
                      };

                      const colors = directionColors[direction] || directionColors.northbound;
                      const borderColor = isDarkMode ? colors.border : colors.dark;
                      const textColor = isDarkMode ? colors.text : colors.textLight;

                      return (
                        <div key={direction}>
                          <div className={`flex items-center gap-2 mb-3 pb-2 border-b-2 ${borderColor}`}>
                            <span className="text-xl">â†’</span>
                            <h4 className={`text-md font-bold ${textColor}`}>
                              {direction.charAt(0).toUpperCase() + direction.slice(1)}
                            </h4>
                          </div>
                          <div className="space-y-3">
                            {trains.map((train, idx) => renderTrainCard(train, idx, 'arrival'))}
                          </div>
                        </div>
                      );
                    })}

                    {!hasTrains && (
                      <div className={`p-6 text-center rounded-xl ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="text-4xl mb-2">ðŸš‰</div>
                        <p className={`font-semibold mb-1 ${textColor}`}>No upcoming trains</p>
                        <p className={`text-xs ${textMuted}`}>
                          Service may be limited at this time. Check back during peak hours.
                        </p>
                      </div>
                    )}
                  </>
                )}
              </div>
            )}
          </div>
        );
      };

      // Loading Screen Component
      if (isInitialLoad) {
        return (
          <div className={`min-h-screen flex items-center justify-center bg-gradient-to-br ${theme}`}>
            <div className="text-center px-4">
              <div className="mb-8">
                <h1 className={`text-4xl sm:text-5xl font-bold ${textColor} mb-2`}>
                  Taskify
                </h1>
                <p className={`text-xl ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                  Commute Dashboard
                </p>
              </div>

              {/* Loading Animation */}
              <div className="mb-6">
                <div className={`inline-block animate-spin rounded-full h-16 w-16 border-b-4 ${isDarkMode ? 'border-blue-500' : 'border-blue-600'} mb-4`}></div>
              </div>

              {/* Loading Status */}
              <div className={`space-y-2 ${textMuted}`}>
                <p className="text-sm">Loading your commute data...</p>
                <div className="flex justify-center gap-4 text-xs mt-4">
                  <span className={loading.weather ? 'opacity-50' : 'opacity-100'}>
                    {loading.weather ? 'â³' : 'âœ“'} Weather
                  </span>
                  <span className={loading.drive ? 'opacity-50' : 'opacity-100'}>
                    {loading.drive ? 'â³' : 'âœ“'} Routes
                  </span>
                  <span className={loading.transit ? 'opacity-50' : 'opacity-100'}>
                    {loading.transit ? 'â³' : 'âœ“'} Transit
                  </span>
                </div>
                <p className="text-xs mt-4 opacity-70">
                  This may take up to 45 seconds on first load
                </p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className={`min-h-screen bg-gradient-to-br ${theme} fade-in`}>
          <div className="max-w-6xl mx-auto content-area">
            {/* Header */}
            <div className={`${cardBg} shadow-lg p-4 sm:p-6 border-b ${borderColor} sticky top-0 z-40`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div>
                  <h1 className={`text-2xl sm:text-3xl font-bold ${textColor} mb-1`}>
                    Taskify || Commute Dashboard
                  </h1>
                  <p className={`text-sm ${textMuted}`}>
                    {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} â€¢ {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                  <p className={`text-base font-semibold mt-1 ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                    {greeting.timeGreeting} â€¢ {greeting.contextGreeting}
                  </p>
                </div>

                {/* Weather widget in header */}
                {weather && !weather._isFallback && (
                  <div className={`flex items-center gap-3 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} px-3 py-2 rounded-xl`}>
                    <img src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png`} alt={weather.weather[0].description} className="w-12 h-12" />
                    <div>
                      <p className={`text-2xl font-bold ${textColor}`}>{Math.round(weather.main.temp)}Â°F</p>
                      <p className={`text-xs ${textMuted} capitalize`}>{weather.weather[0].description}</p>
                    </div>
                  </div>
                )}
              </div>

              {/* Controls */}
              <div className="flex flex-wrap gap-2 mt-3">
                <button
                  onClick={handleManualRefresh}
                  className={`px-3 py-1.5 text-sm rounded-lg font-medium transition-all ${
                    refreshSuccess
                      ? 'bg-green-600 text-white'
                      : isDarkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'
                  }`}
                  aria-label="Refresh all data"
                >
                  {refreshSuccess ? 'âœ“ Refreshed' : 'ðŸ”„ Refresh'}
                </button>

                <button
                  onClick={() => setIsDarkMode(!isDarkMode)}
                  className={`px-3 py-1.5 text-sm rounded-lg font-medium transition-all ${isDarkMode ? 'bg-yellow-500 text-gray-900 hover:bg-yellow-400' : 'bg-gray-800 text-white hover:bg-gray-700'}`}
                  aria-label={isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                >
                  {isDarkMode ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark'}
                </button>

                <div className={`px-3 py-1.5 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-200'} ${textMuted} text-xs`}>
                  {lastRefresh.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>

            {/* Content Area - Only show active section */}
            <div className="p-4 slide-in">
              {/* Drive Time Section */}
              {activeSection === 'drive' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-4 sm:p-6 border ${borderColor}`}>
                  <div className="flex items-center justify-between mb-4">
                    <h2 className={`text-xl sm:text-2xl font-bold ${textColor}`}>ðŸš— Drive Times</h2>
                    <button
                      onClick={fetchDriveTimes}
                      className={`px-3 py-2 rounded-lg text-sm ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                      disabled={loading.drive}
                    >
                      {loading.drive ? 'â³' : 'ðŸ”„'}
                    </button>
                  </div>

                  {loading.drive && !driveData ? (
                    <div className="space-y-3">
                      {[1, 2, 3].map((i) => (
                        <div key={i} className={`p-4 rounded-xl ${isDarkMode ? 'skeleton-dark' : 'skeleton'} h-24`}></div>
                      ))}
                    </div>
                  ) : driveData && (
                    <>
                      {driveData._isFallback && (
                        <div className={`p-3 rounded-lg mb-4 ${isDarkMode ? 'bg-yellow-900 bg-opacity-30 text-yellow-300' : 'bg-yellow-100 text-yellow-800'}`}>
                          <p className="text-sm">âš ï¸ Using estimated times</p>
                        </div>
                      )}

                      <div className="flex items-center justify-between mb-4 flex-wrap gap-2">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <span className={`text-sm font-medium ${textColor}`}>Avoid Highways</span>
                          <div className="relative">
                            <input type="checkbox" checked={avoidHighways} onChange={(e) => setAvoidHighways(e.target.checked)} className="sr-only" />
                            <div className={`w-12 h-6 rounded-full transition-colors ${avoidHighways ? 'bg-green-500' : 'bg-gray-300'}`}>
                              <div className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${avoidHighways ? 'translate-x-6' : ''}`} />
                            </div>
                          </div>
                        </label>

                        <a
                          href={`https://www.google.com/maps/dir/${config.locations.home.lat},${config.locations.home.lng}/${config.locations.work.lat},${config.locations.work.lng}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className={`px-3 py-1.5 rounded-lg text-sm font-medium ${isDarkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                        >
                          ðŸ—ºï¸ Maps
                        </a>
                      </div>

                      <div className="space-y-3">
                        <div className={`p-4 rounded-xl border-2 ${isDarkMode ? 'bg-orange-900 bg-opacity-30 border-orange-700' : 'bg-orange-50 border-orange-200'}`}>
                          <p className={`text-xs font-semibold mb-2 ${isDarkMode ? 'text-orange-400' : 'text-orange-800'}`}>ðŸš— Home â†’ Garage</p>
                          <p className={`text-2xl font-bold ${isDarkMode ? 'text-orange-300' : 'text-orange-900'}`}>{formatDuration(Math.round(driveData.morning.duration.value / 60))}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-orange-400' : 'text-orange-700'}`}>{driveData.morning.distance.text}</p>
                        </div>

                        <div className={`p-4 rounded-xl border-2 ${isDarkMode ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                          <p className={`text-xs font-semibold mb-2 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>ðŸš¶ Garage â†’ Work</p>
                          <p className={`text-2xl font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>{formatDuration(Math.round(driveData.walk.duration.value / 60))}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{driveData.walk.distance.text}</p>
                        </div>

                        <div className={`p-4 rounded-xl border-2 ${isDarkMode ? 'bg-purple-900 bg-opacity-30 border-purple-700' : 'bg-purple-50 border-purple-200'}`}>
                          <p className={`text-xs font-semibold mb-2 ${isDarkMode ? 'text-purple-400' : 'text-purple-800'}`}>ðŸ  Garage â†’ Home</p>
                          <p className={`text-2xl font-bold ${isDarkMode ? 'text-purple-300' : 'text-purple-900'}`}>{formatDuration(Math.round(driveData.evening.duration.value / 60))}</p>
                          <p className={`text-sm ${isDarkMode ? 'text-purple-400' : 'text-purple-700'}`}>{driveData.evening.distance.text}</p>
                        </div>
                      </div>

                      <div className={`mt-4 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <p className={`text-sm ${textColor}`}>
                          <span className="font-semibold">Total: </span>
                          {Math.round(driveData.morning.duration.value / 60) + Math.round(driveData.walk.duration.value / 60)} min
                        </p>
                      </div>
                    </>
                  )}
                </div>
              )}

              {/* Transit Lines Section (N Line & G Line) */}
              {activeSection === 'nline' && (
                <div className="space-y-4">
                  {/* Board Controls */}
                  <div className={`${cardBg} rounded-xl shadow-lg p-3 border ${borderColor}`}>
                    <div className="flex items-center justify-end">
                      <button
                        onClick={() => { fetchTransitData(); fetchGLineData(); fetchBLineData(); }}
                        className={`px-4 py-2 rounded-lg text-sm font-medium ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} transition-all`}
                        disabled={loading.transit || loading.gLine || loading.bLine}
                      >
                        {(loading.transit || loading.gLine || loading.bLine) ? 'â³ Refreshing...' : 'ðŸ”„ Refresh Data'}
                      </button>
                    </div>
                  </div>

                  {/* Departures Board */}
                  {(() => {
                    const lineData = getTrainsForSimplifiedBoard();
                    return (
                      <div className={`${cardBg} rounded-xl shadow-xl border ${borderColor} overflow-hidden`}>
                        {/* Board Header - Enhanced */}
                        <div className={`px-6 py-6 ${isDarkMode ? 'bg-gradient-to-r from-gray-900 to-gray-800' : 'bg-gradient-to-r from-gray-900 to-gray-700'} border-b-4 ${isDarkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                          <h2 className="text-3xl font-extrabold text-white text-center tracking-tight mb-2">
                            ðŸš† RTD LIVE DEPARTURES
                          </h2>
                          <p className={`text-center text-sm ${isDarkMode ? 'text-gray-300' : 'text-gray-200'} font-medium`}>
                            Real-Time Updates â€¢ Next 2 Trains Per Station
                          </p>
                          <div className="flex justify-center gap-2 mt-3">
                            <span className="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">
                              <span className="inline-block w-2 h-2 bg-white rounded-full mr-1 animate-pulse"></span>
                              LIVE
                            </span>
                            <span className="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-full">
                              Auto-Refresh 60s
                            </span>
                          </div>
                        </div>

                        {/* Board Content - Line by Line */}
                        <div className="p-4 sm:p-6 space-y-6">
                          {lineData.length === 0 ? (
                            <div className="py-12 text-center">
                              <div className="text-4xl mb-2">ðŸš‰</div>
                              <p className={`font-semibold mb-1 ${textColor}`}>No trains scheduled</p>
                              <p className={`text-xs ${textMuted}`}>
                                Service may be limited. Check back during peak hours.
                              </p>
                            </div>
                          ) : (
                            lineData.map((line, lineIdx) => (
                              <div key={lineIdx} className={`space-y-4 p-4 rounded-xl ${isDarkMode ? 'bg-gray-800/30' : 'bg-gray-50'} border-2 ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} transition-all hover:shadow-lg`}>
                                {/* Line Header - Enhanced */}
                                <div className="flex items-center gap-3 mb-4">
                                  <div className={`${line.color} text-white px-6 py-2.5 rounded-xl font-extrabold text-base shadow-lg transform transition-transform hover:scale-105`}>
                                    {line.name}
                                  </div>
                                  <div className={`flex-1 h-1 ${line.color} rounded-full opacity-30`}></div>
                                </div>

                                {/* Line Sections */}
                                {line.sections && line.sections.map((section, sectionIdx) => (
                                  <div key={sectionIdx} className="mb-6 last:mb-0">
                                    {/* Section Header (Direction) - Enhanced */}
                                    <div className={`px-4 py-2.5 ${isDarkMode ? 'bg-gradient-to-r from-gray-700 to-gray-800' : 'bg-gradient-to-r from-gray-200 to-gray-300'} rounded-t-xl border-l-4 ${line.color}`}>
                                      <h3 className={`font-black text-sm uppercase tracking-wide ${textColor}`}>
                                        {section.title === 'Northbound' && 'â¬†ï¸ '}
                                        {section.title === 'Southbound' && 'â¬‡ï¸ '}
                                        {section.title === 'Westbound' && 'â¬…ï¸ '}
                                        {section.title === 'Eastbound' && 'âž¡ï¸ '}
                                        {section.title}
                                      </h3>
                                    </div>

                                    {/* Section Table */}
                                    <div className="overflow-x-auto">
                                      <table className="w-full text-sm">
                                        <thead>
                                          <tr className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} text-xs`}>
                                            <th className={`px-3 py-2 text-left font-semibold ${textColor}`}>Destination/Direction</th>
                                            <th className={`px-3 py-2 text-left font-semibold ${textColor}`}>Status</th>
                                            <th className={`px-3 py-2 text-center font-semibold ${textColor}`}>
                                              <div>Next Train</div>
                                              <div className={`text-xs font-normal ${textMuted} mt-0.5`}>Departure</div>
                                            </th>
                                            <th className={`px-3 py-2 text-right font-semibold ${textColor}`}>
                                              <div>Upcoming</div>
                                              <div className={`text-xs font-normal ${textMuted} mt-0.5`}>Departure</div>
                                            </th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {section.rows.map((row, rowIdx) => {
                                            const nextTrain = row.trains[0];
                                            const upcomingTrain = row.trains[1];
                                            const status = nextTrain ? row.getStatus(nextTrain) : null;

                                            return (
                                              <tr
                                                key={rowIdx}
                                                className={`border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-300'} transition-all duration-200 hover:${isDarkMode ? 'bg-gray-700/50' : 'bg-gray-100'} hover:scale-[1.01] hover:shadow-md cursor-pointer`}
                                              >
                                                {/* Station */}
                                                <td className={`px-4 py-4 ${textColor}`}>
                                                  <span className="font-semibold text-base">â€¢ {row.station}</span>
                                                </td>

                                                {/* Status - Enhanced */}
                                                <td className="px-4 py-4">
                                                  {status ? (
                                                    <span className={`inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold ${status.color} ${
                                                      status.text === 'Arriving' ? 'bg-yellow-100 dark:bg-yellow-900' :
                                                      status.text === 'Departing' ? 'bg-blue-100 dark:bg-blue-900' :
                                                      status.text === 'Delayed' ? 'bg-red-100 dark:bg-red-900' :
                                                      'bg-green-100 dark:bg-green-900'
                                                    }`}>
                                                      {status.text === 'Arriving' && 'ðŸ”” '}
                                                      {status.text === 'Departing' && 'ðŸš€ '}
                                                      {status.text === 'Delayed' && 'âš ï¸ '}
                                                      {status.text === 'On Time' && 'âœ“ '}
                                                      {status.text}
                                                    </span>
                                                  ) : (
                                                    <span className={textMuted}>â€”</span>
                                                  )}
                                                </td>

                                                {/* Departure Time - Enhanced */}
                                                <td className="px-4 py-4 text-center">
                                                  {nextTrain ? (
                                                    <span className={`font-mono font-bold text-lg ${textColor} px-3 py-1.5 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-white'} border-2 ${isDarkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                                      {nextTrain.departureTime || nextTrain.arrivalTime || 'â€”'}
                                                    </span>
                                                  ) : (
                                                    <span className={textMuted}>â€”</span>
                                                  )}
                                                </td>

                                                {/* Upcoming Departure - Enhanced */}
                                                <td className="px-4 py-4 text-right">
                                                  {upcomingTrain ? (
                                                    <span className={`font-mono font-semibold text-base ${textColor} px-3 py-1 rounded-lg ${isDarkMode ? 'bg-gray-700/50' : 'bg-gray-100'}`}>
                                                      {upcomingTrain.departureTime || upcomingTrain.arrivalTime || 'â€”'}
                                                    </span>
                                                  ) : (
                                                    <span className={textMuted}>â€”</span>
                                                  )}
                                                </td>
                                              </tr>
                                            );
                                          })}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ))
                          )}
                        </div>

                        {/* Board Footer */}
                        <div className={`px-6 py-3 ${isDarkMode ? 'bg-gray-900' : 'bg-gray-800'} border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-600'}`}>
                          <p className="text-center text-xs text-gray-400">
                            ðŸ”´ Live RTD Data â€¢ Updates every minute â€¢ Showing next 2 trains per station
                          </p>
                        </div>
                      </div>
                    );
                  })()}

                </div>
              )}

              {/* Bus Schedule Section */}
              {activeSection === 'bus' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-4 sm:p-6 border ${borderColor}`}>
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">ðŸšŒ</span>
                    <h2 className={`text-xl sm:text-2xl font-bold ${textColor}`}>Downtown Shuttle</h2>
                  </div>

                  <div className={`p-4 rounded-xl mb-4 ${isDarkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50'}`}>
                    <p className={`font-semibold mb-3 text-base ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>ðŸšŒ Available Shuttle Services</p>

                    <div className={`space-y-4 text-sm ${isDarkMode ? 'text-blue-200' : 'text-blue-800'}`}>
                      <div>
                        <p className="font-semibold text-base mb-2">16th Street FreeRide</p>
                        <ul className="space-y-1 pl-4">
                          <li>â€¢ Free shuttle every ~5 minutes</li>
                          <li>â€¢ Route: 16th Street Mall</li>
                          <li>â€¢ Hours: 5:30 AM - 12:30 AM daily</li>
                          <li>â€¢ Connects Union Station â†” Civic Center</li>
                          <li>â€¢ Walk from Union Station: 4-7 minutes</li>
                        </ul>
                      </div>

                      <div className={`pt-3 border-t ${isDarkMode ? 'border-blue-700' : 'border-blue-300'}`}>
                        <p className="font-semibold text-base mb-2">MetroRide - Civic Center Station</p>
                        <ul className="space-y-1 pl-4">
                          <li>â€¢ Free downtown circulator bus</li>
                          <li>â€¢ Route: Civic Center â†” Union Station</li>
                          <li>â€¢ Hours: Weekdays 6:30 AM - 7:00 PM</li>
                          <li>â€¢ Frequency: Every 5-10 minutes</li>
                          <li>â€¢ Stops near 16th Street Mall</li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div className={`p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-xs ${textMuted}`}>
                      â„¹ï¸ Both services are FREE and connect Union Station to downtown Denver
                    </p>
                  </div>
                </div>
              )}

              {/* Search Locator Section */}
              {activeSection === 'search' && (
                <div className={`${cardBg} rounded-2xl shadow-xl p-4 sm:p-6 border ${borderColor}`}>
                  <h2 className={`text-xl sm:text-2xl font-bold ${textColor} mb-4`}>ðŸ” Search Drive Times</h2>

                  <form
                    onSubmit={(e) => {
                      e.preventDefault();
                      if (searchFromAddress && searchToAddress && !loading.search) {
                        searchDriveTimes();
                      }
                    }}
                    className="space-y-3 mb-4"
                  >
                    <div>
                      <label htmlFor="from-address" className={`block text-sm font-medium ${textColor} mb-1`}>From Address</label>
                      <input
                        id="from-address"
                        type="text"
                        value={searchFromAddress}
                        onChange={(e) => setSearchFromAddress(e.target.value)}
                        placeholder="123 Main St, Denver, CO"
                        aria-label="Starting address"
                        className={`w-full px-3 py-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'}`}
                      />
                    </div>

                    <div>
                      <label htmlFor="to-address" className={`block text-sm font-medium ${textColor} mb-1`}>To Address</label>
                      <input
                        id="to-address"
                        type="text"
                        value={searchToAddress}
                        onChange={(e) => setSearchToAddress(e.target.value)}
                        placeholder="456 Market St, Denver, CO"
                        aria-label="Destination address"
                        className={`w-full px-3 py-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'}`}
                      />
                    </div>

                    <button
                      type="submit"
                      disabled={!searchFromAddress || !searchToAddress || loading.search}
                      className={`w-full px-4 py-2.5 rounded-lg font-semibold ${
                        !searchFromAddress || !searchToAddress || loading.search
                          ? 'bg-gray-400 cursor-not-allowed'
                          : isDarkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'
                      } text-white transition-all`}
                      aria-label="Search drive times"
                    >
                      {loading.search ? 'Searching...' : 'ðŸ” Search'}
                    </button>
                  </form>

                  {searchResults && (
                    <div className="space-y-3">
                      {searchResults.error ? (
                        <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-red-900 bg-opacity-30 text-red-300' : 'bg-red-50 text-red-800'}`}>
                          <p className="text-sm">{searchResults.error}</p>
                        </div>
                      ) : (
                        <>
                          <div className={`p-4 rounded-xl border-2 ${isDarkMode ? 'bg-green-900 bg-opacity-30 border-green-700' : 'bg-green-50 border-green-200'}`}>
                            <p className={`text-xs font-semibold mb-1 ${isDarkMode ? 'text-green-400' : 'text-green-800'}`}>ðŸ›£ï¸ With Highway</p>
                            <p className={`text-xl font-bold ${isDarkMode ? 'text-green-300' : 'text-green-900'}`}>{formatDuration(searchResults.withHighway.durationMinutes)}</p>
                            <p className={`text-sm ${isDarkMode ? 'text-green-400' : 'text-green-700'}`}>{searchResults.withHighway.distance}</p>
                          </div>

                          <div className={`p-4 rounded-xl border-2 ${isDarkMode ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-blue-50 border-blue-200'}`}>
                            <p className={`text-xs font-semibold mb-1 ${isDarkMode ? 'text-blue-400' : 'text-blue-800'}`}>ðŸš— Without Highway</p>
                            <p className={`text-xl font-bold ${isDarkMode ? 'text-blue-300' : 'text-blue-900'}`}>{formatDuration(searchResults.noHighway.durationMinutes)}</p>
                            <p className={`text-sm ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{searchResults.noHighway.distance}</p>
                          </div>
                        </>
                      )}
                    </div>
                  )}

                  <div className={`mt-4 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-xs ${textMuted} mb-2 font-semibold`}>Quick Locations:</p>
                    <div className="grid grid-cols-2 gap-2 text-xs">
                      <button
                        onClick={() => setSearchFromAddress('104th Ave & Washington St, Northglenn, CO')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Home
                      </button>
                      <button
                        onClick={() => setSearchFromAddress('Union Station, Denver, CO')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Garage
                      </button>
                      <button
                        onClick={() => setSearchToAddress('Union Station, Denver, CO')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Garage
                      </button>
                      <button
                        onClick={() => setSearchToAddress('1700 Broadway, Denver, CO')}
                        className={`px-2 py-1 rounded ${isDarkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                      >
                        Work
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer info */}
            <div className={`text-center py-4 ${textMuted}`}>
              <p className="text-xs">Auto-refresh: 15 min (Transit: 1 min)</p>
            </div>
          </div>

          {/* Bottom Navigation Bar */}
          <nav className={`bottom-nav ${cardBg} border-t ${borderColor} shadow-lg`} aria-label="Main navigation" role="navigation">
            <div className="max-w-6xl mx-auto px-2 py-3">
              <div className="flex justify-around items-center" role="tablist">
                <button
                  onClick={() => setActiveSection('drive')}
                  className={`flex flex-col items-center gap-1 px-2 py-2 rounded-lg transition-all ${
                    activeSection === 'drive'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : textMuted
                  }`}
                  aria-label="Drive times section"
                  aria-current={activeSection === 'drive' ? 'page' : undefined}
                >
                  <span className="text-2xl" aria-hidden="true">ðŸš—</span>
                  <span className="text-xs font-medium">Drive</span>
                </button>

                <button
                  onClick={() => setActiveSection('nline')}
                  className={`flex flex-col items-center gap-1 px-2 py-2 rounded-lg transition-all ${
                    activeSection === 'nline'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : textMuted
                  }`}
                  aria-label="Rail transit schedule section"
                  aria-current={activeSection === 'nline' ? 'page' : undefined}
                >
                  <span className="text-2xl" aria-hidden="true">ðŸš†</span>
                  <span className="text-xs font-medium">Transit</span>
                </button>

                <button
                  onClick={() => setActiveSection('bus')}
                  className={`flex flex-col items-center gap-1 px-2 py-2 rounded-lg transition-all ${
                    activeSection === 'bus'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : textMuted
                  }`}
                  aria-label="Bus schedule section"
                  aria-current={activeSection === 'bus' ? 'page' : undefined}
                >
                  <span className="text-2xl" aria-hidden="true">ðŸšŒ</span>
                  <span className="text-xs font-medium">Bus</span>
                </button>

                <button
                  onClick={() => setActiveSection('search')}
                  className={`flex flex-col items-center gap-1 px-2 py-2 rounded-lg transition-all ${
                    activeSection === 'search'
                      ? isDarkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'
                      : textMuted
                  }`}
                  aria-label="Search locator section"
                  aria-current={activeSection === 'search' ? 'page' : undefined}
                >
                  <span className="text-2xl" aria-hidden="true">ðŸ”</span>
                  <span className="text-xs font-medium">Search</span>
                </button>
              </div>
            </div>
          </nav>
        </div>
      );
    };

    ReactDOM.render(<CommuteDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
