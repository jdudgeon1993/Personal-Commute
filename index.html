<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Commuter Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* -------------------------------------
           GLOBAL THEME & TYPOGRAPHY
           ------------------------------------- */
        :root {
            --background: #fcfcfc;
            --surface: #ffffff;
            --text: #1a1a1a;
            --muted: #6b7280; 
            --border: #e5e7eb; 
            --success: #10b981; 
            --warn: #f59e0b; 
            --danger: #ef4444; 
            --accent: #3b82f6; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --accent-rgb: 59, 130, 246; 
            --text-rgb: 26, 26, 26;     
            --warn-rgb: 245, 158, 11;   
        }

        .dark {
            --background: #181a20;
            --surface: #20232a;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: #374151;
            --success: #4ade80; 
            --warn: #fbbf24; 
            --danger: #f87171; 
            --accent: #60a5fa; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --accent-rgb: 96, 165, 250; 
            --text-rgb: 229, 231, 235;
            --warn-rgb: 251, 191, 36;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 30px;
            background-color: var(--background);
            color: var(--text);
            transition: background-color 0.4s, color 0.4s;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, border-color 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .dark .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card-header-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-icon {
            background-color: var(--accent);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .header-card {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column; /* CHANGE: Stack on small screens */
            align-items: stretch; /* Stretch controls to full width */
            padding: 0 10px 0 0; 
            background-color: transparent; 
            box-shadow: none; 
            border: none; 
            gap: 15px; /* Added gap */
        }
        
        .header-card > div:first-child {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #commuteTitle {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text);
            line-height: 1;
            display: inline-block; 
        }
        
        /* #currentModeTitle is deprecated */

        #headerSubtitle {
            font-size: 1rem;
            color: var(--muted);
            font-weight: 500;
            margin-top: 5px;
        }
        
        /* UPDATED: Stacked controls */
        .controls {
            display: flex;
            flex-direction: column; /* Stacked buttons */
            gap: 10px; 
            align-items: stretch; 
            margin-top: 15px; 
        }

        .controls button {
            background-color: var(--accent);
            color: white; 
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s, color 0.3s;
            font-weight: 600;
            width: 100%; /* Take full width */
            min-width: 0;
        }
        
        #themeToggle {
            background-color: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px;
            width: 100%; /* Take full width */
            min-width: 0;
            height: auto; 
            font-size: 1.2rem;
        }
        
        .controls button:hover, #themeToggle:hover {
            opacity: 0.9;
        }

        .schedule-data-group {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .schedule-data-column {
            flex: 1;
            background-color: rgba(var(--text-rgb), 0.03); 
            padding: 15px;
            border-radius: 10px;
        }
        
        .schedule-data-column:nth-child(2) {
            background-color: rgba(var(--accent-rgb), 0.05); 
            flex-grow: 0;
        }

        .schedule-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 5px;
        }

        #requiredDepartureTime {
            font-size: 2.2rem; 
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1px;
            display: block;
            margin-top: 0;
            color: var(--text); 
        }
        
        #targetArrivalDisplay {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1.1;
        }

        #departureNote {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 10px;
            color: var(--muted);
        }

        .current-time-block {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        #currentTimeBig {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1px;
        }
        
        .current-time-block button {
            width: 100%;
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Weather in Schedule Card Styling */
        .weather-info {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        #weatherTemp {
            font-size: 3rem; 
            font-weight: 800;
            color: var(--danger);
            line-height: 1;
        }

        .weather-details {
            display: flex;
            flex-direction: column;
            gap: 5px; 
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--muted);
        }
        
        #weatherIcon img {
             filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.2));
             transition: filter 0.3s;
             width: 50px; 
             height: 50px;
        }
        
        /* Drive Card Styling for Two-Leg Commute */
        .commute-group {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .commute-header {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .commute-total {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--danger);
            line-height: 1.1;
            letter-spacing: -1px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
            margin-top: 10px;
        }
        
        .leg-time {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 1rem;
            color: var(--muted);
        }

        .leg-time span {
            font-weight: 600;
            color: var(--success);
        }
        
        .transit-direction {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            transition: border-color 0.3s;
        }

        .transit-direction h3 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.3s;
        }
        
        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            font-size: 1rem;
            background-color: rgba(var(--text-rgb), 0.03); 
            transition: background-color 0.3s;
        }
        
        .prediction-item.next-up {
            background-color: rgba(var(--accent-rgb), 0.1);
        }
        
        .schedule-time {
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        .schedule-countdown {
            color: var(--success);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .schedule-arriving {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            animation: pulse-arriving 1.5s infinite alternate;
        }

        @keyframes pulse-arriving {
            from { opacity: 1; transform: scale(1.0); }
            50% { opacity: 0.9; transform: scale(1.02); }
            to { opacity: 1; transform: scale(1.0); }
        }

        .schedule-critical {
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--warn); 
            animation: pulse-critical 2s infinite alternate;
        }
        
        @keyframes pulse-critical {
            from { color: var(--warn); transform: scale(1.0); }
            50% { color: var(--danger); transform: scale(1.05); }
            to { color: var(--warn); transform: scale(1.0); }
        }

        .schedule-departing {
            color: var(--danger);
            font-weight: 900;
            font-size: 1.1rem;
            animation: pulse-red 1s infinite alternate;
        }
        
        @keyframes pulse-red {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        .schedule-no-service {
            color: var(--muted);
            font-style: italic;
            padding: 15px;
            text-align: center;
        }
        
        #transitMapBtn {
            width: 100%;
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 20px; 
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }
        
        #driveToWorkBtn {
            width: 100%;
            background-color: var(--warn); 
            color: var(--text); 
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 15px; 
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s, color 0.3s;
        }


        #alerts-card {
            grid-column: 1 / -1; 
            display: none; 
            border-left: 5px solid var(--warn);
            background-color: rgba(var(--warn-rgb), 0.1); 
            transition: background-color 0.3s, border-left-color 0.3s;
        }

        .alert-header {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--warn);
            display: flex; 
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .alert-item {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
            font-size: 0.95rem;
            align-items: flex-start;
        }

        .alert-icon {
            flex-shrink: 0;
            font-size: 1.1em;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--text);
        }
        
        .control-group input[type="checkbox"] {
            transform: scale(1.1);
            accent-color: var(--accent);
            transition: accent-color 0.3s;
        }
        
        /* COLLAPSIBLE STYLES */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-icon {
            transition: transform 0.3s;
            font-size: 1.5rem;
            line-height: 1;
            margin-left: 15px; 
        }
        
        .card[data-collapsed="true"] .collapsible-icon {
            transform: rotate(0deg); 
        }
        
        .card[data-collapsed="true"] .card-content {
            display: none;
        }
        
        .card[data-collapsed="false"] .collapsible-icon {
            transform: rotate(90deg); 
        }
        
        /* Specific header style overrides for better visual flow on collapsible cards */
        /* Default state: full margin/padding/border */
        #driveTimesCard .card-header-group, 
        #transitCard .card-header-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        /* Collapsed state: removes the extra space and border */
        .card[data-collapsed="true"] .card-header-group {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        /* Handle the Alerts card specific classes for collapse */
        #alerts-card[data-collapsed="true"] .card-content {
            display: none !important;
        }
        
        .error-message {
            color: var(--danger);
            font-weight: 600;
        }
        
        /* --- COMMUTE MODE DISPLAY CSS --- */
        #morningCommuteGroup, #eveningCommuteGroup {
            display: none;
        }
        
        .transit-direction h3 .icon-span {
            font-size: 1.5rem;
            margin-left: 10px;
        }
        
        /* Media query for wider screens to keep side-by-side layout */
        @media (min-width: 768px) {
            .header-card {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 20px;
            }
            
            .controls {
                flex-direction: row;
                gap: 15px;
                margin-top: 0;
            }
            
            .controls button {
                width: auto;
                min-width: 120px;
            }
            
            #themeToggle {
                width: 45px;
                height: 45px;
                padding: 10px;
            }
        }

    </style>
</head>
<body class="dark">

    <div class="header-card">
        <div>
            <div id="mainTitleGroup">
                <span id="commuteTitle">Commute Dashboard</span>
            </div>
            <div id="headerSubtitle">Loading...</div>
        </div>
        <div class="controls">
            <button id="modeSwitchBtn" title="Switch Commute Mode">üîÑ Morning Mode</button>
            <button id="refreshBtn">Refresh Now</button>
            <button id="themeToggle">üåì</button>
        </div>
    </div>
    
    <div id="alerts-card" class="card" data-collapsed="true">
        <div id="alertsHeader" class="alert-header">
            <span>‚ö†Ô∏è Service Alerts</span>
            <span class="collapsible-icon" onclick="toggleCollapse('alerts-card')">‚ñ∂</span>
        </div>
        <div class="card-content" id="alertsContent">
            </div>
    </div>

    <div class="dashboard-grid">
        
        <div class="card" id="workScheduleCard">
            
            <div class="card-header-group">
                <div class="card-icon">‚è∞</div>
                <div>
                    <div class="schedule-label">Today's Schedule</div>
                    <div class="card-title-text">Work: <span id="scheduleTimeWindow">--:--</span></div>
                </div>
            </div>

            <div class="weather-info">
                <div id="weatherIcon"></div>
                <div>
                    <div id="weatherTemp">--¬∞F</div>
                    <div id="weatherDesc" style="font-weight: 600;">Loading...</div>
                </div>
                <div class="weather-details">
                    <span id="weatherFeels"></span>
                    <span id="weatherWind"></span>
                    <span id="weatherHumidity"></span>
                </div>
            </div>

            <div class="schedule-data-group">
                <div class="schedule-data-column">
                    <div class="schedule-label">Required Drive Departure Time</div>
                    <span id="requiredDepartureTime">N/A</span>
                    <div id="departureNote">No required departure time (non-work or past arrival target).</div>
                </div>
                
                <div class="schedule-data-column">
                    <div class="schedule-label" style="text-align: right;">Target Arrival:</div>
                    <div id="targetArrivalDisplay" style="text-align: right;">--:--</div>
                </div>
            </div>

            <div class="current-time-block">
                <div class="schedule-label">Current Time</div>
                <div id="currentTimeBig" style="margin-bottom: 10px;">--:--</div>
                <button id="openWorkMapBtn">Open Map for Commute</button>
            </div>
            
        </div>
        
        <div class="card" id="driveTimesCard" data-collapsed="true">
            <div id="driveHeader" class="collapsible-header">
                <div class="card-header-group">
                    <div class="card-icon" style="background-color: var(--warn);">üöó</div>
                    <div class="card-title-text">Drive Times</div>
                </div>
                <span class="collapsible-icon" onclick="toggleCollapse('driveTimesCard')">‚ñº</span>
            </div>

            <div class="card-content">
                <div style="margin-bottom: 20px;">
                    <label for="avoidHighway" class="control-group">
                        <input type="checkbox" id="avoidHighway" onchange="initCommute()"> 
                        Avoid Highways
                    </label>
                </div>

                <div class="commute-group" id="morningCommuteGroup">
                    <div class="commute-header">
                        üåÖ Home ‚Üí Work
                        <span id="morning-departure-display" style="font-size: 0.9rem; color: var(--muted); font-weight: 500;">(Loading Departure Time...)</span>
                    </div>
                    
                    <div class="leg-time">Drive (Home ‚Üí Parking): <span id="morning-drive-time">Calculating...</span></div>
                    <div class="leg-time">Walk (Parking ‚Üí Work): <span id="morning-walk-time">Calculating...</span></div>
                    
                    <div class="commute-total">Total: <strong id="morning-total-time">...</strong></div>
                </div>

                <div class="commute-group" id="eveningCommuteGroup">
                    <div class="commute-header">
                        üåá Work ‚Üí Home
                        <span id="evening-departure-display" style="font-size: 0.9rem; color: var(--muted); font-weight: 500;">(Loading Departure Time...)</span>
                    </div>

                    <div class="leg-time">Walk (Work ‚Üí Parking): <span id="evening-walk-time">Calculating...</span></div>
                    <div class="leg-time">Drive (Parking ‚Üí Home): <span id="evening-drive-time">Calculating...</span></div>
                    
                    <div class="commute-total">Total: <strong id="evening-total-time">...</strong></div>
                </div>
                
                <button id="driveToWorkBtn">View Live Traffic Map</button>
            </div>
        </div>
        <div class="card" id="transitCard" data-collapsed="true">
            <div id="transitHeader" class="collapsible-header">
                <div class="card-header-group">
                    <div class="card-icon" style="background-color: var(--accent);">üöÜ</div>
                    <div class="card-title-text">N Line Transit Schedule (<span id="transitModeTitle">Southbound</span>)</div>
                </div>
                <span class="collapsible-icon" onclick="toggleCollapse('transitCard')">‚ñ∂</span>
            </div>

            <div class="card-content">
                <div id="currentDayScheduleSummary" style="font-size: 0.95rem; color: var(--muted); margin-bottom: 15px;">--</div>

                <div class="transit-direction" id="sb-direction-container">
                    <h3>Southbound (112th ‚Üí Union Station) <span class="icon-span">‚¨áÔ∏è</span></h3>
                    <div id="sb-window" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">--</div>
                    <div id="sb-predictions">
                        <div class="schedule-no-service">Loading schedule...</div>
                    </div>
                </div>

                <div class="transit-direction" id="nb-direction-container" style="display: none;">
                    <h3>Northbound (Union Station ‚Üí 112th) <span class="icon-span">‚¨ÜÔ∏è</span></h3>
                    <div id="nb-window" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">--</div>
                    <div id="nb-predictions">
                        <div class="schedule-no-service">Loading schedule...</div>
                    </div>
                </div>
                
                <button id="transitMapBtn">Open Transit Map</button>
            </div>
        </div>

    </div>

    <script>
// Use a single CONFIG object for easy updates
const CONFIG = {
    // API KEYS
    OPENWEATHER_API_KEY: '1c91f81f2adfd1b633d19842869a1a11', // <-- **INSERT YOUR KEY HERE**
    GOOGLE_MAPS_API_KEY: 'AIzaSyD37ON3q4SfgV7jHWdE74PtwoRdP_5gCGY', // <-- **INSERT YOUR KEY HERE**
    
    // ADDRESSES
    HOME_ADDR: '11625 Community Center Drive, Northglenn, CO 80233',
    PARKING_ADDR: '1801 California St, Denver, CO 80202', 
    WORK_ADDR: '707 17th Street, Denver, CO 80202',
    N_ORIGIN: '112th & Northglenn Station, Northglenn, CO',
    N_DEST: 'Denver Union Station, Denver, CO',
    
    // CONSTANTS
    ARRIVAL_BUFFER_MINS: 30, 
    MAX_PREDICTIONS: 3,
    OPENWEATHER_CITY_ID: 5419384,
    CRITICAL_TRANSIT_SECONDS: 300, // This is now ignored but kept for historical context
    MODE_SWITCH_DELAY_MINS: 30, // Switch to evening mode 30 mins after work start time

    // WORK SCHEDULE (HH:MM strings)
    WORK_SCHEDULE: {
        1: { start: '08:00', end: '17:30', leave: '17:30' }, 
        2: { start: '08:00', end: '17:30', leave: '17:30' }, 
        3: { start: '08:00', end: '17:30', leave: '17:30' }, 
        4: { start: '08:00', end: '17:30', leave: '17:30' }, 
        5: { start: '08:00', end: '16:30', leave: '16:30' }, // Friday 4:30 PM leave
        0: null, 
        6: null  
    },
    
    // RTD SCHEDULE (N Line)
    RTD_SCHEDULES: {
        'MT': { start_sb: { h: 4, m: 46 }, end_sb: { h: 22, m: 16 }, start_nb: { h: 5, m: 26 }, end_nb: { h: 22, m: 56 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
        'F': { start_sb: { h: 4, m: 46 }, end_sb: { h: 22, m: 46 }, start_nb: { h: 5, m: 26 }, end_nb: { h: 23, m: 26 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
        'SAT': { start_sb: { h: 5, m: 46 }, end_sb: { h: 23, m: 16 }, start_nb: { h: 6, m: 26 }, end_nb: { h: 23, m: 56 }, sbMinutes: [16, 46], nbMinutes: [26, 56] },
        'SUN': { start_sb: { h: 5, m: 46 }, end_sb: { h: 21, m: 46 }, start_nb: { h: 6, m: 26 }, end_nb: { h: 22, m: 26 }, sbMinutes: [16, 46], nbMinutes: [26, 56] }
    },
    
    // ALERTS (Hardcoded for demo)
    ALERTS: [
        /* Example alerts (uncomment to see them displayed)
        { type: 'DELAY', message: 'N Line running 15 minutes late due to signal issues near 88th.' },
        { type: 'ADVISORY', message: 'I-25 Southbound has heavy congestion this afternoon.' }
        */
    ]
};

// DOM REFERENCES - Consolidated for efficiency
const DOM_REFS = {
    headerSubtitle: document.getElementById('headerSubtitle'),
    scheduleTimeWindow: document.getElementById('scheduleTimeWindow'),
    targetArrivalDisplay: document.getElementById('targetArrivalDisplay'),
    currentTimeBig: document.getElementById('currentTimeBig'),
    openWorkMapBtn: document.getElementById('openWorkMapBtn'), 
    requiredDepartureTime: document.getElementById('requiredDepartureTime'),
    departureNote: document.getElementById('departureNote'),
    driveToWorkBtn: document.getElementById('driveToWorkBtn'), 
    currentDayScheduleSummary: document.getElementById('currentDayScheduleSummary'),
    // WEATHER ELEMENTS
    weatherTempEl: document.getElementById('weatherTemp'),
    weatherDescEl: document.getElementById('weatherDesc'),
    weatherIconEl: document.getElementById('weatherIcon'),
    weatherFeelsEl: document.getElementById('weatherFeels'),
    weatherWindEl: document.getElementById('weatherWind'),
    weatherHumidityEl: document.getElementById('weatherHumidity'),
    // DRIVE TIME ELEMENTS
    morningDepartureDisplay: document.getElementById('morning-departure-display'),
    eveningDepartureDisplay: document.getElementById('evening-departure-display'),
    morningDriveTime: document.getElementById('morning-drive-time'),
    morningWalkTime: document.getElementById('morning-walk-time'),
    morningTotalTime: document.getElementById('morning-total-time'),
    eveningWalkTime: document.getElementById('evening-walk-time'),
    eveningDriveTime: document.getElementById('evening-drive-time'),
    eveningTotalTime: document.getElementById('evening-total-time'),
    avoidCheckbox: document.getElementById('avoidHighway'),
    morningCommuteGroup: document.getElementById('morningCommuteGroup'),
    eveningCommuteGroup: document.getElementById('eveningCommuteGroup'),
    // TRANSIT ELEMENTS
    transitModeTitle: document.getElementById('transitModeTitle'),
    sbWindowEl: document.getElementById('sb-window'),
    nbWindowEl: document.getElementById('nb-window'),
    sbPredictionsContainer: document.getElementById('sb-predictions'),
    nbPredictionsContainer: document.getElementById('nb-predictions'),
    sbDirectionContainer: document.getElementById('sb-direction-container'),
    nbDirectionContainer: document.getElementById('nb-direction-container'),
    transitMapBtn: document.getElementById('transitMapBtn'), 
    alertsCard: document.getElementById('alerts-card'),
    alertsHeader: document.getElementById('alertsHeader'),
    alertsContent: document.getElementById('alertsContent'),
    refreshBtn: document.getElementById('refreshBtn'),
    themeToggle: document.getElementById('themeToggle'),
    modeSwitchBtn: document.getElementById('modeSwitchBtn'),
    commuteTitle: document.getElementById('commuteTitle'),
};


let mapService = null; 
let currentCommuteMode = 'morning'; 
const MORNING_HOUR = 7;
const MORNING_MINUTE = 30; 
let EVENING_HOUR;
let EVENING_MINUTE;


/* -------------------------
¬† ¬†Helpers and Time
¬† ¬†------------------------- */
function safeSet(el, txt, html=false){ 
    if(!el) return;
    if(html) el.innerHTML = txt ?? '‚Äî';
    else el.textContent = txt ?? '‚Äî'; 
}

const formatTime = (d) => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}); 
const formatTimeShort = (d) => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12: true}).replace(/\s/g, ''); 
        
const getCssVariable = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

function setDayTime(){ 
    const now = new Date(); 
    const dateText = now.toLocaleDateString(undefined, {weekday:'long', month: 'long', day: 'numeric'}); 
    safeSet(DOM_REFS.headerSubtitle, dateText); 
    safeSet(DOM_REFS.currentTimeBig, formatTime(now));
}

/* ----------------------------------------------------
   Commute Mode Logic
   ---------------------------------------------------- */
           
/**
 * Determines the appropriate commute mode based on the work schedule and time.
 */
function updateCommuteMode() {
    const now = new Date();
    const today = now.getDay();
    const schedule = CONFIG.WORK_SCHEDULE[today];
    let newMode = 'morning'; 

    if (schedule) {
        const [startH, startM] = schedule.start.split(':').map(Number);
        const workStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startH, startM, 0);
        
        const switchTimeMs = workStartTime.getTime() + (CONFIG.MODE_SWITCH_DELAY_MINS * 60 * 1000);
        
        if (now.getTime() > switchTimeMs) {
            newMode = 'evening';
        }
    }
    
    // Auto-switch logic: if the auto-determined newMode is different from the current
    if (newMode !== currentCommuteMode && !window.manualOverride) {
        currentCommuteMode = newMode;
        console.log(`Commute mode auto-switched to: ${currentCommuteMode}`);
        refreshTrafficAndSchedule(); 
    }
    
    const isMorning = currentCommuteMode === 'morning';
    
    // Cleaned up mode display
    const modeText = isMorning ? ' (Morning)' : ' (Evening)';
    safeSet(DOM_REFS.commuteTitle, 'Commute Dashboard' + modeText); 
    
    // Change button text to indicate the mode it will *switch to*
    DOM_REFS.modeSwitchBtn.textContent = isMorning ? 'üîÑ Switch to Evening' : 'üîÑ Switch to Morning';
    
    // Set button color based on current mode for better visual context
    DOM_REFS.modeSwitchBtn.style.backgroundColor = getCssVariable(isMorning ? '--warn' : '--accent');
    DOM_REFS.modeSwitchBtn.style.color = getCssVariable(isMorning ? '--text' : 'white');
    
    safeSet(DOM_REFS.transitModeTitle, isMorning ? 'Southbound' : 'Northbound');

    DOM_REFS.morningCommuteGroup.style.display = isMorning ? 'block' : 'none';
    DOM_REFS.eveningCommuteGroup.style.display = isMorning ? 'none' : 'block';
    
    DOM_REFS.sbDirectionContainer.style.display = isMorning ? 'block' : 'none';
    DOM_REFS.nbDirectionContainer.style.display = isMorning ? 'none' : 'block';
}

/**
 * Allows the user to manually switch the mode, including the "Activated" feedback.
 */
function manualModeSwitch() {
    // Set override to prevent the interval from immediately reversing the manual change
    window.manualOverride = true;
    
    // Toggle the mode
    currentCommuteMode = (currentCommuteMode === 'morning') ? 'evening' : 'morning';
    
    // Update the UI and data based on the new mode
    updateCommuteMode(); 
    refreshTrafficAndSchedule(); 
    
    // Apply temporary feedback text
    const newModeName = currentCommuteMode.charAt(0).toUpperCase() + currentCommuteMode.slice(1);
    
    // Set the activated message
    DOM_REFS.modeSwitchBtn.textContent = `${newModeName} Mode Activated!`;
    
    // Revert the text and clear override after 2 seconds
    setTimeout(() => {
        window.manualOverride = false;
        // Re-run updateCommuteMode to reset the button text to 'Switch to X' and clear colors
        updateCommuteMode(); 
    }, 2000); 
}

/* -------------------------
¬† ¬†Weather (OpenWeather 2.5)
¬† ¬†------------------------- */
async function loadWeather(){
¬† try{
¬† ¬† const url = `https://api.openweathermap.org/data/2.5/weather?id=${CONFIG.OPENWEATHER_CITY_ID}&units=imperial&appid=${CONFIG.OPENWEATHER_API_KEY}`;
¬† ¬† const res = await fetch(url);
¬† ¬† if(!res.ok) throw new Error('weather fetch failed: HTTP ' + res.status);
¬† ¬† const d = await res.json();
¬† ¬† 
¬† ¬† const current = d;
¬† ¬† safeSet(DOM_REFS.weatherTempEl, Math.round(current.main.temp) + '¬∞F');
¬† ¬† const desc = current.weather?.[0]?.description ?? '';
¬† ¬† safeSet(DOM_REFS.weatherDescEl, desc ? (desc[0].toUpperCase()+desc.slice(1)) : '‚Äî');
¬† ¬† safeSet(DOM_REFS.weatherFeelsEl, 'Feels: ' + Math.round(current.main.feels_like) + '¬∞F');
¬† ¬† safeSet(DOM_REFS.weatherWindEl, 'Wind: ' + Math.round(current.wind.speed) + ' mph');
¬† ¬† safeSet(DOM_REFS.weatherHumidityEl, 'Humidity: ' + current.main.humidity + '%');
¬† ¬† 
¬† ¬† if(current.weather?.[0]?.icon){
¬† ¬† ¬† DOM_REFS.weatherIconEl.innerHTML = '';
¬† ¬† ¬† const img = document.createElement('img');
¬† ¬† ¬† img.src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@2x.png`;
¬† ¬† ¬† img.alt = desc;
¬† ¬† ¬† DOM_REFS.weatherIconEl.appendChild(img);
¬† ¬† }

¬† }catch(err){ 
¬† ¬† console.error('Weather error:', err); 
¬† ¬† safeSet(DOM_REFS.weatherTempEl,'Error'); 
¬† }
}

/* -------------------------
¬† ¬†Schedule Logic (Work)
¬† ¬†------------------------- */

function getScheduleForToday() {
    const now = new Date();
    const day = now.getDay();
    const schedule = CONFIG.WORK_SCHEDULE[day];
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    if (!schedule) {
        safeSet(DOM_REFS.scheduleTimeWindow, `${dayNames[day]} (No Work)`);
        safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
        safeSet(DOM_REFS.targetArrivalDisplay, '--:--');
        safeSet(DOM_REFS.departureNote, 'No required departure time (non-work day).');
        DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
        return null;
    }
    
    const [h, m] = schedule.start.split(':').map(Number); 
    const workStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);

    const requiredTargetArrival = new Date(workStartTime.getTime() - (CONFIG.ARRIVAL_BUFFER_MINS * 60 * 1000));
    
    safeSet(DOM_REFS.scheduleTimeWindow, `${schedule.start} - ${schedule.end}`);
    safeSet(DOM_REFS.targetArrivalDisplay, formatTimeShort(requiredTargetArrival)); 
    
    if (now.getTime() > workStartTime.getTime() + (CONFIG.MODE_SWITCH_DELAY_MINS * 60 * 1000)) { 
        safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
        safeSet(DOM_REFS.departureNote, 'No required departure time (work in progress).');
        DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
        return null;
    }
    
    return requiredTargetArrival;
}


/* ----------------------------------------------------
   DRIVE TIME LOGIC (DistanceMatrixService)
   ---------------------------------------------------- */
           
/**
 * Calculates the next specified departure time.
 */
function getNextDepartureTime(hour, minute) {
    const now = new Date();
    let departure = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);

    // If the departure time is in the past, calculate for tomorrow
    if (departure.getTime() < now.getTime()) {
        departure.setDate(departure.getDate() + 1);
    }
    return departure;
}

/**
 * Helper function to convert seconds into a human-readable time string.
 */
function formatSecondsToTime(totalSeconds) {
    if (isNaN(totalSeconds) || totalSeconds < 0) return 'N/A';
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    
    let timeString = '';
    if (hours > 0) {
        timeString += `${hours} hr `;
    }
    timeString += `${minutes} min`;
    return timeString.trim();
}

/**
 * Main function to initiate all commute calculations.
 */
function initCommute() {
    if (typeof google === 'undefined' || !google.maps.DistanceMatrixService) {
        console.error("Google Maps API did not load correctly.");
        safeSet(DOM_REFS.morningTotalTime, "API Error");
        safeSet(DOM_REFS.eveningTotalTime, "API Error");
        return;
    }

    if (!mapService) {
        mapService = new google.maps.DistanceMatrixService();
    }
    
    // Set Dynamic Evening Time based on Day of Week
    const today = new Date().getDay(); 
    let eveningTimeDisplay = '';

    if (today >= 1 && today <= 4) { // Monday (1) to Thursday (4)
        EVENING_HOUR = 17; 
        EVENING_MINUTE = 30; 
        eveningTimeDisplay = '5:30 PM';
    } else if (today === 5) { // Friday (5)
        EVENING_HOUR = 16; 
        EVENING_MINUTE = 30; 
        eveningTimeDisplay = '4:30 PM';
    } else { // Weekend (Sat/Sun) 
        EVENING_HOUR = 17; 
        EVENING_MINUTE = 30; 
        eveningTimeDisplay = '5:30 PM';
    }
    safeSet(DOM_REFS.eveningDepartureDisplay, `(${eveningTimeDisplay} Departure)`);
    safeSet(DOM_REFS.morningDepartureDisplay, `(${MORNING_HOUR}:${MORNING_MINUTE} AM Departure)`);

    // Reset status text before recalculating
    const commonReset = 'Calculating...';
    safeSet(DOM_REFS.morningDriveTime, commonReset);
    safeSet(DOM_REFS.morningWalkTime, commonReset);
    safeSet(DOM_REFS.morningTotalTime, '...');
    safeSet(DOM_REFS.eveningWalkTime, commonReset);
    safeSet(DOM_REFS.eveningDriveTime, commonReset);
    safeSet(DOM_REFS.eveningTotalTime, '...');

    const targetArrival = getScheduleForToday(); 

    if (currentCommuteMode === 'morning') {
        const morningDepartureTime = getNextDepartureTime(MORNING_HOUR, MORNING_MINUTE);
        calculateMorningCommute(morningDepartureTime, targetArrival);
    } else {
        const eveningDepartureTime = getNextDepartureTime(EVENING_HOUR, EVENING_MINUTE);
        calculateEveningCommute(eveningDepartureTime);
    }
}

/**
 * Calculates the drive time (A -> B) and initiates the walk calculation.
 */
function calculateMorningCommute(departureTime, targetArrival) {
    const avoidHighways = DOM_REFS.avoidCheckbox.checked;
    
    mapService.getDistanceMatrix(
        {
            origins: [CONFIG.HOME_ADDR],
            destinations: [CONFIG.PARKING_ADDR],
            travelMode: google.maps.TravelMode.DRIVING,
            drivingOptions: {
                departureTime: departureTime,
                trafficModel: 'bestguess'
            },
            avoidHighways: avoidHighways,
        }, 
        (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                safeSet(DOM_REFS.morningDriveTime, element.duration.text);
                calculateMorningWalk(element.duration.value, targetArrival);
            } else {
                safeSet(DOM_REFS.morningDriveTime, 'Error');
                DOM_REFS.morningDriveTime.classList.add('error-message');
                calculateMorningWalk(0, targetArrival); 
            }
        }
    );
}

/**
 * Calculates the walking time (Parking B -> Work C) and sums the total.
 */
function calculateMorningWalk(driveDurationSeconds, targetArrival) {
    mapService.getDistanceMatrix(
        {
            origins: [CONFIG.PARKING_ADDR],
            destinations: [CONFIG.WORK_ADDR],
            travelMode: google.maps.TravelMode.WALKING,
        }, 
        (response, status) => {
            let walkDurationSeconds = 0;
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                safeSet(DOM_REFS.morningWalkTime, element.duration.text);
                walkDurationSeconds = element.duration.value;
            } else {
                safeSet(DOM_REFS.morningWalkTime, 'Error');
                DOM_REFS.morningWalkTime.classList.add('error-message');
            }
            
            const totalDurationSeconds = driveDurationSeconds + walkDurationSeconds;
            safeSet(DOM_REFS.morningTotalTime, formatSecondsToTime(totalDurationSeconds));

            // --- Update Required Departure Time in Schedule Card ---
            if (targetArrival) {
                const totalMins = totalDurationSeconds / 60;
                const requiredDepartureMs = targetArrival.getTime() - (totalMins * 60 * 1000); 
                const requiredDeparture = new Date(requiredDepartureMs);
                const now = new Date();
                const diffMins = Math.ceil((requiredDeparture.getTime() - now.getTime()) / 60000);

                safeSet(DOM_REFS.requiredDepartureTime, formatTimeShort(requiredDeparture));

                if (diffMins > 30) {
                    safeSet(DOM_REFS.departureNote, `You have ${diffMins} minutes until you must leave.`);
                    DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--accent');
                } else if (diffMins > 0) {
                    safeSet(DOM_REFS.departureNote, `You **MUST** leave in ${diffMins} minutes to arrive on time!`, true);
                    DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--warn');
                } else {
                    safeSet(DOM_REFS.requiredDepartureTime, `üî¥ Leave **IMMEDIATELY** or you will be late.`, true);
                    DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--danger');
                }
            } else {
                safeSet(DOM_REFS.requiredDepartureTime, 'N/A');
                safeSet(DOM_REFS.departureNote, 'No required departure time (non-work or past arrival target).');
                DOM_REFS.requiredDepartureTime.style.color = getCssVariable('--muted');
            }
        }
    );
}

/**
 * Calculates the walk time (C -> B) and initiates the drive calculation.
 */
function calculateEveningCommute(departureTime) {
     mapService.getDistanceMatrix(
        {
            origins: [CONFIG.WORK_ADDR],
            destinations: [CONFIG.PARKING_ADDR],
            travelMode: google.maps.TravelMode.WALKING,
        }, 
        (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                safeSet(DOM_REFS.eveningWalkTime, element.duration.text);
                calculateEveningDrive(element.duration.value, departureTime);
            } else {
                safeSet(DOM_REFS.eveningWalkTime, 'Error');
                DOM_REFS.eveningWalkTime.classList.add('error-message');
                calculateEveningDrive(0, departureTime); 
            }
        }
    );
}

/**
 * Calculates the drive time (Parking B -> Home A) and sums the total.
 */
function calculateEveningDrive(walkDurationSeconds, departureTime) {
    const avoidHighways = DOM_REFS.avoidCheckbox.checked;

    mapService.getDistanceMatrix(
        {
            origins: [CONFIG.PARKING_ADDR],
            destinations: [CONFIG.HOME_ADDR],
            travelMode: google.maps.TravelMode.DRIVING,
            drivingOptions: {
                departureTime: departureTime,
                trafficModel: 'bestguess'
            },
            avoidHighways: avoidHighways,
        }, 
        (response, status) => {
            let driveDurationSeconds = 0;
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                safeSet(DOM_REFS.eveningDriveTime, element.duration.text);
                driveDurationSeconds = element.duration.value;
            } else {
                safeSet(DOM_REFS.eveningDriveTime, 'Error');
                DOM_REFS.eveningDriveTime.classList.add('error-message');
            }
            
            const totalDurationSeconds = walkDurationSeconds + driveDurationSeconds;
            safeSet(DOM_REFS.eveningTotalTime, formatSecondsToTime(totalDurationSeconds));
        }
    );
}


/* -------------------------------------------
¬† ¬†Transit: RTD Scheduled Countdown 
¬† ¬†------------------------------------------- */

function getRTDScheduleForToday() {
    const now = new Date();
    const day = now.getDay(); 
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    let key = (day >= 1 && day <= 4) ? 'MT' : (day === 5) ? 'F' : (day === 6) ? 'SAT' : 'SUN';
    
    safeSet(DOM_REFS.currentDayScheduleSummary, `${dayNames[day]} Schedule is Active. Trains run every 30 minutes.`);
    
    return CONFIG.RTD_SCHEDULES[key];
}

/**
 * Uses 15 minutes as the threshold for the 'ARRIVING' state.
 * All trains 15 minutes or less away will use the 'schedule-arriving' style
 * until the Departure window begins.
 */
function formatCountdown(targetTime) {
    const diffMs = targetTime.getTime() - new Date().getTime();
    const diffSeconds = Math.floor(diffMs / 1000);
    
    // Constants for state transitions
    const DEPARTED_GRACE_SECONDS = -7; 
    const DEPARTURE_START_SECONDS = 15; 
    const ARRIVAL_WINDOW_SECONDS = 900; // 900 seconds (15 mins) - THIS IS NOW OUR PRIMARY THRESHOLD

    const getCountdownText = (secs) => {
        const minutes = Math.floor(secs / 60);
        const seconds = secs % 60;
        // If less than 1 minute, show seconds unless we are in the Departure/Departed grace period
        if (minutes < 1 && secs > DEPARTURE_START_SECONDS) {
            return `${secs}s`; 
        }
        return `${minutes}m ${seconds}s`;
    }
    
    // 1. DEPARTURE/DEPARTED (15 seconds to -7 seconds)
    if (diffMs <= DEPARTED_GRACE_SECONDS * 1000) { 
        return { text: "Departed", class: 'schedule-countdown' }; 
    }
    if (diffSeconds <= DEPARTURE_START_SECONDS) { 
        return { text: "Departure", class: 'schedule-departing' };
    }

    // 2. ARRIVING WINDOW (15 minutes down to 15 seconds)
    if (diffSeconds > DEPARTURE_START_SECONDS && diffSeconds <= ARRIVAL_WINDOW_SECONDS) {
        // This will apply the schedule-arriving style to all trains < 15 minutes
        return { text: `in ${getCountdownText(diffSeconds)}`, class: 'schedule-arriving' };
    }

    // 3. STANDARD COUNTDOWN (More than 15 minutes away)
    return { text: `in ${getCountdownText(diffSeconds)}`, class: 'schedule-countdown' };
}

function getServiceDates(schedule, direction) {
    const now = new Date();
    const start = schedule[direction === 'nb' ? 'start_nb' : 'start_sb'];
    const end = schedule[direction === 'nb' ? 'end_nb' : 'end_sb'];

    return {
        startOfDay: new Date(now.getFullYear(), now.getMonth(), now.getDate(), start.h, start.m, 0),
        endOfDay: new Date(now.getFullYear(), now.getMonth(), now.getDate(), end.h, end.m, 0)
    };
}

/**
 * FIXED: Searches 3 hours ahead to ensure 3 predictions are always found after the first one departs.
 */
function getNextThreeDepartures(scheduledMinutes, schedule, direction) {
    const now = new Date();
    let departures = [];
    const { startOfDay, endOfDay } = getServiceDates(schedule, direction);

    if (now.getTime() < startOfDay.getTime() || now.getTime() > endOfDay.getTime() + 60000) {
         return { departures: [], nextStart: startOfDay };
    }

    // REVISED: Search up to 3 hours ahead (i=0, i=1, i=2)
    for (let i = 0; i < 3; i++) { 
        const hourToCheck = now.getHours() + i;
        
        scheduledMinutes.forEach(targetMinute => {
            let departure = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hourToCheck, targetMinute, 0);
            
            // The filter: Keep trains that are not yet 7 seconds in the past.
            if (departure.getTime() >= now.getTime() - 7000 && departure.getTime() <= endOfDay.getTime()) { 
                departures.push(departure);
            }
        });
    }
    
    return {
        // Sort and limit to the MAX_PREDICTIONS (3)
        departures: departures.sort((a, b) => a.getTime() - b.getTime()).slice(0, CONFIG.MAX_PREDICTIONS),
        nextStart: startOfDay
    };
}

function updateTransit() {
    const schedule = getRTDScheduleForToday();
    
    if (!schedule) {
        safeSet(DOM_REFS.sbPredictionsContainer, `<div class="schedule-no-service">No RTD Schedule Found for Today.</div>`, true);
        safeSet(DOM_REFS.nbPredictionsContainer, `<div class="schedule-no-service">No RTD Schedule Found for Today.</div>`, true);
        return;
    }

    // Update Service Window Displays
    const formatWindow = (start, end) => `Service Window: ${formatTime(start)} - ${formatTime(end)}`;
    const { startOfDay: nbStart, endOfDay: nbEnd } = getServiceDates(schedule, 'nb');
    safeSet(DOM_REFS.nbWindowEl, formatWindow(nbStart, nbEnd));
    const { startOfDay: sbStart, endOfDay: sbEnd } = getServiceDates(schedule, 'sb');
    safeSet(DOM_REFS.sbWindowEl, formatWindow(sbStart, sbEnd));

    const activeDirection = currentCommuteMode === 'morning' ? 'sb' : 'nb';
    const inactiveDirection = currentCommuteMode === 'morning' ? 'nb' : 'sb';
    
    const activeContainer = activeDirection === 'sb' ? DOM_REFS.sbPredictionsContainer : DOM_REFS.nbPredictionsContainer;
    const activeMinutes = activeDirection === 'sb' ? schedule.sbMinutes : schedule.nbMinutes;

    const inactiveContainer = inactiveDirection === 'sb' ? DOM_REFS.sbPredictionsContainer : DOM_REFS.nbPredictionsContainer;
    safeSet(inactiveContainer, `<div class="schedule-no-service">Not the current commute direction.</div>`, true);

    const { departures, nextStart } = getNextThreeDepartures(activeMinutes, schedule, activeDirection);

    if (departures.length === 0) {
        const message = (nextStart.getTime() > new Date().getTime()) ? `Service begins at ${formatTime(nextStart)}.` : `Service has ended for today.`;
        safeSet(activeContainer, `<div class="schedule-no-service">${message}</div>`, true);
        return;
    }

    let html = '';
    departures.forEach((departureTime, index) => {
        const { text: countdownText, class: countdownElementClass } = formatCountdown(departureTime);
        
        html += `
            <div class="prediction-item ${index === 0 ? 'next-up' : ''}">
                <span class="schedule-time">${formatTimeShort(departureTime)}</span>
                <span class="${countdownElementClass}">${countdownText}</span>
            </div>
        `;
    });
    safeSet(activeContainer, html, true);
}

/**
 * Safely parses HH:MM(AM/PM) string into a Date object for today.
 */
function parseTimeIntoDate(timeStr) {
    const now = new Date();
    // Regex to capture hours, minutes, and AM/PM
    const match = timeStr.match(/(\d{1,2}):(\d{2})(AM|PM)/i); 
    if (!match) return new Date(NaN);

    let [_, hoursStr, minutesStr, ampm] = match;
    let hours = parseInt(hoursStr, 10);
    const minutes = parseInt(minutesStr, 10);

    // Convert 12-hour time to 24-hour time
    if (ampm.toUpperCase() === 'PM' && hours !== 12) {
        hours += 12;
    } else if (ampm.toUpperCase() === 'AM' && hours === 12) {
        hours = 0; // Midnight (12:xx AM)
    }

    // Use the safe constructor: year, month, day, hour, minute, second
    const targetDate = new Date(
        now.getFullYear(), 
        now.getMonth(), 
        now.getDate(), 
        hours, 
        minutes, 
        0
    );
    
    return targetDate;
}

/**
 * Updates the displayed countdowns for transit every second by targeting their rendered content.
 */
function updateTransitDisplay() {
    const containerId = currentCommuteMode === 'morning' ? 'sb-predictions' : 'nb-predictions';
    const container = document.getElementById(containerId);

    if (!container || !container.children.length) return;

    Array.from(container.children).forEach((item) => {
        if (item.classList.contains('schedule-no-service')) return;
        
        const timeSpan = item.querySelector('.schedule-time');
        // Target any of the countdown classes
        const countdownEl = item.querySelector('.schedule-countdown, .schedule-departing, .schedule-critical, .schedule-arriving');
        
        if (!countdownEl || !timeSpan) return;

        const timeStr = timeSpan.textContent; 

        // 1. SAFELY PARSE THE TIME STRING
        let targetTime = parseTimeIntoDate(timeStr);
        
        // Check for parsing error
        if (isNaN(targetTime.getTime())) {
            safeSet(countdownEl, 'Time Error');
            countdownEl.className = 'error-message';
            return;
        }

        // 2. CHECK IF THE TIME HAS PASSED (it might need to be tomorrow)
        const now = new Date();
        if (targetTime.getTime() < now.getTime() - 7000) { 
             targetTime.setDate(targetTime.getDate() + 1);
        }

        // 3. APPLY COUNTDOWN LOGIC
        const { text: countdownText, class: countdownElementClass } = formatCountdown(targetTime);
        
        safeSet(countdownEl, countdownText);
        // Ensure the class list is correctly updated every second
        countdownEl.className = countdownElementClass; 
    });
}


function renderAlerts() {
    if (CONFIG.ALERTS.length === 0) {
        DOM_REFS.alertsCard.style.display = 'none'; 
        return;
    }

    DOM_REFS.alertsCard.style.display = 'block';

    let alertsHtml = '';
    
    CONFIG.ALERTS.forEach(alert => {
        const icon = (alert.type === 'DELAY') ? '‚è≥' : (alert.type === 'ADVISORY') ? 'üì¢' : '‚ÑπÔ∏è';
        alertsHtml += `<div class="alert-item"><span class="alert-icon">${icon}</span><span><strong>${alert.type}:</strong> ${alert.message}</span></div>`;
    });
    
    safeSet(DOM_REFS.alertsContent, alertsHtml, true);
}

/* -------------------------
¬† ¬†Collapsible Logic
¬† ¬†------------------------- */

function toggleCollapse(cardId) {
    const card = document.getElementById(cardId);
    
    if (!card) return;

    const isCollapsed = card.getAttribute('data-collapsed') === 'true';
    const newCollapsedState = !isCollapsed;

    card.setAttribute('data-collapsed', newCollapsedState);
}


/* -------------------------
¬† ¬†Full refresh Handlers
¬† ¬†------------------------- */

function updateEverySecond() {
    setDayTime();
    updateTransitDisplay(); 
}

function refreshTrafficAndSchedule() {
¬† ¬† getScheduleForToday(); 
    initCommute(); 
    updateTransit(); 

    const avoidParam = DOM_REFS.avoidCheckbox.checked ? '&avoid=highways' : '';
    
    let driveOrigin, driveDestination, mapButtonText;

    if (currentCommuteMode === 'morning') {
        driveOrigin = CONFIG.HOME_ADDR;
        driveDestination = CONFIG.WORK_ADDR;
        mapButtonText = 'View Live Traffic (Home ‚Üí Work)';
    } else {
        driveOrigin = CONFIG.WORK_ADDR;
        driveDestination = CONFIG.HOME_ADDR;
        mapButtonText = 'View Live Traffic (Work ‚Üí Home)';
    }
    
    // *** FIX: Changed URL to standard public Google Maps format ***
    const driveMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(driveOrigin)}&destination=${encodeURIComponent(driveDestination)}&travelmode=driving&dir_action=navigate${avoidParam}`;
    
    const transitOrigin = currentCommuteMode === 'morning' ? CONFIG.N_ORIGIN : CONFIG.WORK_ADDR;
    const transitDestination = currentCommuteMode === 'morning' ? CONFIG.WORK_ADDR : CONFIG.N_ORIGIN;
    
    // *** FIX: Changed URL to standard public Google Maps format ***
    const transitMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(transitOrigin)}&destination=${encodeURIComponent(transitDestination)}&travelmode=transit&dir_action=navigate`;

    
    DOM_REFS.openWorkMapBtn.onclick = () => window.open(driveMapUrl, '_blank'); 
    DOM_REFS.driveToWorkBtn.onclick = () => window.open(driveMapUrl, '_blank'); 
    DOM_REFS.transitMapBtn.onclick = () => window.open(transitMapUrl, '_blank'); 
    
    safeSet(DOM_REFS.driveToWorkBtn, mapButtonText);
    safeSet(DOM_REFS.openWorkMapBtn, currentCommuteMode === 'morning' ? 'Open Map (Home ‚Üí Work)' : 'Open Map (Work ‚Üí Home)');
    safeSet(DOM_REFS.transitMapBtn, currentCommuteMode === 'morning' ? 'Open Transit Map (SB)' : 'Open Transit Map (NB)');
}

function initialAndStaticLoad() {
    updateCommuteMode(); 
    setDayTime();
¬† ¬† loadWeather();
¬† ¬† renderAlerts();
    updateRgbVariables(); 
}


/* -------------------------
¬† ¬†Events & Intervals
¬† ¬†------------------------- */

function updateRgbVariables() {
    const isDark = document.body.classList.contains('dark');
    const accent = isDark ? '#60a5fa' : '#3b82f6'; 
    const text = isDark ? '#e5e7eb' : '#1a1a1a';
    const warn = isDark ? '#fbbf24' : '#f59e0b';

    function hexToRgb(hex) {
        const bigint = parseInt(hex.replace('#', ''), 16);
        return `${(bigint >> 16) & 255}, ${(bigint >> 8) & 255}, ${bigint & 255}`;
    }

    document.documentElement.style.setProperty('--accent-rgb', hexToRgb(accent));
    document.documentElement.style.setProperty('--text-rgb', hexToRgb(text));
    document.documentElement.style.setProperty('--warn-rgb', hexToRgb(warn));
}

function setupEventsAndIntervals() {
    DOM_REFS.refreshBtn.addEventListener('click', () => {
        initialAndStaticLoad();
        refreshTrafficAndSchedule();
    });

    DOM_REFS.themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        updateRgbVariables();
    });
    
    DOM_REFS.modeSwitchBtn.addEventListener('click', manualModeSwitch);

    setInterval(updateEverySecond, 1000); 
    // Only allow the auto-switch logic to run if the user hasn't manually overridden it recently
    setInterval(() => { if (!window.manualOverride) updateCommuteMode(); }, 60 * 1000); 
    setInterval(refreshTrafficAndSchedule, 3 * 60 * 1000); 
    setInterval(updateTransit, 3 * 60 * 1000); 
    setInterval(loadWeather, 10 * 60 * 1000);
}

/* -------------------------
¬† ¬†Google Maps Initialization
¬† ¬†------------------------- */
function initMaps(){
¬† mapService = new google.maps.DistanceMatrixService(); 
¬† 
    refreshTrafficAndSchedule();
}

(function loadMaps(){
¬† ¬† const s = document.createElement('script');
¬† ¬† s.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMaps`;
¬† ¬† s.async = true;
¬† ¬† s.defer = true;
¬† ¬† s.setAttribute('loading', 'async');
¬† ¬† window.initMaps = initMaps;
¬† ¬† document.head.appendChild(s);
})();

/* Initial load and setup */
initialAndStaticLoad();
setupEventsAndIntervals();
    </script>
</body>
</html>
