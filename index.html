<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Commute Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin: 20px auto;
        max-width: 500px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        transition: 0.3s;
    }

    .status-normal {
        border-left: 8px solid #4CAF50;
    }
    .status-warning {
        border-left: 8px solid #FFC107;
    }
    .status-critical {
        border-left: 8px solid #F44336;
    }

    .time {
        font-size: 2em;
        font-weight: bold;
    }

    .details {
        margin-top: 5px;
        font-size: 1em;
        opacity: 0.9;
    }

    a {
        display: block;
        margin-top: 10px;
        text-decoration: none;
        color: #007bff;
    }
</style>
</head>
<body>

<h1>Commute Dashboard</h1>

<!-- HOME → WORK: DRIVING -->
<div id="h2w-card" class="card">
    <div id="h2w-drive-time" class="time">--</div>
    <div id="h2w-drive-details" class="details">Loading...</div>
    <a id="h2w-drive-link" href="#" target="_blank">Open in Google Maps</a>
</div>

<!-- HOME → WORK: TRANSIT -->
<div id="h2w-transit-card" class="card">
    <div id="h2w-transit-time" class="time">--</div>
    <div id="h2w-transit-details" class="details">Loading...</div>
    <a id="h2w-transit-link" href="#" target="_blank">Open in Google Maps</a>
</div>

<!-- WORK → HOME: DRIVING -->
<div id="w2h-card" class="card">
    <div id="w2h-drive-time" class="time">--</div>
    <div id="w2h-drive-details" class="details">Loading...</div>
    <a id="w2h-drive-link" href="#" target="_blank">Open in Google Maps</a>
</div>

<!-- WORK → HOME: TRANSIT -->
<div id="w2h-transit-card" class="card">
    <div id="w2h-transit-time" class="time">--</div>
    <div id="w2h-transit-details" class="details">Loading...</div>
    <a id="w2h-transit-link" href="#" target="_blank">Open in Google Maps</a>
</div>


<script>
/* ============================
   CONFIG
============================ */

const HOME_ADDRESS = "112th Avenue & York Street Station";
const WORK_ADDRESS = "Denver Union Station";

const GOOGLE_MAPS_API_KEY = "YOUR_KEY_HERE"; 
// NOTE: Key is only exposed because you requested single-file compilation.
// Remove the above key after we migrate you to Netlify Functions.


/* ============================
   STATUS CLASS LOGIC
============================ */

function applyStatusClass(card, minutes) {
    card.classList.remove("status-normal", "status-warning", "status-critical");

    if (minutes <= 25) {
        card.classList.add("status-normal");
    } else if (minutes <= 45) {
        card.classList.add("status-warning");
    } else {
        card.classList.add("status-critical");
    }
}


/* ============================
   COMMUTE FETCHER (DRIVING + TRANSIT)
============================ */

async function fetchCommute(mode, origin, destination, timeId, detailsId, linkId, cardId) {
    try {
        const url = `/api-google/directions/json?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&mode=${mode}&key=${GOOGLE_MAPS_API_KEY}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not OK");

        const data = await response.json();

        if (!data.routes || !data.routes.length) throw new Error("No routes found");

        const leg = data.routes[0].legs[0];

        const timeElement = document.getElementById(timeId);
        const detailsElement = document.getElementById(detailsId);
        const card = document.getElementById(cardId);
        const linkElement = document.getElementById(linkId);

        linkElement.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&mode=${mode}`;

        let durationText = leg.duration.text;
        let minutes = leg.duration.value / 60;

        timeElement.textContent = durationText;

        /* ================================
           DRIVING MODE
        ================================= */
        if (mode === "driving") {
            let traffic = leg.duration_in_traffic
                ? `Traffic: ${leg.duration_in_traffic.text}`
                : "Traffic updates unavailable";

            detailsElement.textContent = `Via: ${leg.summary || "Route"} • ${traffic}`;
        }

        /* ================================
           TRANSIT MODE (Safe fallback)
        ================================= */
        if (mode === "transit") {

            const transitStep = leg.steps.find(s => s.travel_mode === "TRANSIT");

            if (transitStep && transitStep.transit_details) {
                const line = transitStep.transit_details.line;

                detailsElement.textContent =
                    `Take ${line.short_name || line.name} — ${transitStep.transit_details.num_stops} stops`;
            } else {
                // Fallback for missing transit details
                detailsElement.textContent = leg.steps
                    .map(s => s.html_instructions.replace(/<[^>]+>/g, ""))
                    .join(" → ");
            }
        }

        applyStatusClass(card, minutes);

    } catch (error) {
        console.error(error);

        document.getElementById(timeId).textContent = "--";
        document.getElementById(detailsId).textContent = "Data unavailable";
    }
}


/* ============================
   INIT LOOPS
============================ */

function refreshAll() {
    fetchCommute("driving", HOME_ADDRESS, WORK_ADDRESS, "h2w-drive-time", "h2w-drive-details", "h2w-drive-link", "h2w-card");
    fetchCommute("transit", HOME_ADDRESS, WORK_ADDRESS, "h2w-transit-time", "h2w-transit-details", "h2w-transit-link", "h2w-transit-card");

    fetchCommute("driving", WORK_ADDRESS, HOME_ADDRESS, "w2h-drive-time", "w2h-drive-details", "w2h-drive-link", "w2h-card");
    fetchCommute("transit", WORK_ADDRESS, HOME_ADDRESS, "w2h-transit-time", "w2h-transit-details", "w2h-transit-link", "w2h-transit-card");
}

refreshAll();
setInterval(refreshAll, 5 * 60 * 1000); // refresh every 5 minutes

</script>

</body>
</html>